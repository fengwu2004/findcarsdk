function ArrayList(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head}function ArrayListNode(t){this.next=null,this.prev=null,this.value=t}function ArrayListIter(t,e){this.head=t,this.tail=e,this.cursor=t}function IndexMinPQ(t){this.size=t,this.count=0,this.pq=new Array(t+1),this.qp=new Array(t+1),this.keys=new Array(t+1);for(var e=0;e<=this.size;e++)this.qp[e]=-1,this.keys[e]=Number.MAX_VALUE}function Region(t,e,i,r){this.id=t,this.matRegion=YFM.Math.Matrix.mat(),this.glCanvas=e,this.gl=YFM.WebGL.setupWebGL(e),this.gl.viewport(0,0,e.width,e.height),this.gl.clearColor(.9,.9,.9,1),YFM.gGL=this.gl,this.hh=e.height/2,this.hw=e.width/2,this.txtCanvas=i,this.ctx2d=i.getContext("2d"),this.ctx2d.font="24px Microsoft YaHei",this.ctx2d.fillStyle="#FF0000",this.ctx2d.textAlign="center",this.ctx2d.textBaseline="middle",this.camera=new DeviceOrientationCamera,this.camera.setPerspective(60,e.width/e.height,60,2e4),this.camera.setLookOffset(0,0,-400),this.orthMat=YFM.Math.Matrix.orthographic(-e.width/2,e.width/2,-e.height/2,e.height/2,-1,1),this.renderParam={projMat:null,viewMat:null,vrMat:null,bivrMat:null,pvrMat:null},this.listener=r,this.floors=[],this.baseColorShader=new BaseColorProgram(this.gl),this.basePhongShader=new BasePhongProgram(this.gl),this.selectColorShader=new SelectColorProgram(this.gl),this.regionPhongShader=new RegionPhongProgram(this.gl),this.billboardIconShader=new BillboardIconProgram(this.gl),this.marker2DShader=new Marker2DProgram(this.gl),this.pointSpiritShader=new PointSpiritProgram(this.gl),this.panoramaShader=new RawPanoramaProgram(this.gl),this.modelPhongShader=new ModelPhongProgram(this.gl),this.maxSize=0,this.vPitch=0,this.displayFloorIndex=-1;var o=this;this.touchMgr=new RegionTouchMgr(this.camera,i,this.ctx2d,this,{onClick:function(t,e){o.listener&&o.listener.onClick&&o.listener.onClick(t,e)},onDClick:function(t,e){o.listener&&o.listener.onDClick&&o.listener.onDClick(t,e)},on2FClick:function(t,e){o.listener&&o.listener.on2FClick&&o.listener.on2FClick(t,e)},onLongPressUp:function(t,e){o.listener&&o.listener.onLongPressUp&&o.listener.onLongPressUp(t,e)}}),this.animMgr=new AnimationMgr(this,this.camera,this.touchMgr,{onAnimStart:function(t){o.listener&&o.listener.onAnimStart(t)},onAnimFinish:function(t){o.listener&&o.listener.onAnimFinish(t)},onAnimCancle:function(t){o.listener&&o.listener.onAnimCancel(t)}}),this.panorama=new RawPanorama(this.gl,this),this.locMarker=new RegionLocMarker(this.gl,20,2152900137,3992977408,this),this.route=new RegionRoute(this.gl,5,4278237951,4278237951,this),this.frustum=new FrustumWorldSpace,this.texturePool=new TexturePool(this.gl),this.extrudeLightNormal=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.extrudeLightOver=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLight=this.extrudeLightNormal,this.overlook=!1,this.status=YFM.Map.STATUS_TOUCH,this.listener&&this.listener.onStatusChange(this.status)}function RegionLocMarker(t,e,i,r,o){this.gl=t,this.size=e,this.faceColor=YFM.Math.Vector.vec(YFM.WebGL.Color.hexColorRed(i),YFM.WebGL.Color.hexColorGreen(i),YFM.WebGL.Color.hexColorBlue(i),YFM.WebGL.Color.hexColorAlpha(i)),this.lineColor=YFM.Math.Vector.vec(YFM.WebGL.Color.hexColorRed(r),YFM.WebGL.Color.hexColorGreen(r),YFM.WebGL.Color.hexColorBlue(r),YFM.WebGL.Color.hexColorAlpha(r)),this.region=o,this.angle=0,this.regionLoc=YFM.Math.Vector.pos(0,0,0),this.modelMat=YFM.Math.Matrix.mat(),this.floorLoc={floor:-1,x:0,y:0},this.anim={floor:0,dist:.1,flag:!1,mover:new Mover(0,0,0),target:null},this._init(t,e)}function RegionTouchMgr(t,e,i,r,o){function s(t){if(a.enable)switch(t.preventDefault(),a._updateEventLayerPos(t),t.type){case"touchstart":a.strategy.touchDown(t);break;case"touchmove":a.strategy.touchMove(t);break;case"touchend":a.strategy.touchUp(t);break;case"touchcancel":a.strategy.touchCancel(t)}}function n(t){if(a.enable)switch(t.preventDefault(),t.type){case"mousedown":a._updateEventLayerPos(t),a.strategy_desktop.mouseDown(t);break;case"mouseup":a._updateEventLayerPos(t),a.strategy_desktop.mouseUp(t);break;case"mouseleave":a._updateEventLayerPos(t),a.strategy_desktop.mouseLeave(t);case"mousemove":a._updateEventLayerPos(t),a.strategy_desktop.mouseMove(t);break;case"mousewheel":a._updateEventLayerPos(t),a.strategy_desktop.mouseWheel(t);break;case"keypress":a.strategy_desktop.keyPress(t)}}this.hangUp=!1,this.camera=t,this.canvas=e,this.ctx2d=i,this.region=r,this.listener=o,this.touchFloorIndex=-1,this.focusFloorDirty=!0,this.enable=!0,this.isMobile=this._isMobileBrowser(),this.uiScaleRate=1,this.touchRec={savedmat:YFM.Math.Matrix.matClone(r._getRegionMat()),pitchCnt:0,degree:0,screenSpacing:0,viewSpacing:0,radius0x:0,radius0y:0,layer0x:0,layer0y:0,layer1x:0,layer1y:0,dy0:0,dy1:0,start0x:0,start0y:0,start1x:0,start1y:0,pre0y:0,pre1y:0,midX:0,midY:0},this.planeRec={planeHeight:0,midpos:null,start0:null,start1:null,prev:null,translateX:0,translateY:0,firstAngle:0},this.viewZoom={max:3e3,min:150};var a=this;this.strategy_desktop={timeStampPrev:0,timeStampCur:0,clickFlag:!1,pitchLock:!1,rotateLock:!1,zoomLock:!1,zoomTarget:null,deltaPitch:0,deltaAngle:0,mousePressed:!1,mouseDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,this.mousePressed=!0,this.rotateLock=!1,this.pitchLock=!1,this.zoomLock=!1},mouseUp:function(t){var e=(new Date).getTime(),i=a.planeRec.translateX,r=a.planeRec.translateY;if(!(this.rotateLock||this.pitchLock||this.zoomLock)){if(this.clickFlag){var o=e-this.timeStampPrev;i*i+r*r<100&&o<200&&a._onDClick(a.touchRec.layer0x,a.touchRec.layer0y),this.clickFlag=!1}else{var s=e-this.timeStampCur;if(i*i+r*r<100)if(s<100){this.clickFlag=!0;var n=this;setTimeout(function(){n.clickFlag&&(n.clickFlag=!1,a._onClick(a.touchRec.layer0x,a.touchRec.layer0y))},200)}else s>800&&a._onLongPressUp(a.touchRec.layer0x,a.touchRec.layer0y)}this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0}},mouseLeave:function(t){this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0},mouseMove:function(t){if(this.mousePressed&&!this.pitchLock&&!this.rotateLock&&!this.zoomLock&&YFM.Map.STATUS_TOUCH===a.region.getStatus()){var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1];var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);a.region._setRegionMat(i),a.focusFloorDirty=!0}},mouseWheel:function(t){if(this.zoomLock||(this.zoomLock=!0),this.zoomLock){var e=-t.wheelDelta/2;a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y);var i=a._world_to_view(a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y)),r=YFM.Math.Vector.pos(0,0,0),o=YFM.Math.Vector.sub(r,i),s=YFM.Math.Vector.normalize(o),n=a.camera.getLookOffset();if(e>0)YFM.Math.Vector.norm3(n)>=a.viewZoom.max&&(e=0);else if(e<0&&0==a.touchFloorIndex){var h=YFM.Math.Vector.norm3(o);h<=a.viewZoom.min&&(e=0)}YFM.Math.Vector.scaleTo(s,e),YFM.Math.Vector.subTo(n,s),a.camera.setLookOffset(n[0],n[1],n[2]),a.focusFloorDirty=!0}},keyPress:function(t){if(this.mousePressed){var e=!1,i=!1;if("a"===t.key?(this.deltaAngle+=1,e=!0):"d"===t.key?(this.deltaAngle-=1,e=!0):"w"==t.key?(this.deltaPitch=-1,i=!0):"s"==t.key&&(this.deltaPitch=1,i=!0),!this.rotateLock&&e&&(this.rotateLock=!0,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),this.deltaAngle=0),this.rotateLock){var r=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,this.deltaAngle,a.planeRec.start0[0],a.planeRec.start0[1]);a.region._setRegionMat(r),a.focusFloorDirty=!0}if(!this.pitchLock&&i){var o=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.camera.resetLookOffsetTan(),a.region.lookAtWorldLoc(o[0],o[1],o[2]),this.pitchLock=!0}if(this.pitchLock){var s=a.camera.getPitch();s+=this.deltaPitch,s<=-45&&this.deltaPitch<0?s=-45:s>=0&&this.deltaPitch>0?(s=0,this.overlook||(a.region._onOverlook(!0),this.overlook=!0)):s<=0&&this.deltaPitch<0&&this.overlook&&(a.region._onOverlook(!1),this.overlook=!1),a.camera.setPitch(s),a.focusFloorDirty=!0}}}},this.strategy_none={name:"none",timeStampPrev:0,timeStampCur:0,clickFlag:!1,twoFingerClickFlag:!1,timeStampTwoFinger:0,mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),1==t.touches.length?(a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0):t.touches.length>1&&(this.startTime=t.timeStamp,a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.planeRec.start1=a._pos_in_world_space(a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi)},touchMove:function(t){var e,i;e=a.touchRec.layer0x-a.touchRec.start0x,i=a.touchRec.layer0y-a.touchRec.start0y,1==t.touches.length&&e*e+i*i>100&&(a.strategy=a.strategy_scroll)},touchUp:function(t){var e=(new Date).getTime();if(this.clickFlag)e-this.timeStampPrev<300&&a._onDClick(a.touchRec.start0x,a.touchRec.start0y),this.clickFlag=!1;else{var i=e-this.timeStampCur;if(i<100){this.clickFlag=!0;var r=this;setTimeout(function(){r.clickFlag&&(r.clickFlag=!1,r.twoFingerClickFlag?r.twoFingerClickFlag=!1:a._onClick(a.touchRec.start0x,a.touchRec.start0y))},300)}else i>800&&a._onLongPressUp(a.touchRec.start0x,a.touchRec.start0y)}0==t.touches.length&&(a.hangUp=!1)},touchCancel:function(t){a.hangUp=!1}},this.strategy_multi={name:"multi",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){a.touchRec.pitchCnt=0,a.strategy=a.strategy_rotate},touchUp:function(t){a.hangUp=!1,(new Date).getTime()-a.strategy_none.timeStampCur<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0),a.strategy=a.strategy_none},touchCancel:function(t){a.strategy=a.strategy_none,a.hangUp=!1}},this.strategy_scroll={name:"scroll",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){t.touches.length>1&&(a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi)},touchMove:function(t){if(YFM.Map.STATUS_TOUCH===a.region.getStatus()){var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1],a.planeRec.prev=e;var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);a.region._setRegionMat(i),a.focusFloorDirty=!0}},touchUp:function(t){(new Date).getTime();a.strategy_none.timeStampCur,a.hangUp=!1,a.strategy=a.strategy_none,t.touches.length},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy_rotate={name:"rotate",mouseDown:function(t){},touchDown:function(t){},touchMove:function(t){if(!(a.hangUp||t.touches.length<2)){if(YFM.Map.STATUS_TOUCH!==a.region.getStatus()){var e=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),i=a.touchRec.screenSpacing-e,r=-a.camera.getLookOffsetNormal();return r+=i/20,r>a.viewZoom.max?r=a.viewZoom.max:r<a.viewZoom.min&&(r=a.viewZoom.min),void a.camera.setLookOffset(0,0,-r)}if(a._pitch_detect_continue(t))return void(a.strategy=a.strategy_pitch);var e=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y);if(!(e<200)){var o=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),s=a._calc_angle(t),n=s-a.planeRec.firstAngle,h=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,n,a.planeRec.midpos[0],a.planeRec.midpos[1],!0);a.region._setRegionMat(h);var u=(a.touchRec.viewSpacing-o.spacing)/2;u<0&&o.z<0&&o.z>-20&&(u=-30);var l=a._world_to_view(a.planeRec.midpos),c=YFM.Math.Vector.pos(0,0,0),M=YFM.Math.Vector.sub(c,l),i=YFM.Math.Vector.normalize(M),f=a.camera.getLookOffset();if(u>0)YFM.Math.Vector.norm3(f)>=a.viewZoom.max&&(u=0);else if(u<0&&0==a.touchFloorIndex){var d=YFM.Math.Vector.norm3(M);d<=a.viewZoom.min&&(u=0)}YFM.Math.Vector.scaleTo(i,u),YFM.Math.Vector.subTo(f,i),a.camera.setLookOffset(f[0],f[1],f[2]),a.focusFloorDirty=!0}}},touchUp:function(t){if(t.touches.length>1)a.hangUp=!0;else if(t.touches.length>=0){a.hangUp=!1,a.strategy=a.strategy_none,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0;var e=(new Date).getTime(),i=e-a.strategy_none.timeStampCur;i<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0)}else a.strategy=a.strategy_none},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy_pitch={name:"pitch",overlook:!1,mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){var e=a.touchRec.layer0y-a.touchRec.start0y,i=e/256,r=a.camera.getPitch();r+=i,r<=-45&&i<0?r=-45:r>=0&&i>0?(r=0,this.overlook||(a.region._onOverlook(!0),this.overlook=!0)):r<=0&&i<0&&this.overlook&&(a.region._onOverlook(!1),this.overlook=!1),a.camera.resetLookOffsetTan(),a.region.lookAtWorldLoc(a.planeRec.midpos[0],a.planeRec.midpos[1],a.planeRec.midpos[2]),a.camera.setPitch(r),a.focusFloorDirty=!0},touchUp:function(t){t.touches.length>1?a.hangUp=!0:t.touches.length>0?(a.hangUp=!1,a.strategy=a.strategy_none,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0):a.strategy=a.strategy_none},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy=this.strategy_none,this.isMobile?(e.addEventListener("touchstart",s,!1),e.addEventListener("touchmove",s,!1),e.addEventListener("touchend",s,!1),e.addEventListener("touchcancel",s,!1)):(document.onkeypress=n,e.addEventListener("mousedown",n,!1),e.addEventListener("mouseup",n,!1),e.addEventListener("mousemove",n,!1),e.addEventListener("mouseleave",n,!1),e.addEventListener("mousewheel",n,!1))}function AnimationMgr(t,e,i,r){this.region=t,this.camera=e,this.touchMgr=i,this.listener=r,this.seq=new ArrayList,this.mover=new Mover,this.mover.setMaxForce(16),this.mover.setMaxSpeed(16),this.current=null}function Animation(t,e,i){this.tag=t,this.type=e,this.frame=i,this.step=0}function RegionRoute(t,e,i,r,o){this.gl=t,this.size=e,this.routeColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(i),YFM.WebGL.Color.hexColorGreen(i),YFM.WebGL.Color.hexColorBlue(i)),this.tailColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(r),YFM.WebGL.Color.hexColorGreen(r),YFM.WebGL.Color.hexColorBlue(r)),this.region=o,this.routeVBO=null,this.routeBufferSize=0,this.routeVarray=[],this.light=YFM.Math.Vector.vec(0,0,1),this.floorRouteList=null,this.obb=null,this._initTail(),this._initRouteShape(),this.tailSize=3.2,this.naviStatus={startInstance:0,projection:null,validate:!1,projDist:0,goalDist:0,serialDist:0,nextSerialDist:0,azimuth:0,sug:YFM.Map.Navigate.Suggestion.NONE,nextSug:YFM.Map.Navigate.NextSuggestion.NONE}}function RouteSeg(t,e){this.start=t,this.end=e,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth(),this.startInstance=0}function FloorRoute(t,e,i,r){this.size=t,this.floor=e,this.region=i,this.route=r,this.segList=[],this.lastSegVec=null,this.implicitRec={maxT:0,maxPos:null}}function Floor(t,e,i,r,o,s,n){this.loaded=!1,this.gl=t,this.id=e,this.deflection=null!=r?r:0,this.region=o,this.index=s,this.loadListener=n,this.mapWidth=0,this.mapHeight=0,this.regUnit=/^unit/g,this.regIcon=/^icon/g,this.extrude=new FloorExtrude(t,YFM.Map.DEFAULT_EXTRUDE_HEIGHT),this.quickPolygon=new FloorQuickPolygon(t,YFM.Map.DEFAULT_QUICKPOLYGON_HEIGHT),this.quadTree=null,this.icons=null,this.models=null,this.markers=new FloorMarkers(this.gl,this.region,this),this.quickIcons=new FloorQuickIcons(this.gl,this.region,this),this.dummyUnitList=[],this.BBCheck=-1;var a=this;if(null===this.loadListener)a._load_svg(a,i);else{var h=new XMLHttpRequest;h.open("GET",i,!0),h.responseType="text",h.onload=function(t){200==this.status?(console.log("-ajax request ok"),a._load_svg(a,this.response),a.loadListener.onLoadFinish(a)):(a.loadListener.onLoadFailed(a,this.status),console.log("-ajax error:%d",this.status))},h.send()}}function FloorExtrude(t,e,i){this.gl=t,this.height=e||10,this.color=i,this.extrudeTopVBO=null,this.extrudeTopSize=0,this.extrudeTopVarray=[],this.extrudeSideVBO=null,this.extrudeSideSize=0,this.extrudeSideVarray=[],this.borderVBO=null,this.borderSize=0,this.borderVarray=[],this.borderNormal=YFM.Math.Vector.vec(0,0,1)}function FloorIcons(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new FloorQuadTree(i,100),this.iconTex=null;var r=[];r.push(YFM.Math.Vector.pos(-1,-1,0)),r.push(YFM.Math.Vector.pos(1,-1,0)),r.push(YFM.Math.Vector.pos(1,1,0)),r.push(YFM.Math.Vector.pos(-1,1,0));var o,s=[];for(o=0;o<16;o++)this._calcTexCoords(s,r,o);this.quadVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(s,3),this.gl.STATIC_DRAW),this.quadBufferSize=s.length/2}function FloorQuickPolygon(t,e){this.gl=t,this.height=e||12,this.quickPolygonVBO=null,this.quickPolygonSize=0,this.quickPolygonVarray=[],this.loaded=!1}function FloorQuickIcons(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.height=r||10,this.tex=null,this.texName=null,this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]}function FloorMarkers(t,e,i){this.gl=t,this.region=e,this.floor=i,this.markerArray=[],this.markerIMinPQ=new IndexMinPQ(32),this.markerSorted=[],this.light=YFM.Math.Vector.vec(.5,.5,1),this.orgPos=YFM.Math.Vector.pos(0,0,0),null===FloorMarkers.prototype.quadVBO&&this._initQuad(t)}function FloorModels(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.vPitch=r,this.quadTree=new FloorQuadTree(i,r)}function Euler(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.order=r||Euler.DefaultOrder}function Quaternion(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}function FrustumWorldSpace(){this.near=YFM.Math.Vector.vec(),this.far=YFM.Math.Vector.vec(),this.left=YFM.Math.Vector.vec(),this.right=YFM.Math.Vector.vec(),this.top=YFM.Math.Vector.vec(),this.bottom=YFM.Math.Vector.vec()}function OBB(t){this.isOBB=!0;var e,i;e=YFM.Math.Matrix.covariance3x3(t),i=YFM.Math.Matrix.eig3x3(e),this.t=YFM.Math.Vector.vec(i.vec[0],i.vec[1],i.vec[2]),this.s=YFM.Math.Vector.vec(i.vec[3],i.vec[4],i.vec[5]),this.r=YFM.Math.Vector.vec(i.vec[6],i.vec[7],i.vec[8]),this._calc_bounding(t)}function FloorQuadTree(t,e){this.floor=t,this.root=new FloorQuadNode(null,t,0,t.mapWidth,0,t.mapHeight,e,"0",0),this.objMap={}}function FloorQuadNode(t,e,i,r,o,s,n,a,h){this.parentNode=t,this.floor=e,this.xmin=i,this.xmax=r,this.ymin=o,this.ymax=s,this.height=n,this.mask=a,this.level=h;var u,l,c,M,f=[];u=e.floorPos2Region(i,o),l=e.floorPos2Region(r,o),c=e.floorPos2Region(r,s),M=e.floorPos2Region(i,s),f.push(YFM.Math.Vector.pos(u[0],u[1],u[2]-100)),f.push(YFM.Math.Vector.pos(l[0],l[1],l[2]-100)),f.push(YFM.Math.Vector.pos(c[0],c[1],c[2]-100)),f.push(YFM.Math.Vector.pos(M[0],M[1],M[2]-100)),f.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+n)),f.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+n)),f.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+n)),f.push(YFM.Math.Vector.pos(M[0],M[1],M[2]+n)),this.obb=new OBB(f),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1}function PlanePolygon(t){this.barrier=[],this.plane=this._makePlanePts(t)}function Mover(t,e,i){this.mass=this.DEFAULT_MASS,this.maxForce=this.DEFAULT_MAX_FORCE,this.maxSpeed=this.DEFAULT_MAX_SPEED,this.location=YFM.Math.Vector.pos(t||0,e||0,i||0),this.velocity=YFM.Math.Vector.vec(0,0,0),this.acceleration=YFM.Math.Vector.vec(0,0,0)}function MeshBuffer(t){this.gl=t,this.attributes={}}function TetrahedronMesh(t,e){this._init(t,e)}function HexahedronMesh(t,e){this._init(t,e)}function OctahedronMesh(t,e){this._init(t,e)}function DodecahedronMesh(t,e){this._init(t,e)}function IcosahedronMesh(t,e){this._init(t,e)}function ObjModel(t){this.region=t,this.floor=null,this.obb=null,this.gl=t.gl,this.objects=[],this.texturePool=t.texturePool,this.modelMatrix=YFM.Math.Matrix.mat(),this.baseUrl=null,this.hasMaterials=!1,this.materials={}}function MtlItem(){this.Ns=32,this.Ka=YFM.Math.Vector.pos(),this.Kd=YFM.Math.Vector.pos(),this.Ks=YFM.Math.Vector.pos(),this.mapKd=null}function RawPanorama(t,e){this.gl=t,this.region=e,this.cubeVBO=null,this.cubeSize=0,this.cubeMap=null,this._initCube(),this.modelMat=YFM.Math.Matrix.rotate3d(90,1,0,0)}function BaseColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight")}function BasePhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.uLighting=t.getUniformLocation(this.program,"uLighting")}function RegionPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos")}function SelectColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uColor=t.getUniformLocation(this.program,"uColor")}function BillboardIconProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uiViewMat=t.getUniformLocation(this.program,"uiViewMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Marker2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function PointSpiritProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function RawPanoramaProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uTexMap=t.getUniformLocation(this.program,"uTexMap")}function ModelPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uNs=t.getUniformLocation(this.program,"uNs"),this.uKa=t.getUniformLocation(this.program,"uKa"),this.uKd=t.getUniformLocation(this.program,"uKd"),this.uKs=t.getUniformLocation(this.program,"uKs"),this.uTexFlag=t.getUniformLocation(this.program,"uTexFlag"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.defaultNs=32,this.defaultColor=YFM.Math.Vector.pos(1,1,1),this.defaultKa=YFM.Math.Vector.pos(.3,.3,.3),this.defaultKd=YFM.Math.Vector.pos(1,1,1),this.defaultKs=YFM.Math.Vector.pos(.1,.1,.1)}function DeviceOrientationCamera(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat(),this.quaternion=new Quaternion,this.pitchEnable=!0,this.pitch=this.DEFAULT_PITCH,this.lookAt=YFM.Math.Vector.vec(0,0,0),this.lookOffset=YFM.Math.Vector.vec(0,0,-400),this.zee=YFM.Math.Vector.vec(0,0,1),this.q0=new Quaternion(Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q1=new Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q2=new Quaternion,this.enabled=!1,this.deviceOrientation=null,this.screenOrientation=0,this.roll=0,this.alphaOffsetAngle=0;var t=this,e=function(e){t.deviceOrientation=e,t.dirty=!0},i=function(){t.screenOrientation=window.orientation||0};this.connect=function(){window.addEventListener("deviceorientation",e,!1),window.addEventListener("orientationchange",i,!1),t.enabled=!0,t.pitchEnable=!1,t.dirty=!0},this.disconnect=function(){window.removeEventListener("orientationchange",i,!1),window.removeEventListener("deviceorientation",e,!1),t.enabled=!1,t.deviceOrientation=null,t.pitchEnable=!0,t.quaternion=new Quaternion,t.dirty=!0,t.roll=0},this.ldsN=4,this.ldsIndex=0,this.rgss=[],this.rgss.push(YFM.Math.Vector.vec(0,.25)),this.rgss.push(YFM.Math.Vector.vec(.5,0)),this.rgss.push(YFM.Math.Vector.vec(.75,.5)),this.rgss.push(YFM.Math.Vector.vec(.25,.75))}function TexturePool(t){this.gl=t,this.pool={}}function TextureWrap(t,e,i){this.name=t,this.url=e,this.img=i,this.w=0,this.h=0}var bind1=function(t,e){return function(){return t.apply(e,arguments)}};!function(t,e){"use strict";var i,r,o,s,n,a,h,u,l,c,M,f,d,p,g;s=null,o="error",i="click",a=e.querySelectorAll,p={}.toString,n=function(t,e,i){return t.addEventListener(e,i,!1)},g=function(t,e,i){return t.removeEventListener(e,i,!1)},f=function(t){return t===s},M=Array.isArray||function(t){return t&&"[object Array]"===p.call(t)},d=function(t){return"object"==typeof t&&!M(t)&&!f(t)},c=function(){var t,i;return e.body||(null!=(t=a("body"))?t[0]:void 0)||(null!=(i=a("html"))?i[0]:void 0)},r=function(){function r(){this.toggle=bind1(this.toggle,this),this.isInit=this.isHide=!1,this.msg=this.fn=this.color="",this.el=s}var o,a,h,u,l,f,p,g,m;a={log:"FFFFFF",danger:"da4f49",warn:"faa732",success:"5bb75b",error:"bd362f"},g=function(t){var e,i,r,o,s;if(s="",e=[],M(t))for(i=0,o=t.length;i<o;i++)r=t[i],"object"==typeof r?(e.push(g(r)),s="["+e.join(",")+"]"):(e.push(""+r),s="["+e.join(",")+"]");else if(d(t))for(r in t)"object"==typeof t[r]?(e.push(r+": "+g(t[r])),s="{"+e.join(",")+"}"):(e.push(r+": "+t[r]),s="{"+e.join(",")+"}");else s=String(t);return s},m=function(t,e){return t.style.webkitTransform="translate3d(0,"+e+",0)",
t.style.transform="translate3d(0,"+e+",0)"},u=function(t){return t.join(";")},l=6,p=["-webkit-transition: all .3s ease","transition: all .3s ease"],o=["margin-top:-1px","padding:10px","border-top:1px solid rgba(255,255,255,.1)","margin:0","max-width:"+(t.outerWidth-20)+"px"].concat(p),f=["-webkit-overflow-scrolling:touch","overflow:auto","line-height:1.5","z-index:5000","position:fixed","left:0","top:0","font-size:11px","background:rgba(0,0,0,.8)","color:#fff","width:100%","padding-bottom:"+l+"px","max-height:100%"].concat(p),r.prototype.init=function(){var t,r;return r=this.el=e.createElement("div"),r.setAttribute("style",u(f)),t=c(),t.appendChild(r),m(r,0),n(r,i,function(t){return function(){return t.toggle()}}(this)),this.isInit=!0,this},r.prototype.print=function(){var t,i;return this.isInit||this.init(),i=o.concat(["color:#"+this.color]),t=e.createElement("p"),t.setAttribute("style",u(i)),t.innerHTML=this.msg,this.el.appendChild(t),this},r.prototype.toggle=function(t){return(this.isHide?this.show:this.hide).call(this,t)},r.prototype.show=function(t){return m(this.el,0),this.isHide=!1,this},r.prototype.hide=function(t){return m(this.el,"-"+(this.el.offsetHeight-l)+"px"),this.isHide=!0,this};for(h in a)r.prototype[h]=function(t){return function(e){return this.fn=t,this.msg=g(e),this.color=a[t],this.print()}}(h);return r}(),h=new r,u=function(t){var e;return e=["Error:","filename: "+t.filename,"lineno: "+t.lineno,"message: "+t.message,"type: "+t.type],h.error(e.join("<br/>"))},n(t,o,u),h.silence=function(){return g(t,o,u)},void 0!==l&&module.exports?module.exports=l=h:"function"==typeof define?define("debug",function(t,e,i){return i.exports=h}):"object"==typeof angular?angular.module("binnng/debug",[]).factory("$debug",function(){return h}):t.debug=h}(window,document);var YFM={};ArrayList.prototype={constructor:ArrayList,getIter:function(){return new ArrayListIter(this.head,this.tail)},size:function(){return this.count},addHigh:function(t){var e=new ArrayListNode(t);e.prev=this.tail.prev,e.next=this.tail,this.tail.prev.next=e,this.tail.prev=e,this.count+=1},addLow:function(t){var e=new ArrayListNode(t);e.prev=this.head,e.next=this.head.next,this.head.next.prev=e,this.head.next=e,this.count+=1},clean:function(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head},remove:function(t){var e,i,r;if(t<-this.count||t>this.count-1)e=null;else if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}return e},removeHigh:function(){var t;return this.count>=1?(t=this.tail.prev.value,this.tail.prev.prev.next=this.tail,this.tail.prev=this.tail.prev.prev,this.count-=1):t=null,t},removeLow:function(){var t;return this.count>=1?(t=this.head.next.value,this.head.next.next.prev=this.head,this.head.next=this.head.next.next,this.count-=1):t=null,t},get:function(t){var e,i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value}return e},put:function(t,e){var i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;i.value=e}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;i.value=e}}},ArrayListIter.prototype={constructor:ArrayListIter,hasNext:function(){return this.cursor.next!=this.tail},getNext:function(){var t=this.cursor.next.value;return this.cursor=this.cursor.next,t}},IndexMinPQ.prototype={constructor:IndexMinPQ,clean:function(){this.count=0;for(var t=0;t<=this.size;t++)this.qp[t]=-1,this.keys[t]=Number.MAX_VALUE},setSize:function(t){var e,i;if((e=t-this.size)<0)for(i=e;i<0;i++)this.pq.pop(),this.qp.pop(),this.keys.pop();else if(e>0)for(i=0;i<e;i++)this.pq.push(null),this.qp.push(null),this.keys.push(null);this.size=t,this.clean()},getSize:function(){return this.size},getCount:function(){return this.count},changeKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.changeKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.changeKey, do not contains index:"+t);this.keys[t]=e,this._swim(this.qp[t]),this._sink(this.qp[t])},decreaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.decreaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.decreaseKey, do not contains index:"+t);if(this.keys[t]<=e)throw new Error("IndexMinPQ.decreaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},increaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.increaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.increaseKey, do not contains index:"+t);if(this.keys[t]>=e)throw new Error("IndexMinPQ.increaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},deleteMin:function(){if(this.count<=0)throw new Error("IndexMinPQ.deleteMin, empty content");var t;return t=this.pq[1],this._exch(1,this.count),this.count-=1,this._sink(1),this.qp[t]=-1,this.keys[this.pq[this.count+1]]=Number.MAX_VALUE,this.pq[this.count+1]=-1,t},delete:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.delete, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.delete, do not contains index:"+t);var e=qp[t];this._exch(e,this.count),this.count-=1,this._swim(e),this._sink(e),this.keys[t]=Number.MAX_VALUE,this.qp[t]=-1},contains:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.countains, out of range index:"+t);return-1!==this.qp[t]},isEmpty:function(){return 0===this.count},keyOf:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.keyOf, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.keyOf, do not contains index:"+t);return this.keys[t]},minIndex:function(){if(this.count<=0)throw new Error("IndexMinPQ.minIndex, empty content");return this.pq[1]},minKey:function(){if(this.count<=0)throw new Error("IndexMinPQ.minKey, empty content");return this.keys[this.pq[1]]},indexAt:function(t){if(t<0||t>this.count)throw new Error("IndexMinPQ.indexAt, out of range pos:"+t);return this.pq[t+1]},insert:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.insert, out of range index:"+t);if(this.contains(t))throw new Error("IndexMinPQ.insert, do contains index:"+t);this.count+=1,this.qp[t]=this.count,this.pq[this.count]=t,this.keys[t]=e,this._swim(this.count)},_exch:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._exch, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._exch, out of range j:"+e);var i=this.pq[t];this.pq[t]=this.pq[e],this.pq[e]=i,this.qp[this.pq[t]]=t,this.qp[this.pq[e]]=e},_greater:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._greater, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._greater, out of range j:"+e);return this.keys[this.pq[t]]>this.keys[this.pq[e]]},_sink:function(t){var e;if(t<0||t>this.size)throw new Error("IndexMinPQ._sink, out of range k:"+t);for(;2*t<=this.count&&(e=2*t,e<this.count&&this._greater(e,e+1)&&e++,this._greater(t,e));)this._exch(t,e),t=e},_swim:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ._swin, out of range k:"+t);for(;t>1;){var e=Math.round(t/2);if(!this._greater(e,t))break;this._exch(t,e),t=e}}},YFM.Map={},YFM.Map.STATUS_TOUCH=0,YFM.Map.STATUS_SENSOR=1,YFM.Map.STATUS_NAVIGATE=2,YFM.Map.STATUS_TRACE=3,YFM.Map.Navigate={},YFM.Map.Navigate.Suggestion={NONE:"none",FRONT:"front",LEFT:"left",BACKWARD:"backward",RIGHT:"right"},YFM.Map.Navigate.NextSuggestion={NONE:"none",FRONT:"front",LEFT:"left",RIGHT:"right",ARRIVE:"arrive"},Region.prototype={constructor:Region,setUIScaleRate:function(t){this.touchMgr.setUIScaleRate(t)},getId:function(){return this.id},startRender:function(){YFM.gRegion=this,YFM.gRegion._grender()},displayFloor:function(t){if(!(t>=0||t<this.floors.length))throw new Error("Rgeion.js [displayFloor] Floor index out of range:"+t);this.displayFloorIndex=t;var e=this.floors[t].getAspect();this.lookAtMapLoc(t,e.w/2,e.h/2)},displayRegion:function(){this.displayFloorIndex=-1},setFontType:function(t){this.ctx2d.font=t},setFontColor:function(t){this.ctx2d.fillStyle=t},setStatus:function(t){if(t!==this.status){switch(t){case YFM.Map.STATUS_TOUCH:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t;break;case YFM.Map.STATUS_SENSOR:YFM.Map.STATUS_SENSOR!==this.status&&this.camera.connect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_TRACE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_NAVIGATE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation(),this.locMarker.updateLocation()}this.listener&&this.listener.onStatusChange(this.status)}},getStatus:function(){return this.status},addFloorsURL:function(t){var e,i,r,o=this,s={onLoadFinish:function(t){for(var e=!0,i=0;i<o.floors.length;i++)if(!o.floors[i].isLoaded()){e=!1;break}o.listener&&(o.listener.onLoadFinish(t.id,t.index),e&&(o._restructure(),o.listener.onAllFloorLoadFinish())),e&&o.touchMgr.onRegionLoadFinish()},onLoadFailed:function(t){this.listener&&this.listener.onLoadFailed(t.id,t.index)}};for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.url,e.deflection,this,r,s))},addFloorsSVG:function(t){var e,i,r;for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.svg,e.deflection,this,r,null));this._restructure(),this.listener.onAllFloorLoadFinish(),this.touchMgr.onRegionLoadFinish()},addTexture:function(t,e){this.texturePool.addTexture(t,e)},getTexture:function(t){return this.texturePool.getTexture(t)},getFloorCount:function(){return this.floors.length},getFloorAspect:function(t){return this.floors[t].getAspect()},getFloorLoc:function(){return this.locMarker.getFloorLoc()},getRegionLoc:function(){return this.locMarker.getRegionLoc()},updateNaviStatus:function(t,e){this.route.updateNaviStatus(t,e)},cleanLocation:function(){this.locMarker.cleanLocation()},setLocation:function(t,e,i){this.locMarker.setLocation(t,e,i)},animTo:function(t,e,i){this.locMarker.animTo(t,e,i)},lookAtMapLoc:function(t,e,i){var r=this.floors[t].floorPos2Region(e,i);this.lookAtRegionLoc(r[0],r[1],r[2])},lookAtWorldLoc:function(t,e,i){this.camera.setLookAt(t,e,i)},lookAtRegionLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),o=YFM.Math.Matrix.mulVec(this.matRegion,r);this.camera.setLookAt(o[0],o[1],o[2])},animLookAt:function(t,e,i,r){var o=this.floors[t].floorPos2Region(e,i),s=YFM.Math.Matrix.mulVec(this.matRegion,o);this.animMgr.animLookAt(s,r)},animLookAtWorld:function(t,e){this.animMgr.animLookAt(t,e)},animLookDistance:function(t,e){this.animMgr.animLookDistance(t,e)},animLookAzimuth:function(t,e){this.animMgr.animLookAzimuth(t,e)},animPitch:function(t,e){this.animMgr.animPitch(t,e)},overlookMap:function(t){var e=this.floors[t],i=e.floorPos2Region(e.mapWidth/2,e.mapHeight/2),r=YFM.Math.Matrix.mulVec(this.matRegion,i),o=this.camera.getAzimuth(),s=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),n=-s+o+YFM.Math.deg2Radian(e.deflection),a=e.mapWidth>e.mapHeight?e.mapWidth:e.mapHeight;this.animMgr.animLookAt(r,"overlookMap"),this.animMgr.animLookAzimuth(YFM.Math.radian2Deg(this._clampMinorArc(n)),"overlookMap"),this.animMgr.animLookDistance(a,"overlookMap")},setRoute:function(t){this.route.setRoute(t)},cleanRoute:function(){this.route.cleanRoute()},overlookRoute:function(){var t=this.route.getRouteCenter();if(null!==t){var e=YFM.Math.Matrix.mulVec(this.matRegion,t);this.animMgr.animLookAt(e,"overlook");var i=this.route.getRouteRAxis(),r=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),o=this.camera.getAzimuth(),s=this._makeAzimuth(i),n=-r+o+s+Math.PI/2;this.animMgr.animLookAzimuth(YFM.Math.radian2Deg(this._clampMinorArc(n)),"overlook"),this.animMgr.animLookDistance(this.route.getRouteOBBLength(),"overlook")}},getNaviStatus:function(){return this.route.getNaviStatus()},insertUnit:function(t,e,i,r){this.floors[e].insertUnit(t,i,r)},insertModel:function(t,e,i,r,o,s,n){return this.floors[t].insertModel(e,i,r,o,s,n)},removeModel:function(t){var e=this._calcModelFloor(t);return this.floors[e].removeModel(t)},setQuickIconTexture:function(t){for(var e=0;e<this.floors.length;e++)this.floors[e].quickIcons.setTex(t)},addQuickPolygon:function(t,e,i){this.floors[t].quickPolygon.addQuickPolygon(e,i)},buildQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.buildQuickPolygon()},buildQuickPolygonFloor:function(t){this.floors[t].quickPolygon.buildQuickPolygon()},cleanQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.cleanQuickPolygon()},cleanQuickPolygonFloor:function(t){this.floors[t].quickPolygon.cleanQuickPolygon()},addQuickIcon:function(t,e,i){this.floors[t].quickIcons.addPoint(e,i)},buildQuickIcon:function(t){this.floors[t].quickIcons.buildPoints()},cleanQuickIcon:function(t){this.floors[t].quickIcons.clean()},insertGeometryMarker:function(t,e,i,r,o,s,n){return this.floors[r].markers.insertGeometryMarker(t,e,i,o,s,n)},insertTextureMarker:function(t,e,i,r,o,s,n){return this.floors[e].markers.insertTextureMarker(t,i,r,o,s,n)},removeMarker:function(t){var e=this._calcMarkerFloor(t);return null!==this.floors[e].markers.removeMarker(t)},updateMarkerLocation:function(t,e,i,r){var o=-1,s=this._calcMarkerFloor(t),n=this.floors[s].markers.removeMarker(t);return null!==n&&(o=this.floors[e].markers.insertMarker(n,i,r)),o},searchModel:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchModel(r,!1)}return[]},searchUnit:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchUnit(r,20,!1)}return[]},searchIcon:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchIcon(r,80,!1)}return[]},searchMarker:function(t,e){for(var i=null,r=Number.MAX_VALUE,o=0;o<this.floors.length;o++)if(-1!==this.floors[o].BBCheck){var s=this.floors[o].markers.findMarker(t,e);null!==s&&r>s.dist&&(i=s,r=s.dist)}return null!==i?i.id:-1},getTouchPosMapLoc:function(t,e){return this.touchMgr._screen_to_map(t,e)},getTouchPosWorldLoc:function(t,e){return this.touchMgr._pos_in_world_space(t,e)},regionPos2Screen:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]=i[0]*this.hw+this.hw,i[1]=-i[1]*this.hh+this.hh,i},floorPos2RegionPos:function(t,e,i){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].floorPos2Region(e,i)},_onOverlook:function(t){this.overlook=t,this.extrudeLight=t?this.extrudeLightOver:this.extrudeLightNormal},_getRegionMat:function(){return this.matRegion},_setRegionMat:function(t){this.matRegion=t},_traceLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),o=YFM.Math.Matrix.mulVec(this.matRegion,r);if(YFM.Map.STATUS_NAVIGATE===this.status){var s=0,n=this.getNaviStatus();if(n.validate){var a=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion);s=n.azimuth+a}this.camera.setLookAtAzimuth(s,o[0],o[1],o[2])}else this.camera.setLookAt(o[0],o[1],o[2])},_getFloorMat:function(t){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].getFloorMat()},_intersectionLine:function(t){var e,i,r=[];for(e=this.floors.length,i=0;i<e;i++)r.push(this.floors[i].intersectionLine(t));return r},_render:function(){var t,e;t=this.floors.length,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.animMgr.update(),this._cleanText(),this.renderParam.projMat=this.camera.getProjectionMat(),this.renderParam.viewMat=this.camera.getViewMat(),this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.matRegion),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion);var i=YFM.Math.Matrix.matClone(this.renderParam.vrMat);i[12]=0,i[13]=0,i[14]=0;var r=YFM.Math.Matrix.invert(i),o=YFM.Math.Matrix.scale(15,0,0,0);o=YFM.Math.Matrix.postRotate3d(o,this.camera.getRoll()-90,0,0,1),this.renderParam.bivrMat=YFM.Math.Matrix.mul(r,o),this.frustum.update(this.renderParam.pvrMat),this.panoramaShader.useProgram(),this.panoramaShader.setProjectionMatrix(this.renderParam.projMat),this.panoramaShader.setViewMatrix(this.renderParam.viewMat),this.panorama.render(this.panoramaShader,this.matRegion);var s=[];if(-1===this.displayFloorIndex){var n=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++){var a=this.floors[e].frustumCheck(this.frustum);this.floors[e].BBCheck=a,this._renderFloor(e,a,n),s.push(a)}}else this._renderFloor(this.displayFloorIndex,a,this.displayFloorIndex);var h=this.frustum.containCheckPoint(this.locMarker.getRegionLoc());for(h&&(this.selectColorShader.useProgram(),this.selectColorShader.setProjectionMatrix(this.renderParam.projMat),this.selectColorShader.setViewMatrix(this.renderParam.viewMat),this.selectColorShader.setRegionMatrix(this.matRegion)),this.locMarker.render(this.selectColorShader,h),this.regionPhongShader.useProgram(),this.regionPhongShader.setProjectionMatrix(this.renderParam.projMat),this.regionPhongShader.setViewMatrix(this.renderParam.viewMat),this.regionPhongShader.setRegionMatrix(this.matRegion),this.route.render(this.regionPhongShader,this.renderParam.vrMat),e=0;e<t;e++)-1!==s[e]&&this._renderFloor2DMarker(e)},_getFloorVOffset:function(t){return t*this.vPitch},_renderFloor2DMarker:function(t,e){this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.regionPhongShader.useProgram(),this.regionPhongShader.setProjectionMatrix(this.renderParam.projMat),this.regionPhongShader.setViewMatrix(this.renderParam.viewMat),this.regionPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderMarkers(this.frustum,this.marker2DShader,this.regionPhongShader,this.renderParam.vrMat,this.renderParam.pvrMat)},_renderFloor:function(t,e,i){if(-1!=e){this.baseColorShader.useProgram(),this.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.baseColorShader.setRegionMatrix(this.matRegion),this.floors[t].renderBase(this.baseColorShader,this.touchMgr.getTouchFloor()==t);var r=this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(r=!1);var o=!this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(o=!0),this.basePhongShader.useProgram(),this.basePhongShader.setProjectionMatrix(this.renderParam.projMat),this.basePhongShader.setViewMatrix(this.renderParam.viewMat),this.basePhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderExtrude(this.basePhongShader,this.renderParam.vrMat,this.extrudeLight,o),r&&t==i&&this.floors[t].renderUnit(this.frustum,this.selectColorShader),this.pointSpiritShader.useProgram(),this.pointSpiritShader.setProjectionMatrix(this.renderParam.projMat),this.pointSpiritShader.setViewMatrix(this.renderParam.viewMat),this.pointSpiritShader.setRegionMatrix(this.matRegion),this.floors[t].renderQuickIcons(this.pointSpiritShader),this.billboardIconShader.useProgram(),this.billboardIconShader.setProjectionMatrix(this.renderParam.projMat),this.billboardIconShader.setViewMatrix(this.renderParam.viewMat),this.billboardIconShader.setRegionMatrix(this.matRegion),this.billboardIconShader.setIViewMatrix(this.renderParam.bivrMat),this.floors[t].renderIcons(this.frustum,this.billboardIconShader),this.modelPhongShader.useProgram(),this.modelPhongShader.setProjectionMatrix(this.renderParam.projMat),this.modelPhongShader.setViewMatrix(this.renderParam.viewMat),this.modelPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderModels(this.frustum,this.modelPhongShader,this.renderParam.vrMat,this.extrudeLight)}},_restructure:function(){var t,e,i,r;for(e=0,r=this.floors.length,i=0;i<r;i++)null!=(t=this.floors[i].getSize())&&t>e&&(e=t);for(this.maxSize=e,this.vPitch=e,i=0;i<r;i++)this.floors[i].setVOffset(this.vPitch,i);var o=r*this.vPitch,s=Math.sqrt(o*o+e*e);this.touchMgr.setZoomMax(s)},_grender:function(){YFM.gRegion._render(),requestAnimFrame(YFM.gRegion._grender)},_makeAzimuth:function(t){var e=YFM.Math.Vector.vec(0,1,0),i=YFM.Math.Vector.normalize(t),r=YFM.Math.Vector.dot3(i,e);return Math.acos(r)},_clampMinorArc:function(t){var e=2*Math.PI,i=t%e;return i>0&&i>Math.PI?i-=e:i<0&&i<-Math.PI&&(i+=e),i},_calcMarkerFloor:function(t){return t%FloorMarkers.prototype.shift},_calcModelFloor:function(t){return t%FloorQuadTree.prototype.shift},_drawText:function(t,e,i){this.ctx2d.fillText(t,e,i)},_cleanText:function(){this.ctx2d.clearRect(0,0,this.txtCanvas.width,this.txtCanvas.height)}},RegionLocMarker.prototype={constructor:RegionLocMarker,getRegionLoc:function(){return YFM.Math.Vector.vecClone(this.regionLoc)},getFloorLoc:function(){return{floor:this.floorLoc.floor,x:this.floorLoc.x,y:this.floorLoc.y}},getSize:function(){return this.size},updateLocation:function(){-1!==this.floorLoc.floor&&(this.regionLoc=this.region.floorPos2RegionPos(this.floorLoc.floor,this.floorLoc.x,this.floorLoc.y),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc))},cleanLocation:function(){this.floorLoc.floor=-1,this.floorLoc.x=0,this.floorLoc.y=0},setLocation:function(t,e,i){this.floorLoc.floor=t,this.floorLoc.x=e,this.floorLoc.y=i,this.regionLoc=this.region.floorPos2RegionPos(t,e,i),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc)},animTo:function(t,e,i){t!=this.floorLoc.floor?(this.anim.flag=!1,this.setLocation(t,e,i)):(this.anim.floor=t,this.anim.flag=!0,this.anim.target=YFM.Math.Vector.pos(e,i,0),this.anim.mover.setLocation(this.floorLoc.x,this.floorLoc.y,0))},render:function(t,e){if(this._updateAnim(),e&&!(this.floorLoc.floor<0)){var i=YFM.Math.Matrix.rotate3d(this.angle,0,0,1);this.modelMat=YFM.Math.Matrix.postTranslate(i,this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),t.setModelMatrix(this.modelMat),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),t.drawTriangles(this.trianglesVBO,this.faceColor,0,18),this.gl.disable(this.gl.DEPTH_TEST),t.drawLines(this.trianglesVBO,this.lineColor,216,16),this.gl.disable(this.gl.BLEND)}},_updateAnim:function(){if(this.anim.flag)if(this.anim.mover.arrive(this.anim.target,this.anim.dist))this.anim.flag=!1,this.setLocation(this.anim.floor,this.anim.target[0],this.anim.target[1]);else{this.anim.mover.update();var t=this.anim.mover.getLocation();this.setLocation(this.anim.floor,t[0],t[1])}},_init:function(t,e){var i=2.5*e,r=[];r.push(YFM.Math.Vector.pos(0,0,0)),r.push(YFM.Math.Vector.pos(0,e,i)),r.push(YFM.Math.Vector.pos(e,0,i)),r.push(YFM.Math.Vector.pos(0,-e,i)),r.push(YFM.Math.Vector.pos(-e,0,i));var o=[];o.push(r[4]),o.push(r[2]),o.push(r[1]),o.push(r[2]),o.push(r[4]),o.push(r[3]),o.push(r[0]),o.push(r[4]),o.push(r[1]),o.push(r[0]),o.push(r[1]),o.push(r[2]),o.push(r[0]),o.push(r[2]),o.push(r[3]),o.push(r[0]),o.push(r[3]),o.push(r[4]),o.push(r[0]),o.push(r[1]),o.push(r[0]),o.push(r[2]),o.push(r[0]),o.push(r[3]),o.push(r[0]),o.push(r[4]),o.push(r[1]),o.push(r[2]),o.push(r[2]),o.push(r[3]),o.push(r[3]),o.push(r[4]),o.push(r[4]),o.push(r[1]),this.trianglesVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.trianglesVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(o,3),t.STATIC_DRAW)}},RegionTouchMgr.prototype={constructor:RegionTouchMgr,setUIScaleRate:function(t){this.uiScaleRate=t},getViewOffsetMax:function(){return this.viewZoom.max},getViewOffsetMin:function(){return this.viewZoom.min},setEnable:function(t){this.enable=t},onRegionLoadFinish:function(){this.focusFloorDirty=!0},getTouchFloor:function(){return this.touchFloorIndex},getFocusFloorIndex:function(){if(!this.focusFloorDirty)return this.focusFloorIndex;var t,e,i,r,o,s,n=-1;for(t=this._floors_collision(this.canvas.width/2,this.canvas.height/2),i=-1e8,s=-1,o=-1,e=t.length,r=0;r<e;r++)t[r]<0&&t[r]>i&&(i=t[r],s=r),0==t[r]&&(o=r);return o>=0?n=o:s>=0&&(n=s),this.focusFloorIndex=n,this.focusFloorDirty=!1,this.focusFloorIndex},setZoomMax:function(t){this.viewZoom.max=t},getTouchRayPlus:function(t,e){var i,r,o,s,n,a,h,u;return i=t/this.canvas.width*2-1,r=-(e/this.canvas.height*2-1),o=YFM.Math.Vector.pos(i,r,-1),s=YFM.Math.Vector.pos(i,r,1),h=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.region.matRegion),u=YFM.Math.Matrix.invert(h),n=YFM.Math.Matrix.mulVec(u,o),a=YFM.Math.Matrix.mulVec(u,s),n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],YFM.Math.Line.linePP(n,a)},_onMouseDown:function(t,e){},_onClick:function(t,e){null!=this.listener&&this.listener.onClick(t,e)},_onDClick:function(t,e){null!=this.listener&&this.listener.onDClick(t,e)},_on2FClick:function(t,e){null!=this.listener&&this.listener.on2FClick(t,e)},_onLongPressUp:function(t,e){null!=this.listener&&this.listener.onLongPressUp(t,e)},_spacingScreenSpace:function(t,e,i,r){var o=i-t,s=r-e;return Math.sqrt(o*o+s*s)},_spacingViewSpace:function(t,e,i,r){var o=this._pos_in_view_space(t,e),s=this._pos_in_view_space(i,r),n=s[0]-o[0],a=s[1]-o[1];return{z:(o[2]+s[2])/2,spacing:Math.sqrt(n*n+a*a)}},_midpoint:function(t,e,i,r){var o,s;return o=(t+i)/2,s=(e+r)/2,this.touchRec.midX=o,this.touchRec.midY=s,this.touchRec.dy0=e-s,this.touchRec.dy1=r-s,this._pos_in_world_space(o,s)},_calc_angle:function(t){var e=this._pos_in_world_space(this.touchRec.layer0x,this.touchRec.layer0y),i=this._pos_in_world_space(this.touchRec.layer1x,this.touchRec.layer1y);return Math.atan2(i[1]-e[1],i[0]-e[0])},_pitch_calc:function(t){return YFM.Math.radian2Deg(YFM.Math.Matrix.eulerParamExtractX(t))},_pitch_detect_continue:function(t){if(t.touches.length<2)return!1;var e,i;return e=this.touchRec.layer0y-this.touchRec.start0y,i=this.touchRec.layer1y-this.touchRec.start1y,e*i>0?this.touchRec.pitchCnt++:this.touchRec.pitchCnt--,this.touchRec.pitchCnt>36},_touch_plane_height:function(t,e){var i,r,o,s,n,a,h=-1;for(i=this._floors_collision(t,e),o=-1e8,a=-1,n=-1,r=i.length,s=0;s<r;s++)i[s]<0&&i[s]>o&&(o=i[s],a=s),0==i[s]&&(n=s);return n>=0?h=n:a>=0&&(h=a),this.touchFloorIndex=h,this.region._getFloorVOffset(h)},_floors_collision:function(t,e){var i=this.getTouchRayPlus(t,e);return this.region._intersectionLine(i)},_pitch_detect_first:function(t){if(t.touches.length<2)return!1;var e,i,r;return i=mgr.touchRec.layer0y-this.touchRec.midY-this.touchRec.dy0,r=mgr.touchRec.layer1y-this.touchRec.midY-this.touchRec.dy1,this.touchRec.pitchCnt=0,e=!1,i*r>0&&(e=!0),e},_pos_in_world_space:function(t,e){var i,r,o,s,n,a,h,u,l,c;return r=t/this.canvas.width*2-1,o=-(e/this.canvas.height*2-1),s=YFM.Math.Vector.pos(r,o,-1),n=YFM.Math.Vector.pos(r,o,1),u=this.camera.getIPVMat(),a=YFM.Math.Matrix.mulVec(u,s),h=YFM.Math.Matrix.mulVec(u,n),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],c=YFM.Math.Line.linePP(a,h),l=YFM.Math.Plane.plane(0,0,this.planeRec.planeHeight,0,0,1),i=YFM.Math.Plane.intersectionLine(l,c),YFM.Math.Line.getPoint(c,i)},_pos_in_view_space:function(t,e){var i=this._pos_in_world_space(t,e);return this._world_to_view(i)},_world_to_view:function(t){return YFM.Math.Matrix.mulVec(this.camera.getViewMat(),t)},_screen_to_map:function(t,e){if(this.touchFloorIndex>=0){var i=this._pos_in_world_space(t,e),r=this.region._getFloorMat(this.touchFloorIndex),o=this.region._getRegionMat(),s=YFM.Math.Matrix.mul(o,r),n=YFM.Math.Matrix.invert(s),a=YFM.Math.Matrix.mulVec(n,i);return{floor:this.touchFloorIndex,x:a[0],y:this.region.getFloorAspect(this.touchFloorIndex).h-a[1]}}return null},_updateEventLayerPos:function(t){var e,i;t.layerX&&t.pageX?(e=t.layerX-t.pageX,i=t.layerY-t.pageY):(e=-t.target.offsetLeft,i=-t.target.offsetTop),t.touches&&t.touches.length>=1?(this.touchRec.layer0x=(t.touches[0].pageX+e)/this.uiScaleRate,this.touchRec.layer0y=(t.touches[0].pageY+i)/this.uiScaleRate,t.touches.length>=2?(this.touchRec.layer1x=(t.touches[1].pageX+e)/this.uiScaleRate,this.touchRec.layer1y=(t.touches[1].pageY+i)/this.uiScaleRate):(this.touchRec.layer1x=0,this.touchRec.layer1y=0)):(this.touchRec.layer0x=t.layerX/this.uiScaleRate,this.touchRec.layer0y=t.layerY/this.uiScaleRate)},_isMobileBrowser:function(){var t=navigator.userAgent.toLowerCase(),e="ipad"==t.match(/ipad/i),i="iphone os"==t.match(/iphone os/i),r="midp"==t.match(/midp/i),o="rv:1.2.3.4"==t.match(/rv:1.2.3.4/i),s="ucweb"==t.match(/ucweb/i),n="android"==t.match(/android/i),a="windows ce"==t.match(/windows ce/i),h="windows mobile"==t.match(/windows mobile/i);return e||i||r||o||s||n||a||h}},YFM.Map.ANIM_TYPE_PITCH=0,YFM.Map.ANIM_TYPE_LOOKAT=1,YFM.Map.ANIM_TYPE_LOOKDISTANCE=2,YFM.Map.ANIM_TYPE_LOOKAZIMUTH=3,AnimationMgr.prototype={constructor:AnimationMgr,update:function(){if(null===this.current&&(this.current=this.seq.removeHigh(),null!==this.current&&(this.touchMgr.setEnable(!1),this.listener.onAnimStart(this.current))),null!==this.current){var t=this.current.step/this.current.frame,e=YFM.Math.lerp;switch(this.current.step+=1,this.current.type){case YFM.Map.ANIM_TYPE_PITCH:var i;i=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setPitch(i),this.current.overlook?0!==i&&(this.region._onOverlook(!1),this.current.overlook=!1):0===i&&(this.region._onOverlook(!0),this.current.overlook=!0);break;case YFM.Map.ANIM_TYPE_LOOKDISTANCE:var r;r=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setLookOffset(0,0,r),this.camera.resetLookOffsetTan();break;case YFM.Map.ANIM_TYPE_LOOKAZIMUTH:var o;o=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setAzimuth(o);break;case YFM.Map.ANIM_TYPE_LOOKAT:1==this.current.step&&(this.mover.setLocation(this.current.from[0],this.current.from[1],this.current.from[2]),this.camera.resetLookOffsetTan()),this.mover.arrive(this.current.to,2)?(this.current.step=this.current.frame,this.mover.setLocation(this.current.to[0],this.current.to[1],this.current.to[2])):this.mover.update();var s=this.mover.getLocation();this.camera.setLookAt(s[0],s[1],s[2])}this.current.step>=this.current.frame&&(this.listener.onAnimFinish(this.current),this.current=null,this.touchMgr.setEnable(!0))}},animPitch:function(t,e,i,r){var o=YFM.Math.clamp(t,0,45),s=e||null,n=i||24;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(s,YFM.Map.ANIM_TYPE_PITCH,n);a.from=this.camera.getPitch(),a.to=-o,a.overlook=0===a.from,this.seq.addLow(a)},animLookDistance:function(t,e,i,r){var o=t,s=e||null,n=i||24;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(s,YFM.Map.ANIM_TYPE_LOOKDISTANCE,n);a.from=this.camera.getLookOffsetNormal(),a.to=-o,this.seq.addLow(a)},animLookAzimuth:function(t,e,i,r,o){var s=YFM.Math.deg2Radian(t),n=e||null,a=i||!1,h=r||24;(o||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var u=new Animation(n,YFM.Map.ANIM_TYPE_LOOKAZIMUTH,h);u.from=this.camera.getAzimuth(),u.to=a?-s:u.from-s,this.seq.addLow(u)},animLookAt:function(t,e,i){var r=e||null;(i||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null)
;var o=new Animation(r,YFM.Map.ANIM_TYPE_LOOKAT,1024);o.from=this.camera.getLookAt(),o.to=t,this.seq.addLow(o)}},RegionRoute.prototype={constructor:RegionRoute,getRouteCenter:function(){return null!==this.obb?YFM.Math.Vector.vecClone(this.obb.center):null},getRouteRAxis:function(){return null!==this.obb?YFM.Math.Vector.vecClone(this.obb.r):null},getRouteOBBLength:function(){if(null!==this.obb){var t=this.obb.hr,e=this.obb.hs,i=this.obb.ht;return 2*Math.sqrt(t*t+e*e+i*i)}return 0},getNaviStatus:function(){return this.naviStatus.validate?{validate:this.naviStatus.validate,projDist:this.naviStatus.projDist,goalDist:this.naviStatus.goalDist,serialDist:this.naviStatus.serialDist,nextSerialDist:this.naviStatus.nextSerialDist,azimuth:this.naviStatus.azimuth,sug:this.naviStatus.sug,nextSug:this.naviStatus.nextSug}:{validate:!1}},updateNaviStatus:function(t,e){null==this.floorRouteList?this.naviStatus.validate=!1:-1==t.floor?this.naviStatus.validate=!1:this.floorRouteList[t.floor].makeNaviStatus(this.naviStatus,e)},setRoute:function(t){this.cleanRoute();var e,i,r,o,s,n,a,h,u,l=[];for(n=this.region.getFloorCount(),this.floorRouteList=[],h=0;h<n;h++)this.floorRouteList.push(new FloorRoute(this.size,h,this.region,this));for(a=t.length,h=0;h<a;h++)o=t[h],r=this.region.floorPos2RegionPos(o.floor,o.x,o.y),r[2]+=5,l.push(r);for(this.obb=new OBB(l),u=t[0].floor,h=0;h<a-1;h++)o=t[h],s=t[h+1],s.floor==u?this.floorRouteList[u].addSeg(l[h],l[h+1]):u=s.floor;e=this.region.getFloorLoc(),-1!=e.floor&&(i=this.region.getRegionLoc(),this.updateNaviStatus(e,i)),this._makeRouteVBO()},cleanRoute:function(){this.floorRouteList=null,null!=this.routeVBO&&this.gl.deleteBuffer(this.routeVBO)},render:function(t,e){this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var i=YFM.Math.Matrix.transpose(e),r=YFM.Math.Matrix.invert(i);t.setLightPos(this.light),t.setNormalMatrix(r),null!=this.routeVBO&&(t.setModelMatrix(YFM.Math.Matrix.mat()),t.setColor(this.routeColor),this.naviStatus.validate?(t.drawTriangles(this.routeVBO,this.routeBufferSize,60*this.naviStatus.startInstance),this._renderTail(t)):t.drawTriangles(this.routeVBO,this.routeBufferSize,0)),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderTail:function(t){var e,i,r,o,s,n,a;for(r=this.naviStatus.projection,o=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(this.region.getRegionLoc(),this.naviStatus.projection)),s=this.naviStatus.projDist,n=4*this.tailSize,a=0,e=YFM.Math.Matrix.scale(this.tailSize,0,0,0);a<=s;)i=YFM.Math.Vector.add(r,YFM.Math.Vector.scale(o,a)),t.setModelMatrix(YFM.Math.Matrix.postTranslate(e,i[0],i[1],i[2]+this.tailSize)),t.drawTriangles(this.tailMesh.getMeshVBO(),this.tailMesh.getMeshBufSize(),0),a+=n},_makeRouteVBO:function(){var t,e,i,r,o,s,n,a,h,u,l,c,M,f,d,p,g,m,v;for(f=0,p=0,d=0,n=this.region.getFloorCount(),u=0;u<n;u++)for(a=this.floorRouteList[u].getLength(),l=0;l<a;l++)for(M=this.floorRouteList[u].getSeg(l),M.startInstance=f,t=M.len,p=d,d=M.azimuth,h=Math.ceil(t/(2*this.size)),c=0==l?1:0;c<h&&(o=c/h,s=M.getPoint(o),!(c==h-1&&l<a-1&&(e=M.end[0]-s[0],i=M.end[1]-s[1],r=M.end[2]-s[2],e*e+i*i+r*r<=this.size*this.size/2)));c++)0==c&&l>0?(v=d-p,g=(d+p)/2,m=g,(v>Math.PI||v<-Math.PI)&&(m+=Math.PI)):m=d,this._makeShapeXY(this.routeVarray,s[0],s[1],s[2],this.size,m),f++;this.routeVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.routeVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.routeVarray,3),this.gl.STATIC_DRAW),this.routeBufferSize=this.routeVarray.length/2,this.routeVarray=[]},_initTail:function(){this.tailMesh=new IcosahedronMesh(this.gl,4)},_initRouteShape:function(){var t,e=[],i=[],r=[];e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(-1,-1,0)),e.push(YFM.Math.Vector.pos(0,0,0)),e.push(YFM.Math.Vector.pos(1,-1,0)),e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(0,1,.32)),e.push(YFM.Math.Vector.pos(-1,0,.32)),e.push(YFM.Math.Vector.pos(-1,-1,.32)),e.push(YFM.Math.Vector.pos(0,0,.32)),e.push(YFM.Math.Vector.pos(1,-1,.32)),e.push(YFM.Math.Vector.pos(1,0,.32)),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[3],e[0]),YFM.Math.Vector.sub(e[1],e[3]))),r.push(t),i.push({v0:0,v1:3,v2:1,n:0}),i.push({v0:1,v1:3,v2:2,n:0}),i.push({v0:0,v1:5,v2:3,n:0}),i.push({v0:3,v1:5,v2:4,n:0}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[6],e[9]),YFM.Math.Vector.sub(e[7],e[6]))),r.push(t),i.push({v0:9,v1:6,v2:7,n:1}),i.push({v0:7,v1:8,v2:9,n:1}),i.push({v0:9,v1:11,v2:6,n:1}),i.push({v0:9,v1:10,v2:11,n:1}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[3],e[2]),YFM.Math.Vector.sub(e[9],e[3]))),r.push(t),i.push({v0:2,v1:3,v2:9,n:2}),i.push({v0:9,v1:8,v2:2,n:2}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[4],e[3]),YFM.Math.Vector.sub(e[10],e[4]))),r.push(t),i.push({v0:3,v1:4,v2:10,n:3}),i.push({v0:10,v1:9,v2:3,n:3}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[5],e[4]),YFM.Math.Vector.sub(e[11],e[5]))),r.push(t),i.push({v0:4,v1:5,v2:11,n:4}),i.push({v0:11,v1:10,v2:4,n:4}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[6],e[0]),YFM.Math.Vector.sub(e[11],e[6]))),r.push(t),i.push({v0:0,v1:6,v2:11,n:5}),i.push({v0:11,v1:5,v2:0,n:5}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[1],e[0]),YFM.Math.Vector.sub(e[7],e[1]))),r.push(t),i.push({v0:0,v1:1,v2:7,n:6}),i.push({v0:7,v1:6,v2:0,n:6}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[2],e[1]),YFM.Math.Vector.sub(e[8],e[2]))),r.push(t),i.push({v0:1,v1:2,v2:8,n:7}),i.push({v0:8,v1:7,v2:1,n:7}),this.routeModel={v:e,f:i,n:r}},_makeShapeXY:function(t,e,i,r,o,s){var n=YFM.Math.Matrix.rotate3d(s,0,0,1,!0);n=YFM.Math.Matrix.postScale(n,o,0,0,0),n=YFM.Math.Matrix.postTranslate(n,e,i,r);var a,h,u,l,c,M=YFM.Math.Matrix.invert(n),f=YFM.Math.Matrix.transpose(M),d=[],p=[];for(a=this.routeModel.v.length,h=this.routeModel.f.length,u=this.routeModel.n.length,l=0;l<a;l++)d.push(YFM.Math.Matrix.mulVec(n,this.routeModel.v[l]));for(l=0;l<u;l++)p.push(YFM.Math.Matrix.mulVec(f,this.routeModel.n[l]));for(l=0;l<h;l++)c=this.routeModel.f[l],t.push(d[c.v0]),t.push(p[c.n]),t.push(d[c.v1]),t.push(p[c.n]),t.push(d[c.v2]),t.push(p[c.n])}},RouteSeg.prototype={constructor:RouteSeg,updateEnd:function(t){this.end=t,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth()},getPoint:function(t){return YFM.Math.Vector.add(this.start,YFM.Math.Vector.scale(this.segVec,t))},projection:function(t){var e=YFM.Math.Vector.sub(t,this.start),i=YFM.Math.Vector.dot3(e,this.segVec)/this.lenSQ;return i<=0?0:i>=1?1:i},_makeAzimuth:function(){var t=YFM.Math.Vector.vec(0,1,0),e=YFM.Math.Vector.normalize(this.segVec),i=YFM.Math.Vector.dot3(e,t),r=Math.acos(i);return e[0]>0&&(r=2*Math.PI-r),r}},FloorRoute.prototype={constructor:FloorRoute,addSeg:function(t,e){var i,r,o=new RouteSeg(t,e),s=YFM.Math.Vector.normalize(o.segVec);null!=this.lastSegVec?(i=YFM.Math.Vector.dot3(s,this.lastSegVec),Math.abs(i-1)<.01?(r=this.segList.pop(),r.updateEnd(e),this.segList.push(r)):this.segList.push(o)):this.segList.push(o),this.lastSegVec=s},makeNaviStatus:function(t,e){var i,r,o,s,n,a,h,u,l,c,M=this.segList.length;if(M<=0)t.validate=!1;else{for(t.validate=!0,a=Number.MAX_VALUE,h=0;h<M;h++)i=this.segList[h].projection(e),o=this.segList[h].getPoint(i),(n=YFM.Math.Vector.distanceSQ(e,o))<=a&&(a=n,s=o,u=h,r=i);for(i=u+r,i>this.implicitRec.maxT||null==this.implicitRec.maxPos||YFM.Math.Vector.distanceSQ(this.implicitRec.maxPos,s)>1e4?(this.implicitRec.maxT=i,this.implicitRec.maxPos=YFM.Math.Vector.vecClone(s),t.projection=s):t.projection=YFM.Math.Vector.vecClone(this.implicitRec.maxPos),l=YFM.Math.Vector.distance(t.projection,this.segList[u].start),t.startInstance=this.segList[u].startInstance+Math.floor(l/(2*this.size)),t.projDist=YFM.Math.Vector.distance(t.projection,e),t.serialDist=YFM.Math.Vector.distance(t.projection,this.segList[u].end),u+1<M?(t.nextSerialDist=this.segList[u+1].len,c=this.segList[u+1].azimuth-this.segList[u].azimuth,c<0&&(c+=2*Math.PI),c<=.175||c>=6.11?t.nextSug=YFM.Map.Navigate.NextSuggestion.FRONT:c<Math.PI?t.nextSug=YFM.Map.Navigate.NextSuggestion.LEFT:t.nextSug=YFM.Map.Navigate.NextSuggestion.RIGHT):(t.nextSerialDist=0,t.nextSug=YFM.Map.Navigate.NextSuggestion.ARRIVE),t.goalDist=t.serialDist,h=u+1;h<M;h++)t.goalDist+=this.segList[h].len;t.azimuth=this.segList[u].azimuth}},getLength:function(){return this.segList.length},getSeg:function(t){return this.segList[t]}},YFM.Map.DEFAULT_EXTRUDE_HEIGHT=10,YFM.Map.DEFAULT_QUICKPOLYGON_HEIGHT=12,Floor.prototype={constructor:Floor,getSize:function(){return this.loaded?this.mapSize:null},getAspect:function(){return{w:this.mapWidth,h:this.mapHeight}},isLoaded:function(){return this.loaded},setVOffset:function(t,e){var i=t*e;YFM.Math.Matrix.setTranslateZ(this.floorMat,i),this.penddingVOffset=null;var r=[];r.push(YFM.Math.Vector.pos(0,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,this.mapHeight,i)),r.push(YFM.Math.Vector.pos(0,this.mapHeight,i)),this.planePolygon=new PlanePolygon(r),this.icons=new FloorIcons(this.gl,this.region,this),this.quadTree=new FloorQuadTree(this,100),this.models=new FloorModels(this.gl,this.region,this,t/3)},insertUnit:function(t,e,i){0===t.type?this.quadTree.insertObject(t,this.index,e,i,2):this.icons.insertIcon(t,e,i,2)},insertModel:function(t,e,i,r,o,s){return t.setFloor(this),t.setModelMatrix(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.scale(i,0,0,0),90,1,0,0),e,0,0,1),r,this.mapHeight-o,s)),this.models.insertModel(t)},removeModel:function(t){return this.models.removeModel(t)},searchModel:function(t,e){return null!=this.models?this.models.rayCheck(t,e):[]},searchUnit:function(t,e,i){return null!=this.quadTree?this.quadTree.rayCheck(t,e,i):[]},searchIcon:function(t,e,i){return null!=this.icons?this.icons.rayCheck(t,e,i):[]},intersectionLine:function(t){return null==this.planePolygon?1024:this.planePolygon.intersectionLine(t,this.floorMat)},floorPos2Region:function(t,e){var i;return i=YFM.Math.Vector.pos(t,this.mapHeight-e,0),YFM.Math.Matrix.mulVec(this.floorMat,i)},getFloorMat:function(){return this.floorMat},frustumCheck:function(t){return null==this.quadTree?-1:this.quadTree.frustumCheck(t)},renderBase:function(t,e){this.loaded&&(t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setModelMatrix(YFM.Math.Matrix.mat()),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.ALWAYS),t.drawTriangles(this.trianglesVBO,this.trianglesSize),t.drawLines(this.borderVBO,this.borderSize),this.gl.disable(this.gl.DEPTH_TEST),e&&t.drawLines(this.dummyVBO,8,4))},renderExtrude:function(t,e,i,r){if(this.loaded){t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),r?t.setModelMatrix(YFM.Math.Matrix.mat()):t.setModelMatrix(YFM.Math.Matrix.translate(0,0,1-YFM.Map.DEFAULT_EXTRUDE_HEIGHT)),t.setLightPos(i);var o=YFM.Math.Matrix.mul(e,this.floorMat),s=YFM.Math.Matrix.transpose(o),n=YFM.Math.Matrix.invert(s);t.setNormalMatrix(n),this.extrude.render(t,r),this.quickPolygon.render(t)}},renderModels:function(t,e,i,r){this.models.renderModels(t,e,i,r)},renderIcons:function(t,e){this.icons.renderIcons(t,e)},renderMarkers:function(t,e,i,r,o){this.markers.render(t,e,i,r,o)},renderQuickIcons:function(t){this.quickIcons.render(t)},renderUnit:function(t,e){if(this.loaded){var i=this.quadTree.getContainLevel(t);this.quadTree.render(t,this._renderUnit,this,i)}},_renderUnit:function(t,e){var i=e.region.regionPos2Screen(t.pos);e.region._drawText(t.obj.text,i[0],i[1])},_load_svg:function(t,e){var i=t.gl,r=[],o=[],s=new DOMParser,n=s.parseFromString(e,"image/svg+xml");t._read_svg(n.documentElement,r,o),t.trianglesSize=r.length/2,t.borderSize=o.length/2,t.trianglesVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.trianglesVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(r,3),i.STATIC_DRAW),t.borderVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.borderVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(o,3),i.STATIC_DRAW),t.floorMat=YFM.Math.Matrix.translate(-t.mapWidth/2,-t.mapHeight/2,0),t.floorMat=YFM.Math.Matrix.postRotate3d(t.floorMat,-t.deflection,0,0,1);var a=[],h=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(4294935808),YFM.WebGL.Color.hexColorGreen(4294935808),YFM.WebGL.Color.hexColorBlue(4294935808));a.push(YFM.Math.Vector.pos(0,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,0,0)),a.push(h),t.dummyVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.dummyVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(a,3),i.STATIC_DRAW),t.extrude.buildExtrude(),t.loaded=!0},_read_svg:function(t,e,i){this.mapWidth=parseInt(t.getAttribute("width")),this.mapHeight=parseInt(t.getAttribute("height")),this.mapSize=Math.sqrt(this.mapWidth*this.mapWidth,this.mapHeight*this.mapHeight),console.log("Floor<%s> read svg width:%d, height:%d",this.id,this.mapWidth,this.mapHeight);for(var r=0;r<t.childNodes.length;r++){var o=t.childNodes.item(r);"g"==o.nodeName&&this._read_group(o,e,i)}},_read_group:function(t,e,i,r){var o,s=t.getAttribute("id");if(!this.regIcon.test(s)){o=!!r||this.regUnit.test(s);for(var n=0;n<t.childNodes.length;n++){var a=t.childNodes.item(n);1==a.nodeType&&("g"==a.nodeName?this._read_group(a,e,i,o):this._read_obj(a,e,i,o))}}},_pos2:function(t,e){var i=[];return i.push(t),i.push(e),i.push(1),i},_multVec3:function(t,e){var i,r,o,s=[];return i=e[0],r=e[1],o=e[2],s.push(i*t[0]+r*t[3]+o*t[6]),s.push(i*t[1]+r*t[4]+o*t[7]),s.push(i*t[2]+r*t[5]+o*t[8]),s},_read_obj:function(t,e,i,r){if("rect"==t.nodeName){var o=t.getAttribute("fill"),s=t.getAttribute("stroke"),n=parseFloat(t.getAttribute("width")),a=parseFloat(t.getAttribute("height")),h=parseFloat(t.getAttribute("x")),u=parseFloat(t.getAttribute("y")),l=[],c=this._parseMatrix(t.getAttribute("transform"));if(null!=c){var M=this._multVec3(c,this._pos2(h,u)),f=this._multVec3(c,this._pos2(h+n,u)),d=this._multVec3(c,this._pos2(h+n,u+a)),p=this._multVec3(c,this._pos2(h,u+a));l.push(M[0]),l.push(M[1]),l.push(f[0]),l.push(f[1]),l.push(d[0]),l.push(d[1]),l.push(p[0]),l.push(p[1])}else l.push(h),l.push(u),l.push(h+n),l.push(u),l.push(h+n),l.push(u+a),l.push(h),l.push(u+a);this._add_shape(l,o,s,e,i,r)}else if("polygon"==t.nodeName){var o=t.getAttribute("fill"),s=t.getAttribute("stroke"),l=t.getAttribute("points");this._add_shape(l,o,s,e,i,r)}},_add_shape:function(t,e,i,r,o,s){var n,a,h,u,l,c,M=new ArrayList,f=[];if(n=null!=i&&"none"!=i,n&&(i=i.replace("#",""),l=parseInt(i,16),a=(l>>16&255)/255,h=(l>>8&255)/255,u=(255&l)/255,c=YFM.Math.Vector.vec(a,h,u)),!(t instanceof Array)){for(var d=[],p=t.replace(/\s+/," ").split(" "),g=0;g<p.length;g++){var m=p[g].split(","),v=parseFloat(m[0]),F=parseFloat(m[1]);isNaN(v)||isNaN(F)||(d.push(v),d.push(F))}t=d}for(var x=t.length/2,_=0,y=0,g=0;g<x;g++){var v=t[2*g+0],F=t[2*g+1];s&&(_+=v,y+=F);var Y=YFM.Math.Vector.vec(v,F,0,1);if(f.push(Y),M.addHigh(Y),n){var R,V;g==x-1?(R=t[0],V=t[1]):(R=t[2*(g+1)+0],V=t[2*(g+1)+1]),s?this.extrude.addBorder(YFM.Math.Vector.pos(v,F,0),YFM.Math.Vector.pos(R,V,0),c):(o.push(YFM.Math.Vector.vec(v,F,0,1)),o.push(c),o.push(YFM.Math.Vector.vec(R,V,0,1)),o.push(c))}}if("none"!=e){e=e.replace("#","");var l=parseInt(e,16);a=(l>>16&255)/255,h=(l>>8&255)/255,u=(255&l)/255,this._triangulate_cut_ear(a,h,u,f,M,r,s)}},_parseMatrix:function(t){if(null==t)return null;var e=t.slice(7,-1).split(" ");if(e.length<6)return null;for(var i=[],r=0;r<e.length;r++)i.push(parseFloat(e[r]));var o=[];return o.push(i[0]),o.push(i[1]),o.push(0),o.push(i[2]),o.push(i[3]),o.push(0),o.push(i[4]),o.push(i[5]),o.push(1),o},_clock_wise:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,r){var o=this._is_left_turn(t,e,r),s=this._is_left_turn(e,i,r),n=this._is_left_turn(i,t,r);if(o&&s&&n)return!0;var a=this._is_right_turn(t,e,r),h=this._is_right_turn(e,i,r),u=this._is_right_turn(i,t,r);return!!(a&&h&&u)},_add_unit_extrude:function(t,e,i){},_triangulate_cut_ear:function(t,e,i,r,o,s,n){for(var a,h,t,u=this._clock_wise(r),l=YFM.Math.Vector.vec(t,e,i),c=[];o.size()>3;){var M,f,d=-1,p=0;do{if(p++,f=o.size(),p>=f)return console.log("bad input."),!1;if(d++,a=o.get(d%f),h=o.get((d+1)%f),t=o.get((d+2)%f),M=this._is_left_turn(a,h,t)^u)for(var g=o.getIter();g.hasNext();){var m=g.getNext();if(this._point_inside(a,h,t,m)){M=!1;break}}}while(!M);n?(c.push(a),c.push(h),c.push(t)):(s.push(a),s.push(l),s.push(h),s.push(l),s.push(t),s.push(l)),o.remove((d+1)%f)}return 3==o.size()&&(n?(c.push(o.get(0)),c.push(o.get(1)),c.push(o.get(2))):(s.push(o.get(0)),s.push(l),s.push(o.get(1)),s.push(l),s.push(o.get(2)),s.push(l))),n&&this.extrude.addExtrude(r,c,l),!0}},FloorExtrude.prototype={constructor:FloorExtrude,render:function(t,e){null!=this.extrudeTopVBO&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),e&&t.drawTriangles(this.extrudeSideVBO,this.extrudeSideSize),t.drawTriangles(this.extrudeTopVBO,this.extrudeTopSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)),null!=this.borderVBO&&(t.setLighting(0),this.gl.lineWidth(2),t.drawLines(this.borderVBO,this.borderSize),this.gl.lineWidth(1))},addBorder:function(t,e,i){t[2]+=this.height,e[2]+=this.height,this.borderVarray.push(t),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal),this.borderVarray.push(e),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal)},addExtrude:function(t,e,i){var r,o,s,n,a=e.length/3,h=t.length,u=YFM.Math.Vector.vec(0,0,1);for(r=0;r<a;r++){var l=[];l.push(e[3*r+0]),l.push(e[3*r+1]),l.push(e[3*r+2]),this._clock_wise_tri(l)?(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u)):(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u))}if(this._clock_wise_pts(t)){for(o=0;o<h-1;o++)s=t[o],n=t[o+1],this._putSideQuad(n,s,i);s=t[o],n=t[0],this._putSideQuad(n,s,i)}else{for(o=0;o<h-1;o++)s=t[o],n=t[o+1],this._putSideQuad(s,n,i);s=t[o],n=t[0],this._putSideQuad(s,n,i)}},buildExtrude:function(){this.extrudeTopVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopVarray,3),this.gl.STATIC_DRAW),this.extrudeTopSize=this.extrudeTopVarray.length/3,this.extrudeTopVarray=[],this.extrudeSideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideVarray,3),this.gl.STATIC_DRAW),this.extrudeSideSize=this.extrudeSideVarray.length/3,this.extrudeSideVarray=[],this.borderVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.borderVarray,3),this.gl.STATIC_DRAW),this.borderSize=this.borderVarray.length/3,this.borderVarray=[]},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_putSideQuad:function(t,e,i){var r,o,s,n,a,h=[],u=[];r=YFM.Math.Vector.pos(t[0],t[1],t[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]),s=YFM.Math.Vector.pos(e[0],e[1],e[2]+this.height),n=YFM.Math.Vector.pos(t[0],t[1],t[2]+this.height),h.push(r),h.push(s),h.push(o),u.push(r),u.push(n),u.push(s),a=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(o,r),YFM.Math.Vector.sub(s,o))),this.extrudeSideVarray.push(h[0]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(h[1]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(h[2]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[0]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[1]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[2]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a)}},FloorIcons.prototype={constructor:FloorIcons,insertIcon:function(t,e,i,r){this.quadTree.insertObject(t,this.floor.index,e,i,r)},rayCheck:function(t,e,i){return this.quadTree.rayCheck(t,e,i)},renderIcons:function(t,e){if(this.shader=e,null===this.iconTex){var i=this.region.getTexture("pubIcons");null!=i&&(this.iconTex=i.tex)}null!==this.iconTex&&(this.shader.bindTexture(this.iconTex),this.quadTree.render(t,this._renderIcon,this,1024))},_renderIcon:function(t,e){null!==e.iconTex&&(e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(e.quadVBO,6,6*t.obj.type))},_calcTexCoords:function(t,e,i){var r,o;r=Math.floor((i-1)/8),o=(i-1)%8;var s=[];s.push(YFM.Math.Vector.pos(1/8*o,1/8*r)),s.push(YFM.Math.Vector.pos(1/8*o,1/8*(r+1))),s.push(YFM.Math.Vector.pos(1/8*(o+1),1/8*(r+1))),s.push(YFM.Math.Vector.pos(1/8*(o+1),1/8*r)),t.push(e[0]),t.push(s[0]),t.push(e[1]),t.push(s[1]),t.push(e[2]),t.push(s[2]),t.push(e[0]),t.push(s[0]),t.push(e[2]),t.push(s[2]),t.push(e[3]),t.push(s[3])}},FloorQuickPolygon.prototype={constructor:FloorQuickPolygon,render:function(t){this.loaded&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.drawTriangles(this.quickPolygonVBO,this.quickPolygonSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE))},addQuickPolygon:function(t,e){var i,r=t.length,o=YFM.Math.Vector.vec(0,0,1),s=new ArrayList,n=YFM.WebGL.Color.getRGBVec(e);for(i=0;i<r;i++)s.addHigh(t[i]);var a=this._triangulate_cut_ear(t,s);if(null!==a){var h=a.length/3;for(i=0;i<h;i++){var u=[];u.push(a[3*i+0]),u.push(a[3*i+1]),u.push(a[3*i+2]),this._clock_wise_tri(u)?(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o)):(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(n),this.quickPolygonVarray.push(o))}}},buildQuickPolygon:function(){this.quickPolygonVarray.length<=0||(this.cleanQuickPolygon(),this.quickPolygonVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonVarray,3),this.gl.STATIC_DRAW),this.quickPolygonSize=this.quickPolygonVarray.length/3,this.quickPolygonVarray=[],this.loaded=!0)},cleanQuickPolygon:function(){if(null!==this.quickPolygonVBO){var t=this.quickPolygonVBO,e=this.gl;this.quickPolygonVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,r){var o=this._is_left_turn(t,e,r),s=this._is_left_turn(e,i,r),n=this._is_left_turn(i,t,r);if(o&&s&&n)return!0;var a=this._is_right_turn(t,e,r),h=this._is_right_turn(e,i,r),u=this._is_right_turn(i,t,r);return!!(a&&h&&u)},_triangulate_cut_ear:function(t,e){for(var i,r,o,s=this._clock_wise_pts(t),n=[];e.size()>3;){var a,h,u=-1,l=0;do{if(l++,h=e.size(),l>=h)return console.log("bad input."),null;if(u++,i=e.get(u%h),r=e.get((u+1)%h),o=e.get((u+2)%h),a=this._is_left_turn(i,r,o)^s)for(var c=e.getIter();c.hasNext();){var M=c.getNext();if(this._point_inside(i,r,o,M)){a=!1;break}}}while(!a);n.push(i),n.push(r),n.push(o),e.remove((u+1)%h)}return 3==e.size()&&(n.push(e.get(0)),n.push(e.get(1)),n.push(e.get(2))),n}},FloorQuickIcons.prototype={constructor:FloorQuickIcons,render:function(t){if(null!=this.pointsVBO){if(null===this.tex){var e=this.region.getTexture(this.texName);null!==e&&(this.tex=e.tex)}null!==this.tex&&(t.bindTexture(this.tex),t.drawPoints(this.pointsVBO,this.pointsSize))}},setTex:function(t){this.tex=null,this.texName=t},addPoint:function(t,e){var i=this.floor.floorPos2Region(t,e);i[2]+=this.height,this.pointsVarray.push(i)},clean:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]},buildPoints:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.pointsVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.pointsVarray,3),this.gl.STATIC_DRAW),this.pointsSize=this.pointsVarray.length,this.pointsVarray=[]}},FloorMarkers.prototype={constructor:FloorMarkers,quadVBO:null,cursor:0,shift:1e4,removeMarker:function(t){for(var e=null,i=!1,r=[],o=0;o<this.markerArray.length;o++)t===this.markerArray[o].id?(i=!0,e=this.markerArray[o]):r.push(this.markerArray[o]);return i&&(this.markerArray=r),e},insertMarker:function(t,e,i){var r=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,o=this.floor.floorPos2Region(e,i);return o[2]+=t.height,t.id=r,t.pos=o,this.markerArray.push(t),FloorMarkers.prototype.cursor++,r},insertTextureMarker:function(t,e,i,r,o,s){var n=this.floor.floorPos2Region(e,i);n[2]+=r;var a=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,h={type:1,id:a,texName:t,tex:null,texSize:YFM.Math.Vector.vec(10,10),envelop:YFM.Math.Vector.vec(0),pos:n,distSQ:0,height:r,offsetX:o,offsetY:s};return this.markerArray.push(h),FloorMarkers.prototype.cursor++,a},insertGeometryMarker:function(t,e,i,r,o,s){var n;if(t===YFM.Mesh.CATEGORY_TETRHEDRON)n=new TetrahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_HEXADEDRON)n=new HexahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_OCTAHEDRON)n=new OctahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_DODECAHEDRON)n=new DodecahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_ICOSAHEDRON)n=new IcosahedronMesh(this.gl,0);else{if(t!==YFM.Mesh.CATEGORY_SPHERE)return null;n=new IcosahedronMesh(this.gl,4)}var a=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(e),YFM.WebGL.Color.hexColorGreen(e),YFM.WebGL.Color.hexColorBlue(e)),h=this.floor.floorPos2Region(r,o);h[2]+=s;var u=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,l={type:0,id:u,mesh:n,angle:0,bounce:0,bstep:i/20,size:i,color:a,height:s,pos:h};return this.markerArray.push(l),FloorMarkers.prototype.cursor++,u},render:function(t,e,i,r,o){var s,n,a,h;this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var u=YFM.Math.Matrix.transpose(r),l=YFM.Math.Matrix.invert(u);i.setLightPos(this.light),i.setNormalMatrix(l);var c=YFM.Math.Matrix.invert(r),M=YFM.Math.Matrix.mulVec(c,this.orgPos),f=this.markerIMinPQ.getSize();for(this.markerArray.length>f?this.markerIMinPQ.setSize(Math.floor(1.5*this.markerArray.length)):this.markerArray.length<f/2?this.markerIMinPQ.setSize(this.markerArray.length):this.markerIMinPQ.clean(),n=0;n<this.markerArray.length;n++)s=this.markerArray[n],t.containCheckPoint(s.pos)?0===s.type?this._renderMesh(i,s):1===s.type&&(a=YFM.Math.Vector.distanceSQ(s.pos,M),s.distSQ=a,this.markerIMinPQ.insert(n,a)):s.type;for(this.markerSorted=[],h=this.markerIMinPQ.getCount(),n=0;n<h;n++)this.markerSorted.push(this.markerIMinPQ.deleteMin());for(n=h-1;n>=0;n--)s=this.markerArray[this.markerSorted[n]],1===s.type&&this._renderTex(o,e,s);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},findMarker:function(t,e){for(var i,r,i=0;i<this.markerSorted.length;i++)if(r=this.markerArray[this.markerSorted[i]],this._envelopCheck(r.envelop,t,e))return{id:r.id,dist:r.distSQ};return null},_envelopCheck:function(t,e,i){return e>=t[0]&&e<=t[2]&&i>=t[1]&&i<=t[3]},_renderMesh:function(t,e){t.useProgram();var i=YFM.Math.Matrix.scale(e.size,0,0,0);i=YFM.Math.Matrix.postRotateXY(i,e.angle,0,0);var r=YFM.Math.Matrix.postTranslate(i,e.pos[0],e.pos[1],e.pos[2]+e.bounce);t.setModelMatrix(r),t.setColor(e.color);var o=e.mesh.getMeshVBO(),s=e.mesh.getMeshBufSize();t.drawTriangles(o,s,0),e.angle+=1,e.bounce+=e.bstep,(e.bounce>e.size||e.bounce<0)&&(e.bstep=-e.bstep)},_renderTex:function(t,e,i){if(null===i.tex){var r=this.region.getTexture(i.texName);null!==r&&(i.tex=r.tex,i.texSize[0]=r.w/2,i.texSize[1]=r.h/2)}if(null!==i.tex){var o,s,n=YFM.Math.Matrix.mulVec(t,i.pos);o=YFM.gRegion.glCanvas.width/2,s=YFM.gRegion.glCanvas.height/2,n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],n[0]*=o,n[1]*=s,e.useProgram(),e.bindTexture(i.tex),i.envelop[0]=o+n[0]-i.offsetX-i.texSize[0],i.envelop[1]=s-(n[1]+i.offsetY+i.texSize[1]),i.envelop[2]=o+n[0]+i.offsetX+i.texSize[0],i.envelop[3]=s-(n[1]+i.offsetY-i.texSize[1]);var a=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(i.texSize,0,0,0),n[0]-i.offsetX,n[1]+i.offsetY,0),this.region.camera.getRoll(),n[0],n[1]);e.setModelMatrix(a),this.gl.depthMask(!1),e.drawTriangles(FloorMarkers.prototype.quadVBO,6,0),this.gl.depthMask(!0)}},_initQuad:function(t){var e=[],i=[],r=[];r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0)),r.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(r[0]),e.push(i[1]),e.push(r[1]),e.push(i[2]),e.push(r[2]),e.push(i[0]),e.push(r[0]),e.push(i[2]),e.push(r[2]),e.push(i[3]),e.push(r[3]),FloorMarkers.prototype.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,FloorMarkers.prototype.quadVBO),
t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},FloorModels.prototype={constructor:FloorModels,removeModel:function(t){return this.quadTree.removeObject(t)},insertModel:function(t){return this.quadTree.insertObjectOBB(t,t.obb)},rayCheck:function(t,e){return this.quadTree.rayCheckOBB(t,e)},renderModels:function(t,e,i,r){this.shader=e,this.vrfMat=YFM.Math.Matrix.mul(i,this.floor.getFloorMat()),e.setFloorMatrix(this.floor.getFloorMat()),e.setLightPos(r),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.quadTree.render(t,this._renderModel,this,1024),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderModel:function(t,e){t.obj.render(e.shader,e.vrfMat)}},YFM.Math=function(){var t=function(t,e,i){return Math.max(e,Math.min(i,t))},e=function(t,e,i,r,o){return r+(t-e)/(i-e)*(o-r)},i=function(t){return 2*t*Math.PI/360},r=function(t){return 360*t/(2*Math.PI)},o=function(t){return[].concat.apply([],Array.prototype.slice.apply(t))},s=function(t,e){return Math.abs(t-e)<=1e-5||(Math.abs(t)>Math.abs(e)?Math.abs((t-e)/t):Math.abs((t-e)/e))<=1e-8},n=function(t){return Math.abs(t)>1e-20};return{clamp:t,map:e,deg2Radian:i,radian2Deg:r,flatten:function(t,e){var i,r=t.length,o=!1;Array.isArray(t[0])&&(o=!0,null==e?(r*=t[0].length,i=t[0].length):(r*=e,i=e));var s=new Float32Array(r);if(o)for(var n=0,a=0;a<t.length;++a)for(var h=0;h<i;++h)s[n++]=t[a][h];else for(var a=0;a<t.length;++a)s[a]=t[a];return s},argumentsToArray:o,floatEquals:s,floatNotZero:n,vf2str:function(t,e){for(var i="[ ",r=t.length,o=0;o<r;o++)i+=t[o].toFixed(e),i+=", ";return i+="]"},lerp:function(t,e,i){return t+(e-t)*i}}}(),YFM.Math.Vector=function(){var t=function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)},e=function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(0)}return t.splice(0,4)},i=function(t){return t.slice(0)},r=function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i.push(t[3]+e[3]),i},o=function(t,e){t[0]=t[0]+e[0],t[1]=t[1]+e[1],t[2]=t[2]+e[2],t[3]=t[3]+e[3]},s=function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i.push(t[3]-e[3]),i},n=function(t,e){t[0]=t[0]-e[0],t[1]=t[1]-e[1],t[2]=t[2]-e[2],t[3]=t[3]-e[3]},a=function(t,e){var i=[];return i.push(e*t[0]),i.push(e*t[1]),i.push(e*t[2]),i.push(e*t[3]),i},h=function(t,e){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e},u=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},l=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},c=function(t,e){var i=[];return i.push(-e[1]*t[2]+e[2]*t[1]),i.push(e[0]*t[2]-e[2]*t[0]),i.push(-e[0]*t[1]+e[1]*t[0]),i.push(0),i},M=function(t){return Math.sqrt(u(t,t))},f=function(t){return Math.sqrt(l(t,t))},d=function(t){return u(t,t)},p=function(t){return l(t,t)},g=function(t,e){var i=s(e,t);return u(i,i)},m=function(t,e){var i=s(e,t);return Math.sqrt(u(i,i))};return{pos:t,vec:e,vecClone:i,add:r,addTo:o,sub:s,subTo:n,scale:a,scaleTo:h,dot3:u,dot4:l,cross:c,norm3:M,norm4:f,norm3SQ:d,norm4SQ:p,normalize:function(t){var e=[],i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return i>0?(e.push(t[0]/i),e.push(t[1]/i),e.push(t[2]/i),e.push(t[3])):(e.push(0),e.push(0),e.push(0),e.push(t[3])),e},limitTo:function(t,e){var i=u(t,t);if(i>e*e){var r=Math.sqrt(i);t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=e,t[1]*=e,t[2]*=e}},limitToRange:function(t,e,i){var r,o=u(t,t);o>i*i?(r=Math.sqrt(o),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=i,t[1]*=i,t[2]*=i):o<e*e&&(r=Math.sqrt(o),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=i,t[1]*=i,t[2]*=i)},mix:function(t,e,i){var r=[];return r.push((1-i)*t[0]+i*e[0]),r.push((1-i)*t[1]+i*e[1]),r.push((1-i)*t[2]+i*e[2]),r.push((1-i)*t[3]+i*e[3]),r},distanceSQ:g,distance:m}}(),YFM.Math.Matrix=function(){var t=function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t},e=function(t){return t.slice(0)},i=function(e,i,r,o,s){var n,a,h,u=t();if(n=s?e:YFM.Math.deg2Radian(e),a=Math.cos(n),h=Math.sin(n),u[3]=0,u[7]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,1==i&&0==r&&0==o)u[5]=a,u[10]=a,u[6]=h,u[9]=-h,u[1]=0,u[2]=0,u[4]=0,u[8]=0,u[0]=1;else if(0==i&&1==r&&0==o)u[0]=a,u[10]=a,u[8]=h,u[2]=-h,u[1]=0,u[4]=0,u[6]=0,u[9]=0,u[5]=1;else if(0==i&&0==r&&1==o)u[0]=a,u[5]=a,u[1]=h,u[4]=-h,u[2]=0,u[6]=0,u[8]=0,u[9]=0,u[10]=1;else{var l=Math.sqrt(i*i+r*r+o*o);if(1!=l){var c=1/l;i*=c,r*=c,o*=c}var M=1-a,f=i*r,d=r*o,p=o*i,g=i*h,m=r*h,v=o*h;u[0]=i*i*M+a,u[4]=f*M-v,u[8]=p*M+m,u[1]=f*M+v,u[5]=r*r*M+a,u[9]=d*M-g,u[2]=p*M-m,u[6]=d*M+g,u[10]=o*o*M+a}return u},r=function(t,e,i,r){var o,s,n,a=[];return o=r?t:YFM.Math.deg2Radian(t),s=Math.cos(o),n=Math.sin(o),a.push(s),a.push(n),a.push(0),a.push(0),a.push(-n),a.push(s),a.push(0),a.push(0),a.push(0),a.push(0),a.push(1),a.push(0),a.push(e*(1-s)+i*n),a.push(i*(1-s)-e*n),a.push(0),a.push(1),a},o=function(t,e,i){var r,o,s,n,a,h,u,l=[];return r=i?t:YFM.Math.deg2Radian(t),o=Math.cos(r),s=Math.sin(r),n=1-o,l.push(NaN*n+o),l.push(NaN*n+u*s),l.push(NaN*n-h*s),l.push(0),l.push(NaN*n-u*s),l.push(NaN*n+o),l.push(NaN*n+a*s),l.push(0),l.push(NaN*n+h*s),l.push(NaN*n-a*s),l.push(NaN*n+o),l.push(0),l.push(0),l.push(0),l.push(0),l.push(1),l},s=function(t,e,i){var r=[];return r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(t),r.push(e),r.push(i),r.push(1),r},n=function(t,e){t[14]=e},a=function(t,e,i,r){var o=[];return o.push(t),o.push(0),o.push(0),o.push(0),o.push(0),o.push(t),o.push(0),o.push(0),o.push(0),o.push(0),o.push(t),o.push(0),o.push(e*(1-t)),o.push(i*(1-t)),o.push(r*(1-t)),o.push(1),o},h=function(t,e,i,r){var o=[];return o.push(t[0]),o.push(0),o.push(0),o.push(0),o.push(0),o.push(t[1]),o.push(0),o.push(0),o.push(0),o.push(0),o.push(t[2]),o.push(0),o.push(e*(1-t[0])),o.push(i*(1-t[1])),o.push(r*(1-t[2])),o.push(1),o},u=function(t,e){var i,r,o,s,n,a,h,u=[];for(a=t.slice(0),h=e.slice(0),n=0;n<4;n++)i=h[4*n+0],r=h[4*n+1],o=h[4*n+2],s=h[4*n+3],u.push(i*a[0]+r*a[4]+o*a[8]+s*a[12]),u.push(i*a[1]+r*a[5]+o*a[9]+s*a[13]),u.push(i*a[2]+r*a[6]+o*a[10]+s*a[14]),u.push(i*a[3]+r*a[7]+o*a[11]+s*a[15]);return u},l=function(t,e,i,r){var o,s,n;for(s=0;s<t;s++)e[s]=r[t-1][s];for(o=t-1;o>0;o--){var a=0,h=0;for(n=0;n<o;n++)a+=Math.abs(e[n]);if(0==a)for(i[o]=e[o-1],s=0;s<o;s++)e[s]=r[o-1][s],r[o][s]=0,r[s][o]=0;else{for(n=0;n<o;n++)e[n]/=a,h+=e[n]*e[n];var u=e[o-1],l=Math.sqrt(h);for(u>0&&(l=-l),i[o]=a*l,h-=u*l,e[o-1]=u-l,s=0;s<o;s++)i[s]=0;for(s=0;s<o;s++){for(u=e[s],r[s][o]=u,l=i[s]+r[s][s]*u,n=s+1;n<=o-1;n++)l+=r[n][s]*e[n],i[n]+=r[n][s]*u;i[s]=l}for(u=0,s=0;s<o;s++)i[s]/=h,u+=i[s]*e[s];var c=u/(h+h);for(s=0;s<o;s++)i[s]-=c*e[s];for(s=0;s<o;s++){for(u=e[s],l=i[s],n=s;n<=o-1;n++)r[n][s]-=u*i[n]+l*e[n];e[s]=r[o-1][s],r[o][s]=0}}e[o]=h}for(o=0;o<t-1;o++){r[t-1][o]=r[o][o],r[o][o]=1;var h=e[o+1];if(0!=h){for(n=0;n<=o;n++)e[n]=r[n][o+1]/h;for(s=0;s<=o;s++){var l=0;for(n=0;n<=o;n++)l+=r[n][o+1]*r[n][s];for(n=0;n<=o;n++)r[n][s]-=l*e[n]}}for(n=0;n<=o;n++)r[n][o+1]=0}for(s=0;s<t;s++)e[s]=r[t-1][s],r[t-1][s]=0;r[t-1][t-1]=1,i[0]=0},c=function(t,e,i,r){var o,s,n,a,h,u;for(o=1;o<t;o++)i[o-1]=i[o];i[t-1]=0;var l=0,c=0,M=Math.pow(2,-52);for(a=0;a<t;a++){for(c=Math.max(c,Math.abs(e[a])+Math.abs(i[a])),h=a;h<t&&!(Math.abs(i[h])<=M*c);)h++;if(h>a){u=0;do{if((u+=1)>=7)break;var f=e[a],d=(e[a+1]-f)/(2*i[a]),p=Math.hypot(d,1);d<0&&(p=-p),e[a]=i[a]/(d+p),e[a+1]=i[a]*(d+p);var g=e[a+1],m=f-e[a];for(o=a+2;o<t;o++)e[o]-=m;l+=m,d=e[h];var v=1,F=v,x=v,_=i[a+1],y=0,Y=0;for(o=h-1;o>=a;o--)for(x=F,F=v,Y=y,f=v*i[o],m=v*d,p=Math.hypot(d,i[o]),i[o+1]=y*p,y=i[o]/p,v=d/p,d=v*e[o]-y*f,e[o+1]=m+y*(v*f+y*e[o]),n=0;n<t;n++)m=r[n][o+1],r[n][o+1]=y*r[n][o]+v*m,r[n][o]=v*r[n][o]-y*m;d=-y*Y*x*_*i[a]/g,i[a]=y*d,e[a]=v*d}while(Math.abs(i[a])>M*c)}e[a]=e[a]+l,i[a]=0}for(o=0;o<t-1;o++){n=o;var d=e[o];for(s=o+1;s<t;s++)e[s]<d&&(n=s,d=e[s]);if(n!=o)for(e[n]=e[o],e[o]=d,s=0;s<t;s++)d=r[s][o],r[s][o]=r[s][n],r[s][n]=d}};return{mat:t,matClone:e,rotate3d:i,rotateXY:r,translate:s,rotateAxis:o,scale:a,scaleXYZ:h,mul:u,mulVec:function(t,e){var i,r,o,s,n=[];return i=e[0],r=e[1],o=e[2],s=e[3],n.push(i*t[0]+r*t[4]+o*t[8]+s*t[12]),n.push(i*t[1]+r*t[5]+o*t[9]+s*t[13]),n.push(i*t[2]+r*t[6]+o*t[10]+s*t[14]),n.push(i*t[3]+r*t[7]+o*t[11]+s*t[15]),n},postTranslate:function(t,e,i,r){var o=s(e,i,r);return u(o,t)},postRotateXY:function(t,e,i,o,s){var n=r(e,i,o,s);return u(n,t)},postRotate3d:function(t,e,r,o,s,n){var a=i(e,r,o,s,n);return u(a,t)},postScale:function(t,e,i,r,o){var s=a(e,i,r,o);return u(s,t)},preTranslate:function(t,e,i,r){var o=s(e,i,r);return u(t,o)},preRotateXY:function(t,e,i,o,s){var n=r(e,i,o,s);return u(t,n)},preRotate3d:function(t,e,r,o,s,n){var a=i(e,r,o,s,n);return u(t,a)},preScale:function(t,e,i,r,o){var s=a(e,i,r,o);return u(t,s)},transpose:function(t){var e=[];return e.push(t[0]),e.push(t[4]),e.push(t[8]),e.push(t[12]),e.push(t[1]),e.push(t[5]),e.push(t[9]),e.push(t[13]),e.push(t[2]),e.push(t[6]),e.push(t[10]),e.push(t[14]),e.push(t[3]),e.push(t[7]),e.push(t[11]),e.push(t[15]),e},invert:function(t){var e=t[0],i=t[1],r=t[2],o=t[3],s=t[4],n=t[5],a=t[6],h=t[7],u=t[8],l=t[9],c=t[10],M=t[11],f=t[12],d=t[13],p=t[14],g=t[15],m=e*n-i*s,v=e*a-r*s,F=e*h-o*s,x=i*a-r*n,_=i*h-o*n,y=r*h-o*a,Y=u*d-l*f,R=u*p-c*f,V=u*g-M*f,b=l*p-c*d,P=l*g-M*d,T=c*g-M*p,A=m*T-v*P+F*b+x*V-_*R+y*Y;if(0!=A){var L=[];return L.push((n*T-a*P+h*b)/A),L.push((r*P-i*T-o*b)/A),L.push((d*y-p*_+g*x)/A),L.push((c*_-l*y-M*x)/A),L.push((a*V-s*T-h*R)/A),L.push((e*T-r*V+o*R)/A),L.push((p*F-f*y-g*v)/A),L.push((u*y-c*F+M*v)/A),L.push((s*P-n*V+h*Y)/A),L.push((i*V-e*P-o*Y)/A),L.push((f*_-d*F+g*m)/A),L.push((l*F-u*_-M*m)/A),L.push((n*R-s*b-a*Y)/A),L.push((e*b-i*R+r*Y)/A),L.push((d*v-f*x-p*m)/A),L.push((u*x-l*v+c*m)/A),L}return null},orthographic:function(e,i,r,o,s,n){var a=t(),h=1/(i-e),u=1/(o-r),l=1/(n-s),c=2*h,M=2*u,f=-2*l,d=-(i+e)*h,p=-(o+r)*u,g=-(n+s)*l;return a[0]=c,a[5]=M,a[10]=f,a[12]=d,a[13]=p,a[14]=g,a[15]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a},perspective:function(t,e,i,r){var o=[],s=1/Math.tan(t*(Math.PI/360)),n=1/(i-r);return o.push(s/e),o.push(0),o.push(0),o.push(0),o.push(0),o.push(s),o.push(0),o.push(0),o.push(0),o.push(0),o.push((r+i)*n),o.push(-1),o.push(0),o.push(0),o.push(2*r*i*n),o.push(0),o},setTranslateZ:n,covariance3x3:function(t){var e,i,r,o,s,n,a,h,u,l,c,M,f,d,p=[];for(h=t.length,o=0,s=0,n=0,a=0;a<h;a++)o+=t[a][0],s+=t[a][1],n+=t[a][2];for(o/=h,s/=h,n/=h,u=0,l=0,c=0,M=0,f=0,d=0,a=0;a<h;a++)e=t[a][0],i=t[a][1],r=t[a][2],u+=(e-o)*(e-o),l+=(i-s)*(i-s),c+=(r-n)*(r-n),M+=(e-o)*(i-s),f+=(e-o)*(r-n),d+=(i-s)*(r-n);return u/=h,l/=h,c/=h,M/=h,f/=h,d/=h,p.push(u),p.push(M),p.push(f),p.push(M),p.push(l),p.push(d),p.push(f),p.push(d),p.push(c),p},eig3x3:function(t){var e,i,r,o=[],s=[];if(t[3]!=t[1]||t[6]!=t[2]||t[7]!=t[5])throw new Error("matrix is not symmetric");return e=[],e.push(new Array(t[0],t[3],t[6])),e.push(new Array(t[1],t[4],t[7])),e.push(new Array(t[2],t[5],t[8])),i=new Array(0,0,0),r=new Array(0,0,0),l(3,i,r,e),c(3,i,r,e),o.push(i[0]),o.push(i[1]),o.push(i[2]),s.push(e[0][0]),s.push(e[1][0]),s.push(e[2][0]),s.push(e[0][1]),s.push(e[1][1]),s.push(e[2][1]),s.push(e[0][2]),s.push(e[1][2]),s.push(e[2][2]),{value:o,vec:s}},eulerParamExtract:function(t){var e,i,r;return e=Math.atan2(-t[2],t[10]),i=Math.asin(t[6]),r=Math.atan2(-t[4],t[5]),new Euler(i,e,r)},eulerParamExtractX:function(t){return Math.asin(t[6])},eulerParamExtractY:function(t){return Math.atan2(-t[2],t[10])},eulerParamExtractZ:function(t){return Math.atan2(-t[4],t[5])},rotationFromQuaternion:function(e){var i=t(),r=e.x,o=e.y,s=e.z,n=e.w,a=r+r,h=o+o,u=s+s,l=r*a,c=r*h,M=r*u,f=o*h,d=o*u,p=s*u,g=n*a,m=n*h,v=n*u;return i[0]=1-(f+p),i[1]=c-v,i[2]=M+m,i[3]=0,i[4]=c+v,i[5]=1-(l+p),i[6]=d-g,i[7]=0,i[8]=M-m,i[9]=d+g,i[10]=1-(l+f),i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}}}(),Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="ZXY",Euler.prototype={constructor:Euler,setFromMatrix:function(t,e,i){var r=YFM.Math.clamp,o=t[0],s=t[4],n=t[8],a=t[1],h=t[5],u=t[9],l=t[2],c=t[6],M=t[10];return e=e||this.order,"XYZ"===e?(this.y=Math.asin(r(n,-1,1)),Math.abs(n)<.99999?(this.x=Math.atan2(-u,M),this.z=Math.atan2(-s,o)):(this.x=Math.atan2(c,h),this.z=0)):"YXZ"===e?(this.x=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(n,M),this.z=Math.atan2(a,h)):(this.y=Math.atan2(-l,o),this.z=0)):"ZXY"===e?(this.x=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(this.y=Math.atan2(-l,M),this.z=Math.atan2(-s,h)):(this.y=0,this.z=Math.atan2(a,o))):"ZYX"===e?(this.y=Math.asin(-r(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(c,M),this.z=Math.atan2(a,o)):(this.x=0,this.z=Math.atan2(-s,h))):"YZX"===e?(this.z=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-u,h),this.y=Math.atan2(-l,o)):(this.x=0,this.y=Math.atan2(n,M))):"XZY"===e?(this.z=Math.asin(-r(s,-1,1)),Math.abs(s)<.99999?(this.x=Math.atan2(c,h),this.y=Math.atan2(n,o)):(this.x=Math.atan2(-u,M),this.y=0)):console.warn("setFromRotationMatrix() given unsupported order: "+e),this.order=e,this}},Quaternion.prototype={constructor:Quaternion,toString:function(t){var e="(";return e=e+this.x.toFixed(t)+", ",e=e+this.y.toFixed(t)+", ",e=e+this.z.toFixed(t)+", ",e=e+this.w.toFixed(t)+")"},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t){var e=t.x,i=t.y,r=t.z,o=t.order,s=Math.cos,n=Math.sin,a=s(e/2),h=s(i/2),u=s(r/2),l=n(e/2),c=n(i/2),M=n(r/2);return"XYZ"===o?(this.x=l*h*u+a*c*M,this.y=a*c*u-l*h*M,this.z=a*h*M+l*c*u,this.w=a*h*u-l*c*M):"YXZ"===o?(this.x=l*h*u+a*c*M,this.y=a*c*u-l*h*M,this.z=a*h*M-l*c*u,this.w=a*h*u+l*c*M):"ZXY"===o?(this.x=l*h*u-a*c*M,this.y=a*c*u+l*h*M,this.z=a*h*M+l*c*u,this.w=a*h*u-l*c*M):"ZYX"===o?(this.x=l*h*u-a*c*M,this.y=a*c*u+l*h*M,this.z=a*h*M-l*c*u,this.w=a*h*u+l*c*M):"YZX"===o?(this.x=l*h*u+a*c*M,this.y=a*c*u+l*h*M,this.z=a*h*M-l*c*u,this.w=a*h*u-l*c*M):"XZY"===o&&(this.x=l*h*u-a*c*M,this.y=a*c*u-l*h*M,this.z=a*h*M+l*c*u,this.w=a*h*u+l*c*M),this},setFromAxisAngle:function(t,e){var i=e/2,r=Math.sin(i);return this.x=t[0]*r,this.y=t[1]*r,this.z=t[2]*r,this.w=Math.cos(i),this},setFromRotationMatrix:function(t){var e,i=t[0],r=t[4],o=t[8],s=t[1],n=t[5],a=t[9],h=t[2],u=t[6],l=t[10],c=i+n+l;return c>0?(e=.5/Math.sqrt(c+1),this.w=.25/e,this.x=(u-a)*e,this.y=(o-h)*e,this.z=(s-r)*e):i>n&&i>l?(e=2*Math.sqrt(1+i-n-l),this.w=(u-a)/e,this.x=.25*e,this.y=(r+s)/e,this.z=(o+h)/e):n>l?(e=2*Math.sqrt(1+n-i-l),this.w=(o-h)/e,this.x=(r+s)/e,this.y=.25*e,this.z=(a+u)/e):(e=2*Math.sqrt(1+l-i-n),this.w=(s-r)/e,this.x=(o+h)/e,this.y=(a+u)/e,this.z=.25*e),this},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},multiply:function(t){return this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t.x,r=t.y,o=t.z,s=t.w,n=e.x,a=e.y,h=e.z,u=e.w;return this.x=i*u+s*n+r*h-o*a,this.y=r*u+s*a+o*n-i*h,this.z=o*u+s*h+i*a-r*n,this.w=s*u-i*n-r*a-o*h,this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this.x,r=this.y,o=this.z,s=this.w,n=s*t.w+i*t.x+r*t.y+o*t.z;if(n<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,n=-n):this.copy(t),n>=1)return this.w=s,this.x=i,this.y=r,this.z=o,this;var a=Math.sqrt(1-n*n);if(Math.abs(a)<.001)return this.w=.5*(s+this.w),this.x=.5*(i+this.x),this.y=.5*(r+this.y),this.z=.5*(o+this.z),this;var h=Math.atan2(a,n),u=Math.sin((1-e)*h)/a,l=Math.sin(e*h)/a;return this.w=s*u+this.w*l,this.x=i*u+this.x*l,this.y=r*u+this.y*l,this.z=o*u+this.z*l,this}},YFM.Math.Line=function(){var t=function(t,e,i,r,o,s){var n=[];return n.push(t),n.push(e),n.push(i),n.push(1),n.push(r),n.push(o),n.push(s),n.push(0),n},e=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]),i.push(e[1]),i.push(e[2]),i.push(0),i},i=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]-t[0]),i.push(e[1]-t[1]),i.push(e[2]-t[2]),i.push(0),i},r=function(t,e){return YFM.Math.Vector.pos(t[0]+t[4]*e,t[1]+t[5]*e,t[2]+t[6]*e)},o=function(t,e){var i=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.vec(t[4],t[5],t[6]),o=YFM.Math.Vector.sub(e,i),s=YFM.Math.Vector.dot3(o,r)/YFM.Math.Vector.dot3(r,r);return s<=0?i:s>=1?YFM.Math.Vector.add(i,r):YFM.Math.Vector.pos(t[0]+t[4]*s,t[1]+t[5]*s,t[2]+t[6]*s)},s=function(t,e,i,r){var o,s,n,a,h,u;return s=YFM.Math.Vector.pos(e,i,r),n=YFM.Math.Vector.sub(s,t),o=YFM.Math.Vector.vec(t[4],t[5],t[6]),h=YFM.Math.Vector.dot3(n,o),h*=h,a=YFM.Math.Vector.norm3SQ(n),u=YFM.Math.Vector.norm3SQ(o),a-h/u},n=function(t,e,i,r){return Math.sqrt(s(t,e,i,r))},a=function(t,e){var i,r,o,s,n,a,h,u,l,c,M=[],f=[],d=[];return l=YFM.Math.Vector.vec(t[4],t[5],t[6]),c=YFM.Math.Vector.vec(e[4],e[5],e[6]),o=YFM.Math.Vector.dot3(l,c),a=YFM.Math.Vector.norm3SQ(l),h=YFM.Math.Vector.norm3SQ(c),r=o*o-a*h,i=YFM.Math.floatEquals(r,0),0==i&&(u=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.dot3(u,l),n=YFM.Math.Vector.dot3(u,c),f.push(s),f.push(n),M.push(-YFM.Math.Vector.norm3SQ(c)),M.push(-o),M.push(o),M.push(YFM.Math.Vector.norm3SQ(l)),d.push(f[0]*M[0]+f[1]*M[2]),d.push(f[0]*M[1]+f[1]*M[3]),d[0]/=r,d[1]/=r),{parallel:i,t:d}};return{line:t,lineSV:e,linePP:i,getPoint:r,projection:o,distancePointSQ:s,distancePoint:n,distanceLinesRaw:a,distanceLines:function(t,e){var i,o,s,h;return o=a(t,e),o.parallel?i=n(t,e[0],e[1],e[2]):(s=r(t,o.t[0]),h=r(e,o.t[1]),i=YFM.Math.Vector.distance(s,h)),{parallel:void 0,distance:i}}}}(),YFM.Math.Plane=function(){var t=function(t,e,i,r,o,s){var n=YFM.Math.Vector.pos(t,e,i),a=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(r,o,s)),h=-YFM.Math.Vector.dot3(a,n);return a[3]=h,a};return{plane:t,planePN:function(e,i){return t(e[0],e[1],e[2],i[0],i[1],i[2])},planeRaw:function(t,e,i,r){return YFM.Math.Vector.vec(t,e,i,r)},transform:function(t,e){var i,r=YFM.Math.Matrix.invert(e);if(null==r)throw new Error("transform a plane with a singular matrix");return i=YFM.Math.Matrix.transpose(r),YFM.Math.Matrix.mulVec(i,t)},distance:function(t,e,i,r){var o=YFM.Math.Vector.pos(e,i,r);return YFM.Math.Vector.dot4(t,o)},intersectionLine:function(t,e){var i,r,o=YFM.Math.Vector.pos(e[0],e[1],e[2]),s=YFM.Math.Vector.vec(e[4],e[5],e[6]);if(i=YFM.Math.Vector.dot4(t,o),r=YFM.Math.Vector.dot4(t,s),YFM.Math.floatEquals(r,0))throw new Error("Calc intersection of a line parallel to a plane");return-i/r},intersectionPlane:function(t,e){var i,r,o,s,n;if(s=YFM.Math.Vector.cross(t,e),i=Math.floatEquals(0,YFM.Math.Vector.norm3(s)))return{parallel:i};if(r=[],r.push(t[0]),r.push(e[0]),r.push(s[0]),r.push(0),r.push(t[1]),r.push(e[1]),r.push(s[1]),r.push(0),r.push(t[2]),r.push(e[2]),r.push(s[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(o=YFM.Math.Matrix.invert(r)))throw new Error("nv matrix is singular");return n=YFM.Math.Matrix.mulVec(o,YFM.Math.Vector.pos(-t[3],-e[3],0)),{parallel:i,line:YFM.Math.Line.lineSV(n,s)}},intersectionTriplePlane:function(t,e,i){var r,o,s,n;return o=[],o.push(t[0]),o.push(e[0]),o.push(i[0]),o.push(0),o.push(t[1]),o.push(e[1]),o.push(i[1]),o.push(0),o.push(t[2]),o.push(e[2]),o.push(i[2]),o.push(0),o.push(0),o.push(0),o.push(0),o.push(1),s=YFM.Math.Matrix.invert(o),r=null==s,r?{atAPoint:!1}:(n=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-e[3],-i[3])),{atAPoint:!0,point:n})}}}(),LDS=function(){var t=function(t,e){var i,r,o;for(i=r=1/t,o=0;e>0;)o+=i*(e%t),i*=r,e=Math.floor(e/t);return o},e=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,57],i=function(t){if(t<0||t>e.length)throw new Error("nthPrimeNumber index out of range");return e[t]};return{halton:function(e,r){return t(i(e),r)}}}(),FrustumWorldSpace.prototype={constructor:FrustumWorldSpace,update:function(t){this.left[0]=t[3]+t[0],this.left[1]=t[7]+t[4],this.left[2]=t[11]+t[8],this.left[3]=t[15]+t[12],this.right[0]=t[3]-t[0],this.right[1]=t[7]-t[4],this.right[2]=t[11]-t[8],this.right[3]=t[15]-t[12],this.bottom[0]=t[3]+t[1],this.bottom[1]=t[7]+t[5],this.bottom[2]=t[11]+t[9],this.bottom[3]=t[15]+t[13],this.top[0]=t[3]-t[1],this.top[1]=t[7]-t[5],this.top[2]=t[11]-t[9],this.top[3]=t[15]-t[13],this.near[0]=t[3]+t[2],this.near[1]=t[7]+t[6],this.near[2]=t[11]+t[10],this.near[3]=t[15]+t[14],this.far[0]=t[3]-t[2],this.far[1]=t[7]-t[6],this.far[2]=t[11]-t[10],this.far[3]=t[15]-t[14]},containCheckPoint:function(t){if(t.isOBB)return-1!==t.frustumCheck(this);var e=!1;do{if(YFM.Math.Vector.dot4(this.near,t)<0)break;if(YFM.Math.Vector.dot4(this.far,t)<0)break;if(YFM.Math.Vector.dot4(this.left,t)<0)break;if(YFM.Math.Vector.dot4(this.right,t)<0)break;if(YFM.Math.Vector.dot4(this.bottom,t)<0)break;if(YFM.Math.Vector.dot4(this.top,t)<0)break;e=!0}while(!1);return e}},OBB.prototype={constructor:OBB,transform:function(t){var e=YFM.Math.Matrix,i=YFM.Math.Vector,r=YFM.Math.Matrix.invert(t),o=YFM.Math.Matrix.transpose(r);this.center=e.mulVec(t,this.center),this.r=this._reserse3(e.mulVec(t,this.r)),this.s=this._reserse3(e.mulVec(t,this.s)),this.t=this._reserse3(e.mulVec(t,this.t)),this.R=this._reserse3(e.mulVec(t,this.R)),this.S=this._reserse3(e.mulVec(t,this.S)),this.T=this._reserse3(e.mulVec(t,this.T)),this.r_max=e.mulVec(o,this.r_min),this.r_min=e.mulVec(o,this.r_max),this.s_max=e.mulVec(o,this.s_min),this.s_min=e.mulVec(o,this.s_max),this.t_max=e.mulVec(o,this.t_min),this.t_min=e.mulVec(o,this.t_max),this.r_half=this._reserse4(e.mulVec(o,this.r_half)),this.s_half=this._reserse4(e.mulVec(o,this.s_half)),this.t_half=this._reserse4(e.mulVec(o,this.t_half)),this.hr=i.norm3(this.R)/2,this.hs=i.norm3(this.S)/2,this.ht=i.norm3(this.T)/2},pointCheck:function(t){if(t.isOBB)return this.obbCheck(t);var e,i,r,o;e=0,i=0,r=0;do{if((o=YFM.Math.Plane.distance(this.r_min,t))<0){e++;break}if(o>0?i++:r++,(o=YFM.Math.Plane.distance(this.r_max,t))<0){e++;break}if(o>0?i++:r++,(o=YFM.Math.Plane.distance(this.s_min,t))<0){e++;break}if(o>0?i++:r++,(o=YFM.Math.Plane.distance(this.s_max,t))<0){e++;break}if(o>0?i++:r++,(o=YFM.Math.Plane.distance(this.t_min,t))<0){e++;break}if(o>0?i++:r++,(o=YFM.Math.Plane.distance(this.t_max,t))<0){e++;break}o>0?i++:r++,ret=!0}while(!1);return 6==i?1:e>0?-1:0},lineCheck:function(t){var e,i,r,o,s,n,a,h,u,l;if(o=Number.MAX_VALUE,s=-Number.MAX_VALUE,e=YFM.Math.Vector.pos(t[0],t[1],t[2]),i=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(t[4],t[5],t[6])),r=YFM.Math.Vector.sub(this.center,e),h=YFM.Math.Vector.dot3(this.r,r),u=YFM.Math.Vector.dot3(this.r,i),YFM.Math.floatNotZero(u)){if(n=(h+this.hr)/u,a=(h-this.hr)/u,n>a&&(l=a,a=n,n=l),n>s&&(s=n),a<o&&(o=a),s>o)return!1;if(o<0)return!1}else if(-h-this.hr>0||-h+this.hr<0)return!1;if(h=YFM.Math.Vector.dot3(this.s,r),u=YFM.Math.Vector.dot3(this.s,i),YFM.Math.floatNotZero(u)){if(n=(h+this.hs)/u,a=(h-this.hs)/u,n>a&&(l=a,a=n,n=l),n>s&&(s=n),a<o&&(o=a),s>o)return!1;if(o<0)return!1}else if(-h-this.hs>0||-h+this.hs<0)return!1;if(h=YFM.Math.Vector.dot3(this.t,r),u=YFM.Math.Vector.dot3(this.t,i),YFM.Math.floatNotZero(u)){if(n=(h+this.ht)/u,a=(h-this.ht)/u,n>a&&(l=a,a=n,n=l),n>s&&(s=n),a<o&&(o=a),s>o)return!1;if(o<0)return!1}else if(-h-this.ht>0||-h+this.ht<0)return!1;return!0},obbCheck:function(t){var e,i,r,o,s;e=0,i=0,r=0;do{if(o=t.effectiveRadius(this.r_min),(s=YFM.Math.Plane.distance(this.r_min,t.center))<-o){e++;break}if(s>o?i++:r++,o=t.effectiveRadius(this.r_max),(s=YFM.Math.Plane.distance(this.r_max,t.center))<-o){e++;break}if(s>o?i++:r++,o=t.effectiveRadius(this.s_min),(s=YFM.Math.Plane.distance(this.s_min,t.center))<-o){e++;break}if(s>o?i++:r++,o=t.effectiveRadius(this.s_max),s=YFM.Math.Plane.distance(this.s_max,t.center),s<-o?e++:s>o?i++:r++,o=t.effectiveRadius(this.t_min),(s=YFM.Math.Plane.distance(this.t_min,t.center))<-o){e++;break}if(s>o?i++:r++,o=t.effectiveRadius(this.t_max),(s=YFM.Math.Plane.distance(this.t_max,t.center))<-o){e++;break}s>o?i++:r++}while(!1);return 6==i?1:e>0?-1:0},frustumCheck:function(t){var e,i,r,o,s;e=0,i=0,r=0;do{if(o=this.effectiveRadius(t.near),(s=YFM.Math.Plane.distance(t.near,this.center))<-o){e++;break}if(s>o?i++:r++,o=this.effectiveRadius(t.far),(s=YFM.Math.Plane.distance(t.far,this.center))<-o){e++;break}if(s>o?i++:r++,o=this.effectiveRadius(t.left),(s=YFM.Math.Plane.distance(t.left,this.center))<-o){e++;break}if(s>o?i++:r++,o=this.effectiveRadius(t.right),s=YFM.Math.Plane.distance(t.right,this.center),s<-o?e++:s>o?i++:r++,o=this.effectiveRadius(t.bottom),(s=YFM.Math.Plane.distance(t.bottom,this.center))<-o){e++;break}if(s>o?i++:r++,o=this.effectiveRadius(t.top),(s=YFM.Math.Plane.distance(t.top,this.center))<-o){e++;break}s>o?i++:r++}while(!1);return 6==i?1:e>0?-1:0},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.R,t))+Math.abs(YFM.Math.Vector.dot3(this.S,t))+Math.abs(YFM.Math.Vector.dot3(this.T,t)))/2},_reserse3:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t},_reserse4:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t},_calc_bounding:function(t){var e,i,r,o,s,n,a,h,u,l,c,M,f,d,p,g;for(n=Number.MAX_VALUE,a=-Number.MAX_VALUE,h=Number.MAX_VALUE,u=-Number.MAX_VALUE,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,i=t.length,e=0;e<i;e++)p=t[e],r=YFM.Math.Vector.dot3(p,this.r),o=YFM.Math.Vector.dot3(p,this.s),s=YFM.Math.Vector.dot3(p,this.t),r>a&&(a=r),r<n&&(n=r),o>u&&(u=o),o<h&&(h=o),s>c&&(c=s),s<l&&(l=s);if(this.r_min=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-n),this.r_max=YFM.Math.Plane.planeRaw(-this.r[0],-this.r[1],-this.r[2],a),this.s_min=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-h),this.s_max=YFM.Math.Plane.planeRaw(-this.s[0],-this.s[1],-this.s[2],u),this.t_min=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-l),this.t_max=YFM.Math.Plane.planeRaw(-this.t[0],-this.t[1],-this.t[2],c),M=(n+a)/2,f=(h+u)/2,d=(l+c)/2,this.r_half=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-M),this.s_half=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-f),this.t_half=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-d),this.hr=(a-n)/2,this.hs=(u-h)/2,this.ht=(c-l)/2,this.R=YFM.Math.Vector.scale(this.r,a-n),this.S=YFM.Math.Vector.scale(this.s,u-h),this.T=YFM.Math.Vector.scale(this.t,c-l),g=YFM.Math.Plane.intersectionTriplePlane(this.r_half,this.s_half,this.t_half),!g.atAPoint)throw new Error("obb calc center failed");this.center=g.point}},FloorQuadTree.prototype={constructor:FloorQuadTree,cursor:0,shift:1e4,removeObject:function(t){var e=this.objMap[t.toString()];if(e){for(var i,r=e.node,o=[],s=0,n=r.objectList.length;s<n;s++)i=r.objectList[s],e!==i&&o.push(i);r.objectList=o,r.objectList.length<=0&&r.shrink()}return e},insertObject:function(t,e,i,r,o){var s=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var n=this.floor.floorPos2Region(i,r);n[2]+=o;var a={id:s,obj:t,pos:n,floor:e,x:i,y:r,z:o};return this.objMap[s.toString()]=a,this.root.insertObject(a),s},insertObjectOBB:function(t,e){var i=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var r={id:i,obj:t,pos:e};return this.objMap[i.toString()]=r,this.root.insertObject(r),i},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,e,i){var r=[];return this.root.rayCheck(t,e*e,r,i),r},rayCheckOBB:function(t,e,i){var e=[];return this.root.rayCheckOBB(t,e,i),e},render:function(t,e,i,r){this.root.renderCheck(t,e,i,r)},getContainLevel:function(t){var e;return e=this.root.containCheck(t),null!=e?e.level:1024}},FloorQuadNode.prototype={constructor:FloorQuadNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){return!(this.objectList.length>0||null!==this.children[0]&&!this.children[0].isNodeEmpty()||null!==this.children[1]&&!this.children[1].isNodeEmpty()||null!==this.children[2]&&!this.children[2].isNodeEmpty()||null!==this.children[3]&&!this.children[3].isNodeEmpty())},rayCheckOBB:function(t,e,r){if(this.obb.lineCheck(t)){var o,s=this.objectList.length;for(i=0;i<s;i++)if(o=this.objectList[i].pos,o.isOBB&&o.lineCheck(t)&&(e.push(this.objectList[i]),r))return!0;if(null!==this.children[0]&&this.children[0].rayCheckOBB(t,e,r))return!0;if(null!==this.children[1]&&this.children[1].rayCheckOBB(t,e,r))return!0;if(null!==this.children[2]&&this.children[2].rayCheckOBB(t,e,r))return!0;if(null!==this.children[3]&&this.children[3].rayCheckOBB(t,e,r))return!0}return!1},rayCheck:function(t,e,r,o){if(this.obb.lineCheck(t)){var s,n=this.objectList.length;for(i=0;i<n;i++)if(s=this.objectList[i].pos,YFM.Math.Line.distancePointSQ(t,s[0],s[1],s[2])<=e&&(r.push(this.objectList[i]),o))return!0;if(null!==this.children[0]&&this.children[0].rayCheck(t,e,r,o))return!0;if(null!==this.children[1]&&this.children[1].rayCheck(t,e,r,o))return!0;if(null!==this.children[2]&&this.children[2].rayCheck(t,e,r,o))return!0;if(null!==this.children[3]&&this.children[3].rayCheck(t,e,r,o))return!0}return!1},containCheck:function(t){var e=this.obb.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){var r=[];r.push(this.children[0].containCheck(t)),r.push(this.children[1].containCheck(t)),r.push(this.children[2].containCheck(t)),r.push(this.children[3].containCheck(t));var o=1024,s=null;for(i=0;i<4;i++)null!==r[i]&&r[i].level<o&&(s=r[i],o=r[i].level);return s}return null},renderEver:function(t,e,i){var r,o;if(0!=(o=this.level>i+1?0:this.level>i?1:1024)){for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderEver(t,e,i);for(o>this.objectList.length&&(o=this.objectList.length),r=0;r<o;r++)t(this.objectList[r],e)}},renderCheck:function(t,e,i,r){var o,s;if(0!=(s=this.level>r+1?0:this.level>r?1:1024)){var n=this.obb.frustumCheck(t);if(-1!=n){if(1==n)for(o=0;o<4;o++)null!==this.children[o]&&this.children[o].renderEver(e,i,r);else if(0==n&&this.level<=r)for(o=0;o<4;o++)null!==this.children[o]&&this.children[o].renderCheck(t,e,i,r);for(s>this.objectList.length&&(s=this.objectList.length),o=0;o<s;o++)t.containCheckPoint(this.objectList[o].pos)&&e(this.objectList[o],i)}}},insertObject:function(t){!this.splited&&this.objectList.length<this.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.obb.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){console.log("node:%s  splite",this.mask);var t,e,i;if(this.splited=!0,!(this.level>=6)){for(this.children[this.NODE_0]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"0",this.level+1),this.children[this.NODE_1]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"1",this.level+1),this.children[this.NODE_2]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"2",this.level+1),this.children[this.NODE_3]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"3",this.level+1),i=[];this.objectList.length>0;){t=this.objectList.pop();var r=[];for(r.push(this.children[0].obb.pointCheck(t.pos)),
r.push(this.children[1].obb.pointCheck(t.pos)),r.push(this.children[2].obb.pointCheck(t.pos)),r.push(this.children[3].obb.pointCheck(t.pos)),e=0;e<4;e++)if(1==r[e]){this.children[e].insertObject(t);break}4==e&&i.push(t)}this.objectList=i}},_insertToSubSpace:function(t){var e=[];if(null!==this.children[0]){e.push(this.children[0].obb.pointCheck(t.pos)),e.push(this.children[1].obb.pointCheck(t.pos)),e.push(this.children[2].obb.pointCheck(t.pos)),e.push(this.children[3].obb.pointCheck(t.pos));for(var i=0;i<4;i++)if(1==e[i])return void this.children[i].insertObject(t)}this._insert2ObjList(t)},THRESHOLD:4,NODE_0:0,NODE_1:1,NODE_2:2,NODE_3:3,LEVEL_COLOR:new Array(YFM.Math.Vector.pos(1,0,0),YFM.Math.Vector.pos(1,.5,0),YFM.Math.Vector.pos(1,1,0),YFM.Math.Vector.pos(0,1,0),YFM.Math.Vector.pos(0,1,1),YFM.Math.Vector.pos(0,0,1),YFM.Math.Vector.pos(.5,0,1),YFM.Math.Vector.pos(0,0,0))},PlanePolygon.prototype={constructor:PlanePolygon,intersectionLine:function(t,e){var i,r,o,s,n,a,h;do{if(s=0,(n=YFM.Math.Plane.intersectionLine(this.plane,t))<0){s=1024;break}for(a=YFM.Math.Line.getPoint(t,n),h=YFM.Math.Matrix.invert(e),a=YFM.Math.Matrix.mulVec(h,a),i=this.barrier.length,r=0;r<i;r++)(o=YFM.Math.Plane.distance(this.barrier[r],a[0],a[1],a[2]))<s&&(s=o)}while(!1);return s},_makePlanePts:function(t){var e,i,r,o,s,n;if((n=t.length)<3)throw new Error("polygon pts count < 3");s=0;do{if(i=YFM.Math.Vector.sub(t[(s+1)%n],t[s%n]),o=YFM.Math.Vector.sub(t[(s+2)%n],t[(s+1)%n]),e=YFM.Math.Vector.cross(i,o),!YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))break;s++}while(s<n);if(YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))throw new Error("polygon degenerate");e=YFM.Math.Vector.normalize(e),s=0;do{i=YFM.Math.Vector.sub(t[(s+1)%n],t[s%n]),r=YFM.Math.Vector.cross(e,i),r=YFM.Math.Vector.normalize(r),this.barrier.push(YFM.Math.Plane.planePN(t[s],r)),s++}while(s<n);return YFM.Math.Plane.planePN(t[0],e)}},Mover.prototype={constructor:Mover,DEFAULT_MASS:1,DEFAULT_MAX_FORCE:4,DEFAULT_MAX_SPEED:4,setMass:function(t){this.mass=t},setMaxForce:function(t){this.maxForce=t},setMaxSpeed:function(t){this.maxSpeed=t},setLocation:function(t,e,i){this.location[0]=t,this.location[1]=e,this.location[2]=i},getLocation:function(){return this.location},update:function(){YFM.Math.Vector.addTo(this.velocity,this.acceleration),YFM.Math.Vector.limitTo(this.velocity,this.maxSpeed),YFM.Math.Vector.addTo(this.location,this.velocity),this.acceleration[0]=0,this.acceleration[1]=0,this.acceleration[2]=0},applyForce:function(t){var e=YFM.Math.Vector.scale(t,1/this.mass);YFM.Math.Vector.addTo(this.acceleration,e)},seek:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},flee:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(-this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},arrive:function(t,e){var i,r,o,s;return i=YFM.Math.Vector.sub(t,this.location),(o=YFM.Math.Vector.norm3(i))<=e||(i=YFM.Math.Vector.normalize(i),o<100?(s=YFM.Math.map(o,0,100,0,this.maxSpeed),YFM.Math.Vector.scaleTo(i,s)):YFM.Math.Vector.scaleTo(i,this.maxSpeed),r=YFM.Math.Vector.sub(i,this.velocity),YFM.Math.Vector.limitTo(r,this.maxForce),this.applyForce(r),!1)}},YFM.Mesh={},YFM.Mesh.CATEGORY_TETRHEDRON="tetrahedron",YFM.Mesh.CATEGORY_HEXADEDRON="hexahedron",YFM.Mesh.CATEGORY_OCTAHEDRON="octahedron",YFM.Mesh.CATEGORY_DODECAHEDRON="dodecahedron",YFM.Mesh.CATEGORY_ICOSAHEDRON="icosahedron",YFM.Mesh.CATEGORY_SPHERE="SPHERE",MeshBuffer.prototype={constructor:MeshBuffer,addAttribute:function(t,e,i,r){var o=this.gl,s=new Float32Array(e),n=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,n),o.bufferData(o.ARRAY_BUFFER,s,o.STATIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,null),this.attributes[t]={vbo:n,size:i,length:e.length/i}},getAttribute:function(t){return this.attributes[t]}},TetrahedronMesh.prototype={constructor:TetrahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._tetrahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_tetrahedron:function(t){var e=[];e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),this._divideTriangle(e[2],e[1],e[0],t),this._divideTriangle(e[0],e[3],e[2],t),this._divideTriangle(e[1],e[3],e[0],t),this._divideTriangle(e[2],e[3],e[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var o=YFM.Math.Vector.mix(t,e,.5),s=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);o=YFM.Math.Vector.normalize(o),s=YFM.Math.Vector.normalize(s),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,o,s,r-1),this._divideTriangle(o,e,n,r-1),this._divideTriangle(n,i,s,r-1),this._divideTriangle(o,n,s,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.sub(i,e),s=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,o));this.mesh.push(t),this.mesh.push(s),this.mesh.push(e),this.mesh.push(s),this.mesh.push(i),this.mesh.push(s)}},HexahedronMesh.prototype={constructor:HexahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._hexahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_hexahedron:function(t){var e=[],i=Math.sqrt(2)/2;e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,i))),this._divideTriangle(e[0],e[1],e[3],t),this._divideTriangle(e[3],e[1],e[2],t),this._divideTriangle(e[4],e[7],e[5],t),this._divideTriangle(e[5],e[7],e[6],t),this._divideTriangle(e[7],e[3],e[6],t),this._divideTriangle(e[6],e[3],e[2],t),this._divideTriangle(e[6],e[2],e[5],t),this._divideTriangle(e[5],e[2],e[1],t),this._divideTriangle(e[4],e[5],e[0],t),this._divideTriangle(e[0],e[5],e[1],t),this._divideTriangle(e[7],e[4],e[0],t),this._divideTriangle(e[0],e[3],e[7],t)},_divideTriangle:function(t,e,i,r){if(r>0){var o=YFM.Math.Vector.mix(t,e,.5),s=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);o=YFM.Math.Vector.normalize(o),s=YFM.Math.Vector.normalize(s),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,o,s,r-1),this._divideTriangle(o,e,n,r-1),this._divideTriangle(n,i,s,r-1),this._divideTriangle(o,n,s,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.sub(i,e),s=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,o));this.mesh.push(t),this.mesh.push(s),this.mesh.push(e),this.mesh.push(s),this.mesh.push(i),this.mesh.push(s)}},OctahedronMesh.prototype={constructor:OctahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._octahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_octahedron:function(t){var e=[];e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(0,-1,0)),e.push(YFM.Math.Vector.pos(0,0,1)),e.push(YFM.Math.Vector.pos(0,0,-1)),this._divideTriangle(e[0],e[2],e[4],t),this._divideTriangle(e[0],e[4],e[3],t),this._divideTriangle(e[0],e[3],e[5],t),this._divideTriangle(e[0],e[5],e[2],t),this._divideTriangle(e[1],e[2],e[5],t),this._divideTriangle(e[1],e[5],e[3],t),this._divideTriangle(e[1],e[3],e[4],t),this._divideTriangle(e[1],e[4],e[2],t)},_divideTriangle:function(t,e,i,r){if(r>0){var o=YFM.Math.Vector.mix(t,e,.5),s=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);o=YFM.Math.Vector.normalize(o),s=YFM.Math.Vector.normalize(s),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,o,s,r-1),this._divideTriangle(o,e,n,r-1),this._divideTriangle(n,i,s,r-1),this._divideTriangle(o,n,s,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.sub(i,e),s=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,o));this.mesh.push(t),this.mesh.push(s),this.mesh.push(e),this.mesh.push(s),this.mesh.push(i),this.mesh.push(s)}},DodecahedronMesh.prototype={constructor:DodecahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._dodecahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_dodecahedron:function(t){var e=(1+Math.sqrt(5))/2,i=1/e,r=[];r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,i))),this._divideTriangle(r[3],r[11],r[7],t),this._divideTriangle(r[3],r[7],r[15],t),this._divideTriangle(r[3],r[15],r[13],t),this._divideTriangle(r[7],r[19],r[17],t),this._divideTriangle(r[7],r[17],r[6],t),this._divideTriangle(r[7],r[6],r[15],t),this._divideTriangle(r[17],r[4],r[8],t),this._divideTriangle(r[17],r[8],r[10],t),this._divideTriangle(r[17],r[10],r[6],t),this._divideTriangle(r[8],r[0],r[16],t),this._divideTriangle(r[8],r[16],r[2],t),this._divideTriangle(r[8],r[2],r[10],t),this._divideTriangle(r[0],r[12],r[1],t),this._divideTriangle(r[0],r[1],r[18],t),this._divideTriangle(r[0],r[18],r[16],t),this._divideTriangle(r[6],r[10],r[2],t),this._divideTriangle(r[6],r[2],r[13],t),this._divideTriangle(r[6],r[13],r[15],t),this._divideTriangle(r[2],r[16],r[18],t),this._divideTriangle(r[2],r[18],r[3],t),this._divideTriangle(r[2],r[3],r[13],t),this._divideTriangle(r[18],r[1],r[9],t),this._divideTriangle(r[18],r[9],r[11],t),this._divideTriangle(r[18],r[11],r[3],t),this._divideTriangle(r[4],r[14],r[12],t),this._divideTriangle(r[4],r[12],r[0],t),this._divideTriangle(r[4],r[0],r[8],t),this._divideTriangle(r[11],r[9],r[5],t),this._divideTriangle(r[11],r[5],r[19],t),this._divideTriangle(r[11],r[19],r[7],t),this._divideTriangle(r[19],r[5],r[14],t),this._divideTriangle(r[19],r[14],r[4],t),this._divideTriangle(r[19],r[4],r[17],t),this._divideTriangle(r[1],r[12],r[14],t),this._divideTriangle(r[1],r[14],r[5],t),this._divideTriangle(r[1],r[5],r[9],t)},_divideTriangle:function(t,e,i,r){if(r>0){var o=YFM.Math.Vector.mix(t,e,.5),s=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);o=YFM.Math.Vector.normalize(o),s=YFM.Math.Vector.normalize(s),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,o,s,r-1),this._divideTriangle(o,e,n,r-1),this._divideTriangle(n,i,s,r-1),this._divideTriangle(o,n,s,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.sub(i,e),s=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,o));this.mesh.push(t),this.mesh.push(s),this.mesh.push(e),this.mesh.push(s),this.mesh.push(i),this.mesh.push(s)}},IcosahedronMesh.prototype={constructor:IcosahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._icosahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_icosahedron:function(t){var e=(1+Math.sqrt(5))/2,i=[];i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,1))),this._divideTriangle(i[0],i[11],i[5],t),this._divideTriangle(i[0],i[5],i[1],t),this._divideTriangle(i[0],i[1],i[7],t),this._divideTriangle(i[0],i[7],i[10],t),this._divideTriangle(i[0],i[10],i[11],t),this._divideTriangle(i[1],i[5],i[9],t),this._divideTriangle(i[5],i[11],i[4],t),this._divideTriangle(i[11],i[10],i[2],t),this._divideTriangle(i[10],i[7],i[6],t),this._divideTriangle(i[7],i[1],i[8],t),this._divideTriangle(i[3],i[9],i[4],t),this._divideTriangle(i[3],i[4],i[2],t),this._divideTriangle(i[3],i[2],i[6],t),this._divideTriangle(i[3],i[6],i[8],t),this._divideTriangle(i[3],i[8],i[9],t),this._divideTriangle(i[4],i[9],i[5],t),this._divideTriangle(i[2],i[4],i[11],t),this._divideTriangle(i[6],i[2],i[10],t),this._divideTriangle(i[8],i[6],i[7],t),this._divideTriangle(i[9],i[8],i[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var o=YFM.Math.Vector.mix(t,e,.5),s=YFM.Math.Vector.mix(t,i,.5),n=YFM.Math.Vector.mix(e,i,.5);o=YFM.Math.Vector.normalize(o),s=YFM.Math.Vector.normalize(s),n=YFM.Math.Vector.normalize(n),this._divideTriangle(t,o,s,r-1),this._divideTriangle(o,e,n,r-1),this._divideTriangle(n,i,s,r-1),this._divideTriangle(o,n,s,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.sub(i,e),s=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,o));this.mesh.push(t),this.mesh.push(s),this.mesh.push(e),this.mesh.push(s),this.mesh.push(i),this.mesh.push(s)}},YFM.Mesh.ObjModel={},YFM.Mesh.ObjModel.VPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.NPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.UVPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.FacePattern1=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,YFM.Mesh.ObjModel.FacePattern2=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern3=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern4=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,YFM.Mesh.ObjModel.NsPattern=/Ns( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KaPattern=/Ka( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KdPattern=/Kd( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KsPattern=/Ks( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,ObjModel.prototype={constructor:ObjModel,setFloor:function(t){this.floor=t},setModelMatrix:function(t){this.modelMatrix=t;var e=YFM.Math.Matrix.mul(this.floor.getFloorMat(),this.modelMatrix);this.obb.transform(e)},render:function(t,e){var i=YFM.Math.Matrix.mul(e,this.modelMatrix),r=YFM.Math.Matrix.transpose(i),o=YFM.Math.Matrix.invert(r);t.setNormalMatrix(o),t.setModelMatrix(this.modelMatrix);for(var s=0,n=this.objects.length;s<n;s++)this.hasMaterials&&this.objects[s].material.mtl?t.setMTL(this.objects[s].material.mtl,this.texturePool):t.setDefaultMTL(),t.drawTriangles(this.objects[s].mesh)},loadURLDir:function(t,e,i,r){this.baseUrl=t;var o,s,n=this;o=t+"/"+e+".mtl",s=t+"/"+e+".obj";var a=new XMLHttpRequest;a.open("GET",o,!0),a.responseType="text",a.onload=function(t){if(200==this.status){n._parseMtl(this.response);var e=new XMLHttpRequest;e.open("GET",s,!0),e.responseType="text",e.onload=function(t){200==this.status?(n._parseObj(this.response),i&&i(n),n.hasMaterials=!0):r&&r(this.status)},e.send()}else r&&r(this.status)},a.send()},loadURLWithMtl:function(t,e,i,r){this.baseUrl=e.substr(0,e.lastIndexOf("/")+1);var o=this,s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="text",s.onload=function(e){if(200==this.status){o._parseMtl(this.response);var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.onload=function(t){200==this.status?(o._parseObj(this.response),i&&i(o),o.hasMaterials=!0):r&&r(this.status)},s.send()}else r&&r(this.status)},s.send()},loadURL:function(t,e,i){this.baseUrl=t.substr(0,t.lastIndexOf("/")+1);var r=this,o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="text",o.onload=function(t){200==this.status?(r._parseObj(this.response),e&&e(r)):i&&i(this.status)},o.send()},_parseMtl:function(t){for(var e,i=t.split("\n"),r=0;r<i.length;r++){var o,s=i[r];if(s=s.trim(),0!==s.length&&"#"!==s.charAt(0))if(/^newmtl /.test(s)){var n=s.substring(7).trim();e=new MtlItem,this.materials[n]=e}else if(/^map_Kd /.test(s)){var a=s.substring(7).trim();e.setMapKd(a),this.texturePool.addTexture(a,this.baseUrl+"/"+a)}else null!==(o=YFM.Mesh.ObjModel.NsPattern.exec(s))?e.setNs(parseFloat(o[1])):null!==(o=YFM.Mesh.ObjModel.KaPattern.exec(s))?e.setKa(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])):null!==(o=YFM.Mesh.ObjModel.KdPattern.exec(s))?e.setKd(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])):null!==(o=YFM.Mesh.ObjModel.KsPattern.exec(s))&&e.setKs(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]))}},_parseObj:function(t){function e(t){var e=parseInt(t);return 3*(e>=0?e-1:e+c.length/3)}function i(t){var e=parseInt(t);return 3*(e>=0?e-1:e+M.length/3)}function r(t){var e=parseInt(t);return 2*(e>=0?e-1:e+f.length/2)}function o(t,e,i){u.vertices.push(c[t],c[t+1],c[t+2],c[e],c[e+1],c[e+2],c[i],c[i+1],c[i+2])}function s(t,e,i){u.normals.push(M[t],M[t+1],M[t+2],M[e],M[e+1],M[e+2],M[i],M[i+1],M[i+2])}function n(t,e,i){u.uvs.push(f[t],f[t+1],f[e],f[e+1],f[i],f[i+1])}function a(t,a,h,u,l,c,M,f,d,p,g,m){var v=e(t),F=e(a),x=e(h);if(void 0===u)o(v,F,x);else{var _=e(u);o(v,F,_),o(F,x,_)}if(void 0!==l){var v=r(l),F=r(c),x=r(M);if(void 0===u)n(v,F,x);else{var _=r(f);n(v,F,_),n(F,x,_)}}if(void 0!==d){var v=i(d),F=i(p),x=i(g);if(void 0===u)s(v,F,x);else{var _=i(m);s(v,F,_),s(F,x,_)}}}var h,u,l,c=[],M=[],f=[];!1===/^o /gm.test(t)&&(u={vertices:[],normals:[],uvs:[]},l={name:""},h={name:"",geometry:u,material:l},this.objects.push(h));for(var d=t.split("\n"),p=0;p<d.length;p++){var g,m=d[p];m=m.trim(),0!==m.length&&"#"!==m.charAt(0)&&(null!==(g=YFM.Mesh.ObjModel.VPattern.exec(m))?c.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])):null!==(g=YFM.Mesh.ObjModel.NPattern.exec(m))?M.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])):null!==(g=YFM.Mesh.ObjModel.UVPattern.exec(m))?f.push(parseFloat(g[1]),parseFloat(g[2])):null!==(g=YFM.Mesh.ObjModel.FacePattern1.exec(m))?a(g[1],g[2],g[3],g[4]):null!==(g=YFM.Mesh.ObjModel.FacePattern2.exec(m))?a(g[2],g[5],g[8],g[11],g[3],g[6],g[9],g[12]):null!==(g=YFM.Mesh.ObjModel.FacePattern3.exec(m))?a(g[2],g[6],g[10],g[14],g[3],g[7],g[11],g[15],g[4],g[8],g[12],g[16]):null!==(g=YFM.Mesh.ObjModel.FacePattern4.exec(m))?a(g[2],g[5],g[8],g[11],void 0,void 0,void 0,void 0,g[3],g[6],g[9],g[12]):/^o /.test(m)?(u={vertices:[],normals:[],uvs:[]},l={name:""},h={name:m.substring(2).trim(),geometry:u,material:l},this.objects.push(h)):/^g /.test(m)||(/^usemtl /.test(m)?(l.name=m.substring(7).trim(),l.mtl=this.materials[l.name]):/^mtllib /.test(m)||/^s /.test(m)))}for(var p=0,v=this.objects.length;p<v;p++){var F=this.objects[p],x=F.geometry,_=new MeshBuffer(this.gl);_.addAttribute("position",x.vertices,3),x.normals.length>0&&_.addAttribute("normal",x.normals,3),x.uvs.length>0&&_.addAttribute("uv",x.uvs,2),F.mesh=_}for(var y=[],p=0,v=this.objects.length;p<v;p++){for(var c=this.objects[p].geometry.vertices,Y=0,R=c.length/3;Y<R;Y++)y.push(YFM.Math.Vector.pos(c[3*Y+0],c[3*Y+1],c[3*Y+2]));delete this.objects[p].geometry}this.obb=new OBB(y)}},MtlItem.prototype={constructor:MtlItem,setNs:function(t){this.Ns=t},setKa:function(t,e,i){this.Ka[0]=t,this.Ka[1]=e,this.Ka[2]=i},setKd:function(t,e,i){this.Kd[0]=t,this.Kd[1]=e,this.Kd[2]=i},setKs:function(t,e,i){this.Ks[0]=t,this.Ks[1]=e,this.Ks[2]=i},setMapKd:function(t){this.mapKd=t},getNs:function(){return this.Ns},getKa:function(){return this.Ka},getKd:function(){return this.Kd},getKs:function(){return this.Ks},getMapKd:function(){return this.mapKd}},RawPanorama.prototype={constructor:RawPanorama,render:function(t,e){null!==this.cubeMap&&(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setModelMatrix(YFM.Math.Matrix.mul(e,this.modelMat)),t.bindTexture(this.cubeMap),t.drawTriangles(this.cubeVBO,this.cubeSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CCW),this.gl.disable(this.gl.CULL_FACE))},setCubeTex:function(t,e,i,r,o,s){var n={imgList:new Array(6),imgCount:0},a=this;n.imgList[0]=new Image,n.imgList[0].onload=function(){a._handleTextureLoaded(0,n)},n.imgList[0].src=t,n.imgList[1]=new Image,n.imgList[1].onload=function(){a._handleTextureLoaded(1,n)},n.imgList[1].src=e,n.imgList[2]=new Image,n.imgList[2].onload=function(){a._handleTextureLoaded(2,n)},n.imgList[2].src=i,n.imgList[3]=new Image,n.imgList[3].onload=function(){a._handleTextureLoaded(3,n)},n.imgList[3].src=r,n.imgList[4]=new Image,n.imgList[4].onload=function(){a._handleTextureLoaded(4,n)},n.imgList[4].src=o,n.imgList[5]=new Image,n.imgList[5].onload=function(){a._handleTextureLoaded(5,n)},n.imgList[5].src=s},_initCube:function(){var t=this.gl,e=[],i=[YFM.Math.Vector.pos(-5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,-5e3,-5e3),YFM.Math.Vector.pos(-5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,-5e3,-5e3)];this._quad(i,e,1,0,3,2),this._quad(i,e,2,3,7,6),this._quad(i,e,3,0,4,7),this._quad(i,e,6,5,1,2),this._quad(i,e,4,5,6,7),this._quad(i,e,5,4,0,1),this.cubeVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cubeVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW),this.cubeSize=e.length},_quad:function(t,e,i,r,o,s){e.push(t[i]),e.push(t[r]),e.push(t[o]),e.push(t[i]),e.push(t[o]),e.push(t[s])},_makeCubeTex:function(t,e,i,r,o,s){var n=this.gl;null!==this.cubeMap&&n.deleteTexture(this.cubeMap),this.cubeMap=n.createTexture(),n.bindTexture(n.TEXTURE_CUBE_MAP,this.cubeMap),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_X,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,r),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_Y,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,o),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_Z,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.texImage2D(n.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,s),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)},_handleTextureLoaded:function(t,e){e.imgCount+=1,6==e.imgCount&&this._makeCubeTex(e.imgList[0],e.imgList[1],e.imgList[2],e.imgList[3],e.imgList[4],e.imgList[5])}},YFM.WebGL=function(){var t=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},e=function(e,r){function o(i){var r=e.parentNode;r&&(r.innerHTML=t(i))}if(!window.WebGLRenderingContext)return o('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var s=i(e,r);return s||o('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),s},i=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,o=0;o<i.length;++o){try{r=t.getContext(i[o],e)}catch(t){}if(r)break}return r};return{create3DContext:i,setupWebGL:e,makeShader:function(t,e,i){var r,o;if(r=t.createShader(t.VERTEX_SHADER),t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){var s="Vertex shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(r)+"</pre>";return alert(s),-1}if(o=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(o,i),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS)){var s="Fragment shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(o)+"</pre>";return alert(s),-1}var n=t.createProgram();if(t.attachShader(n,r),t.attachShader(n,o),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){var s="Shader program failed to link.  The error log is:<pre>"+t.getProgramInfoLog(n)+"</pre>";return alert(s),-1}return n}}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)}}(),YFM.WebGL.Color=function(){var t=function(t){return((16711680&t)>>16)/255},e=function(t){return((65280&t)>>8)/255},i=function(t){return(255&t)/255},r=function(t){return((4278190080&t)>>>24)/255},o=function(r){return YFM.Math.Vector.pos(t(r),e(r),i(r))};return{hexColorRed:t,hexColorGreen:e,hexColorBlue:i,hexColorAlpha:r,randomHexRGB:function(){return 4278190080|Math.floor(255*Math.random())<<16|Math.floor(255*Math.random())<<8|Math.floor(255*Math.random())},getRGBVec:o}}(),BaseColorProgram.prototype={constructor:BaseColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nattribute  vec4 aColor;\nuniform mat4 uModelMat;\nuniform mat4 uFloorMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nuniform float uMapHeight;\nvarying vec4 vColor;\nvoid main()\n{\n\tvec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uFloorMat*uModelMat*pos;\n\tvColor = aColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},BasePhongProgram.prototype={constructor:BasePhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setLighting:function(t){this.gl.uniform1i(this.uLighting,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},
vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec4 aColor;     \nuniform int    uLighting;  \nuniform float  uMapHeight; \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   vec4 tPos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   if(1 == uLighting){\n       float shininess = 320.0;                                 \n       vec4 ambient, diffuse, specular;                        \n       vec4 ambientProduct = vec4(0.3, 0.3, 0.3, 1.0 );        \n       vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n       vec4 specularProduct= vec4(0.1, 0.1, 0.1, 1.0 );        \n                                                               \n       vec3 pos = (modelViewMatrix * tPos).xyz;                \n       vec3 L = normalize((uViewMat*uLightPos).xyz);           \n       vec3 E = -normalize(pos );                              \n       vec3 H = normalize(L + E );                             \n       vec3 N = normalize((uNormalMat*aNormal).xyz);           \n       ambient = ambientProduct;                               \n       float Kd = max( dot(L, N), 0.0 );                       \n       diffuse = Kd*diffuseProduct;                            \n       float Ks = pow(max(dot(N, H), 0.0), shininess);         \n       specular = Ks * specularProduct;                        \n       if(dot(L, N) < 0.0) {                                   \n           specular = vec4(0.0, 0.0, 0.0, 1.0);                \n       }                                                       \n       vColor = aColor*ambient+aColor*diffuse + aColor*specular;\n   }else{                                                  \n       vColor = aColor;                                    \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * tPos;        \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},RegionPhongProgram.prototype={constructor:RegionPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,i,e-i)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nuniform vec4   uColor;     \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   float shininess = 320.0;                                \n   vec4 ambient, diffuse, specular;                        \n   vec4 ambientProduct = vec4(0.5, 0.5, 0.5, 1.0 );        \n   vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n   vec4 specularProduct= vec4(0.2, 0.2, 0.2, 1.0 );        \n                                                           \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uModelMat;   \n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   ambient = ambientProduct;                               \n   float Kd = max( dot(L, N), 0.0 );                       \n   diffuse = Kd*diffuseProduct;                            \n   float Ks = pow(max(dot(N, H), 0.0), shininess);         \n   specular = Ks * specularProduct;                        \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n   vColor = uColor*ambient+uColor*diffuse+uColor*specular; \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},SelectColorProgram.prototype={constructor:SelectColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},drawLines:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},getProgram:function(){return this.program},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform vec4 uColor;\nuniform mat4 uModelMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uModelMat*aPosition;\n\tvColor = uColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},BillboardIconProgram.prototype={constructor:BillboardIconProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setIViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uiViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nvarying vec3 vTexCoord;    \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uiViewMat;  \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uViewMat*uRegionMat*uModelMat*uiViewMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},Marker2DProgram.prototype={constructor:Marker2DProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nuniform mat4   uModelMat;  \nuniform mat4   uProjMat;   \nvarying vec3   vTexCoord;  \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uModelMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},PointSpiritProgram.prototype={constructor:PointSpiritProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    gl_Position = uProjMat*uViewMat*uRegionMat*aPosition;\n    gl_PointSize = 24.0;                        \n}\n",fshader:"precision mediump float;                       \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, gl_PointCoord);\n}\n"},RawPanoramaProgram.prototype={constructor:RawPanoramaProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},getProgram:function(){return this.program},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTexMap,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform mat4 uModelMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec3 V;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uModelMat*aPosition;\n   V = normalize(vec3(aPosition.x, aPosition.y, aPosition.z));\n}\n",fshader:"precision mediump float;\nuniform samplerCube uTexMap;\nvarying vec3 V;\nvoid main()\n{\n\tgl_FragColor = textureCube(uTexMap, V);\n}\n"},ModelPhongProgram.prototype={constructor:ModelPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawLines:function(t,e,i,r){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},drawTriangles:function(t){var e,i,r;e=t.getAttribute("position"),i=t.getAttribute("normal"),r=t.getAttribute("uv"),null!==e&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition)),null!=i&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aNormal)),null!=r&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord)),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length)},setTexFlag:function(t){this.gl.uniform1i(this.uTexFlag,t)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setMTL:function(t,e){if(this.gl.uniform1f(this.uNs,t.getNs()),this.gl.uniform4fv(this.uKa,YFM.Math.flatten(t.getKa())),this.gl.uniform4fv(this.uKd,YFM.Math.flatten(t.getKd())),this.gl.uniform4fv(this.uKs,YFM.Math.flatten(t.getKs())),null!==t.getMapKd()){var i=e.getTexture(t.getMapKd());if(null!=i)return this.gl.uniform1i(this.uTexFlag,1),this.gl.uniform1i(this.uColorFlag,0),void this.bindTexture(i.tex)}this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setDefaultMTL:function(){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec3 aTexCoord;  \nuniform int    uTexFlag;   \nuniform float  uNs;        \nuniform vec4   uKa;        \nuniform vec4   uKd;        \nuniform vec4   uKs;        \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec3   vTexCoord;  \nvarying vec4   vAmbient;   \nvarying vec4   vDiffuse;   \nvarying vec4   vSpecular;  \n                           \nvoid main(){               \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   vAmbient = uKa;                                         \n   vDiffuse = max(dot(L,N), 0.0)*uKd;                      \n   vec4 specular = pow(max(dot(N, H), 0.0), uNs)*uKs;      \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   vSpecular = specular;                                   \n   if(1 == uTexFlag)                                       \n       vTexCoord = aTexCoord;                              \n   else                                                    \n       vTexCoord = vec3(0.0, 0.0, 0.0);                    \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n}\n",fshader:"precision mediump float;       \nuniform int        uColorFlag; \nuniform vec4       uColor;     \nuniform sampler2D  uTex;       \nvarying vec3       vTexCoord;  \nvarying vec4       vAmbient;   \nvarying vec4       vDiffuse;   \nvarying vec4       vSpecular;  \nvoid main() {                  \n       vec4 color;                                                     \n       if(1 == uColorFlag)                                             \n           color = uColor;                                             \n       else                                                            \n           color = texture2D(uTex, vTexCoord.xy);                      \n       gl_FragColor = color*vAmbient+color*vDiffuse+color*vSpecular;   \n}\n"},DeviceOrientationCamera.prototype={constructor:DeviceOrientationCamera,DEFAULT_PITCH:-30,setPerspective:function(t,e,i,r){this.mat_projection=YFM.Math.Matrix.perspective(t,e,i,r),this.dirty=!0},setOrthographic:function(t,e,i,r,o,s){this.mat_projection=YFM.Math.Matrix.orthographic(t,e,i,r,o,s),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getProjectionMatWithLDS:function(t,e){var i=YFM.Math.Matrix.matClone(this.mat_projection),r=LDS.halton(2,this.ldsIndex),o=LDS.halton(3,this.ldsIndex);return i[8]+=(r-.5)/t,i[9]+=(o-.5)/e,this.ldsIndex+=1,this.ldsIndex>this.ldsN&&(this.ldsIndex=0),i},getProjectionMatWithRGSS:function(t,e,i){var r=YFM.Math.Matrix.matClone(this.mat_projection),o=this.rgss[t][0],s=this.rgss[t][1];return r[8]+=(2*o-1)/e,r[9]+=(2*s-1)/i,r},getPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_pv},getIPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_ipv},getViewMat:function(){return this.dirty&&this._updateViewMat(),this.mat_view},getRoll:function(){return this.roll},getPitch:function(){return this.pitch},setPitch:function(t){this.pitch=t,this.dirty=!0},getEyePos:function(){return this.eyePos},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getAzimuth:function(){var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion);return-YFM.Math.Matrix.eulerParamExtractZ(t)},setAzimuth:function(t){this.quaternion.setFromAxisAngle(this.zee,t),this.dirty=!0},setLookAtAzimuth:function(t,e,i,r){this.quaternion.setFromAxisAngle(this.zee,t),this.lookAt[0]=e,this.lookAt[1]=i,this.lookAt[2]=r,this.dirty=!0},setLookAt:function(t,e,i){this.lookAt[0]=t,this.lookAt[1]=e,this.lookAt[2]=i,this.dirty=!0},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getLookOffset:function(){return YFM.Math.Vector.vecClone(this.lookOffset)},getLookOffsetNormal:function(){return this.lookOffset[2]},setLookOffset:function(t,e,i){this.lookOffset[0]=t,this.lookOffset[1]=e,this.lookOffset[2]=i,this.dirty=!0},resetLookOffsetTan:function(){this.lookOffset[0]=0,this.lookOffset[1]=0,this.dirty=!0},_updaeQuaternion:function(){if(!1!==this.enabled&&null!=this.deviceOrientation){var t=YFM.Math.deg2Radian,e=this.deviceOrientation.alpha?t(this.deviceOrientation.alpha)+this.alphaOffsetAngle:0,i=this.deviceOrientation.beta?t(this.deviceOrientation.beta):0,r=this.deviceOrientation.gamma?t(this.deviceOrientation.gamma):0,o=this.screenOrientation?t(this.screenOrientation):0,s=new Euler(i,e,-r,"YXZ");this.q2.setFromAxisAngle(this.zee,-o),this.quaternion.setFromEuler(s),this.quaternion.premultiply(this.q0),this.quaternion.multiply(this.q1),this.quaternion.multiply(this.q2),this.roll=this.deviceOrientation.gamma?this.deviceOrientation.gamma:0}},_updateViewMat:function(){this._updaeQuaternion();var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion),e=YFM.Math.Matrix.mulVec(t,this.lookAt);t=YFM.Math.Matrix.postTranslate(t,-e[0],-e[1],-e[2]);var i=YFM.Math.Matrix.translate(this.lookOffset[0],this.lookOffset[1],this.lookOffset[2]);if(this.pitchEnable){var r=YFM.Math.Matrix.rotate3d(this.pitch,1,0,0);this.mat_view=YFM.Math.Matrix.mul(i,YFM.Math.Matrix.mul(r,t))}else this.mat_view=YFM.Math.Matrix.mul(i,t);this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.dirty=!1}},TexturePool.prototype={constructor:TexturePool,addTexture:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,r=new TextureWrap(t,e,i),o=this;i.onload=function(){o._handleTextureLoaded(r)},i.src=e},getTexture:function(t){var e=this.pool[t];return null!=e?{tex:e.tex,w:e.w,h:e.h}:null},_handleTextureLoaded:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img}},window.map=function(t){function e(r){if(i[r])return i[r].exports;var o=i[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,r){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=5)}([function(t,e,i){"use strict";function r(t){function e(t,e){void 0!==h&&(f=setTimeout(function(){"jsonp"===n?document.body.removeChild(e):(M=!0,d&&d.abort()),console.log("timeout"),l&&l("请求超时!")},h))}var i=t.url||"",r=(t.type||"get").toLowerCase(),o=t.data||null,s=t.contentType||"",n=t.dataType||"",a=void 0===t.async&&!0,h=t.timeOut,u=t.before||function(){},l=t.error||function(){},c=t.success||function(){},M=!1,f=null,d=null;!function(){var t,e;if(o){if("string"==typeof o){o=o.split("&");for(var s=0,a=o.length;s<a;s++)t=o[s].split("=")[0],e=o[s].split("=")[1],o[s]=encodeURIComponent(t)+"="+encodeURIComponent(e);console.log(o),console.log(typeof o),o=o.replace("/%20/g","+")}else if("object"==typeof o){var h=[];for(var t in o)if(void 0!==o[t]){var e=o[t].toString();t=encodeURIComponent(t),e=encodeURIComponent(e),h.push(t+"="+e)}o=h.join("&").replace("/%20/g","+")}"get"!==r&&"jsonp"!==n||(i+=i.indexOf("?")>-1?i.indexOf("=")>-1?"&"+o:o:"?"+o)}}(),u(),"jsonp"===n?function(){var t=document.createElement("script"),r=(new Date).getTime()+Math.round(1e3*Math.random()),o="JSONP_"+r;window[o]=function(e){clearTimeout(f),document.body.removeChild(t),c(e)},t.src=i+(i.indexOf("?")>-1?"&":"?")+"callback="+o,t.type="text/javascript",document.body.appendChild(t),e(o,t)}():function(){d=function(){if(window.XMLHttpRequest)return new XMLHttpRequest;for(var t=["Microsoft","msxm3","msxml2","msxml1"],e=0;e<t.length;e++)try{var i=t[e]+".XMLHTTP";return new ActiveXObject(i)}catch(t){}}(),d.open(r,i,a),"post"!==r||s?s&&d.setRequestHeader("Content-Type",s):d.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),d.onreadystatechange=function(){if(4===d.readyState){if(void 0!==h){if(M)return;clearTimeout(f)}d.status>=200&&d.status<300||304==d.status?c(d.responseText):l(d.status,d.statusText)}},d.send("get"===r?null:o),e()}()}function o(t,e,i,o){r({type:"get",dataType:"jsonp",url:t,data:e,timeOut:1e4,before:function(){},success:function(t){null!=t&&"success"==t.code&&i&&i(t)},error:function(t){o&&o(t)}})}function s(){}i.d(e,"a",function(){return a});var n=i(2),a=new s;s.prototype.serverCallWxAuth=function(t,e){o("http://wx.indoorun.com/wxauth/getAuthParas?reqUrl="+window.location.href,{},t,e)},s.prototype.serverCallInitSession=function(t,e,i){o(t,{},e,i)},s.prototype.serverCallWXSign=function(t,e,i){o("http://wx.indoorun.com/wx/getSign.html",t,e,i)},s.prototype.serverCallRegionPath=function(t,e,i){o("http://wx.indoorun.com/wx/getPathOfRegionZipBase64.html?regionId=14428254382730015",{regionId:t,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},e,i)},s.prototype.serverCallSvgMap=function(t,e,i,r){o("http://wx.indoorun.com/wx/getSvg.html",{regionId:t,floorId:e,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},i,r)},s.prototype.serverCallUnits=function(t,e,i,r){o("http://wx.indoorun.com/wx/getUnitsOfFloor.html",{regionId:t,floorId:e,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},i,r)},s.prototype.serverCallRegionAllInfo=function(t,e,i){o("http://wx.indoorun.com/wx/getRegionInfo",{regionId:t,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},e,i)},s.prototype.serverCallLocating=function(t,e,i,r,s){var a="http://wx.indoorun.com",h=a+"/locate/locating";a="http://192.168.1.116:3000",h=a+"/users/locating",o(h,{beacons:t,gzId:"ewr2342342",openId:"wx_oBt8bt-1WMXu67NNZI-JUNQj6UAc",OSType:"iPhone",regionId:e,floorId:i,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},r,s)},s.prototype.serverCallRouteData=function(t,e,i){o("http://wx.indoorun.com/wx/getPathOfRegionZipBase64.html?",{regionId:t,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},e,i)},s.prototype.serverCallLocate=function(t,e,i,r){o("http://localhost:3000/users/locating",{gzId:"ewr2342342",openId:"wx_oBt8bt-1WMXu67NNZI-JUNQj6UAc",OSType:"iPhone",regionId:t,appId:n.a.appId,clientId:n.a.clientId,sessionKey:n.a.sessionKey},i,r)}},function(t,e,i){"use strict";function r(){this.x=0,this.y=0}i.d(e,"a",function(){return r}),r.prototype.getX=function(){return this.x},r.prototype.setX=function(t){this.x=t},r.prototype.getY=function(){return this.y},r.prototype.setY=function(t){this.y=t},r.prototype.hashCode=function(){return this.x+this.y},r.prototype.equals=function(t){return null!=t&&t instanceof r&&(this.x==pos.x&&this.y==pos.y)},r.prototype.compareTo=function(t){return this.getX()<t.getX()?-1:this.getX()>t.getX()?1:this.getY()<t.getY()?-1:this.getY()>t.getY()?1:0},r.prototype.string=function(){return this.x+","+this.y}},function(t,e,i){"use strict";function r(){}i.d(e,"a",function(){return s});var o=i(0);r.prototype.init=function(t,e,i){function r(t,e,i){if("object"==typeof t||"function"==typeof e){s.appId="2b497ada3b2711e4b60500163e0e2e6b",s.clientId=t.clientId,s.time=t.time,s.sign=t.sign;var r="appId=2b497ada3b2711e4b60500163e0e2e6b&clientId="+t.clientId+"&time="+t.time+"&sign="+t.sign,n="http://wx.indoorun.com/wx/initSession.html?"+r;o.a.serverCallInitSession(n,function(t){s.sessionKey=t.sessionKey,"failed"===t.code?i&&i(t):e&&e(t)},function(){console.log(r),i&&i()})}}var s=this;o.a.serverCallWXSign({appId:t},function(t){r(t,e,i)},function(t){i&&i(t)})};var s=new r},function(t,e,i){"use strict";function r(t){function e(t){for(var e=0;e<l.length;++e){var i=l[e];if(i.id===t)return i.floorIndex}return null}function i(t){for(var e=0;e<l.length;++e){var i=l[e];if(i.id===t)return i}return null}function r(t,e){var r=i(t);if(null==r)return null;for(var o=0;o<r.unitList.length;++o){var s=r.unitList[o];if(s.id===e)return s}return null}function s(){for(var t=0;t<l.length;++t){if(!(l[t].id in u.floorSvgs))return!1}return!0}function n(t){for(var e=0;e<l.length;++e)!function(){var i=l[e].id;console.log("load + "+i),o.a.serverCallSvgMap(u.id,i,function(e){console.log(i),u.floorSvgs[i]=e.data,s()&&(console.log("所有地图数据加载成功"),c=!0,"function"==typeof t&&t())},function(t){console.log("地图数据获取失败!"+t)})}()}function a(){return c}for(var h in t)this[h]=t[h];this.floorSvgs={};var u=this,l=this.floorList,c=!1;this.getFloorbyId=i,this.getUnitById=r,this.loadSvgMaps=n,this.isSvgDataExist=a,this.getFloorIndex=e}i.d(e,"a",function(){return r});var o=i(0)},function(t,e,i){"use strict";function r(t){function e(){if(s)return s;var t=i().split(" ");s=[];for(var e=0;e<t.length;++e){var r=t[e].split(",").map(Number),o=YFM.Math.Vector.pos(r[0],r[1]);s.push(o)}return s}function i(){if(o.points)return o.points;var t=o.boundLeft,e=o.boundTop,i=o.boundRight,r=o.boundBottom;return o.points=t+","+e+" "+i+","+e+" "+i+","+r+" "+t+","+r,o.points}for(var r in t)this[r]=t[r];var o=this;this.getPos=function(){return{x:.5*(o.boundLeft+o.boundRight),y:.5*(o.boundTop+o.boundBottom),floorId:o.floorId}};var s=null;this.color=null,this.getPolygon=i,this.getPts=e}i.d(e,"a",function(){return r})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=i(6),o=i(3),s=i(4);e.default={idrMapView:r.a,idrRegionEx:o.a,idrUnit:s.a}},function(t,e,i){"use strict";function r(){function t(){$=new o.a,$.setChangeFloorFunc(at,b);var t=at.regionEx.getFloorbyId(J);$.init(K,at.regionEx.floorList,t)}function e(t){it.fireEvent(at.eventTypes.onMapClick,t)}function i(t){X.start(Z,J,t,null)}function r(t,e){st=G.routerPath(t,e,!1),g(st)}function l(){st=null,ot.showRoutePath(null)}function g(t){ot.showRoutePath(t)}function m(t){it.fireEvent(at.eventTypes.onUnitClick,t)}function v(t,e){ot.updateUnitsColor(t,e)}function F(t){ot.clearUnitsColor(t)}function x(t){tt=[];for(var e=0;e<t.length;++e){var i=new u.a(t[e]);tt.push(i),i.getPolygon()}var r=at.regionEx.getFloorbyId(J);return r.unitList=tt,r.unitList}function _(){var t=at.regionEx.getFloorbyId(J);t.unitList&&t.unitList.length>0||n.a.serverCallUnits(Z,J,function(t){var e=x(t);ot.addUnits(e)},function(t){alert("获取unit失败!"+t)})}function y(){ot?ot.changeToFloor(J):(ot=new p.a(at),ot.init(at.regionEx,J,K))}function Y(){requestAnimationFrame(function(t){ot.updateDisplay(),nt&&nt.rotateToDegree(-1*ot.getMapRotate()*180/Math.PI)})}function R(){if(!nt){var t=document.createElement("div");t.setAttribute("id","composs"),K.appendChild(t),nt=new c.a("composs",0,at)}}function V(){y(Z,J),_()}function b(t){J=t,
at.regionEx.isSvgDataExist()?V():at.regionEx.loadSvgMaps(V)}function P(t,e,i){K=document.getElementById(e),f.a.init(t,function(){s.a.loadRegionInfo(i,function(t){at.regionEx=new h.a(t.data),G=new a.a(i,at.regionEx.floorList,function(){console.log("path data load success")}),Z=i,it.fireEvent(at.eventTypes.onInitMapSuccess,at.regionEx)},function(){console.log("load region data failed")})})}function T(){null==$&&(t(),R()),et=ot.root(),ot.updateRoutePath(st),ot.updateMinScale(),ot.setPos(W),it.fireEvent(at.eventTypes.onFloorChangeSuccess,{floorId:J,regionId:Z})}function A(t,e){return it.addEvent(t,e)}function L(t){return it.removeEvent(t)}function w(t,e){return it.fireEvent(t,e)}function k(t){if(t){for(var e=new Array,i=0;i<rt[t.position.floorId].length;++i){var r=rt[t.position.floorId][i];r.id!==t.id&&e.push(r)}rt[r.position.floorId]=e,t.removeFromSuperView()}}function S(t){return t in rt?rt[t]:null}function E(t){return rt.hasOwnProperty(t.position.floorId)||(rt[t.position.floorId]=new Array),rt[t.position.floorId].push(t),t.id="marker_"+t.position.floorId+"_"+rt[t.position.floorId].length,ot.addMarker(t),t}function C(t,e){if(!rt.hasOwnProperty(t))return null;for(var i=rt[t],r=0;r<i.length;++r)if(e===i[r].id)return i[r];return null}function I(t,e){var i=C(t,e);it.fireEvent(at.eventTypes.onMarkerClick,i)}function O(t){return ot.getMapPos(t)}function B(t){return ot.getSvgPos(t)}function U(t,e){ot.zoom(t,e)}function N(t){ot.scroll(t)}function z(t,e){ot.rotate(t,e)}function D(t){ot.centerPos(t)}function j(){ot.resetMap()}function q(){ot.birdLook()}function Q(t){if(st){r(t,G.getRouterParm().end),t=st.paths[0].position[0]}ot.setPos(t)}function H(t){W=t,t.floorId!==J?b(t.floorId):Q(t)}this.eventTypes=M.b,this.regionEx=null;var X=new d.a,G=null,K=null,W=null,Z=null,J=null,$=null,tt=[],et=null,it=new M.a,rt={},ot=null,st=null,nt=null,at=this;this.centerPos=D,this.resetMap=j,this.birdLook=q,this.getMapPos=O,this.getSvgPos=B,this.zoom=U,this.scroll=N,this.rotate=z,this.setCurrPos=H,this.addMarker=E,this.removeMarker=k,this.changeFloor=b,this.showRootPath=g,this.addComposs=R,this.initMap=P,this.addEventListener=A,this.removeEventListener=L,this.fireEvent=w,this.doRoute=r,this.doLocation=i,this.onUnitClick=m,this.onMapClick=e,this.onMarkerClick=I,this.getMarkers=S,this.updateUnitsColor=v,this.clearUnitsColor=F,this.stopRoute=l,this.updateDisplay=Y,this.onLoadMapSuccess=T,this.userPos=function(){return W}}i.d(e,"a",function(){return r});var o=i(7),s=i(8),n=i(0),a=i(9),h=i(3),u=i(4),l=i(16),c=i(18),M=i(19),f=i(2),d=i(20),p=i(22);l.a.IDRCarMarker},function(t,e,i){"use strict";function r(t,e){var i=document.getElementById(t);i&&(e?(i.classList.remove("fadeout"),i.classList.add("fadein")):(i.classList.remove("fadein"),i.classList.add("fadeout")))}function o(t){var e=s("div","currName","lc_div1 lc_divcom"),i=document.createElement("span");return i.innerText=t.name,e.appendChild(i),[e,i]}function s(t,e,i){var r=document.createElement(t);return null!==e&&(r.id=e),null!==i&&(r.className=i),r}function n(t,e,i){var r=[];return i.forEach(function(i,o){var n=s("div",i.id,"lc_div2 lc_divcom");n.innerText=i.name;var a=s("span",null,"lc_dot");a.innerText="●",a.style.opacity=0,n.appendChild(a),t&&t.id===i.id&&(n.className="lc_div3 lc_divcom"),e&&e.id===i.id&&(a.style.opacity=.5),r.push(n)}),r}function a(){function t(t){var e=null;return M.forEach(function(i,r){if(i.id==t)return e=i,!1}),e}function e(t,e,i){var h=o(t);m=h[0],g=h[1],v=s("div","floorDiv","lc_outo"),n(t,e,i).forEach(function(t,e){v.appendChild(t)}),p.appendChild(m),p.appendChild(v),r("floorDiv",!1),a()}function i(){g.innerText=f.name,Array.prototype.slice.call(v.children).forEach(function(t,e){t.id===f.id?t.className="lc_div3 lc_divcom":t.className="lc_div2 lc_divcom"})}function a(){var t=document.getElementById("floorDiv");document.getElementById("currName").click(function(){"block"===t.toDom().style.display?r("floorDiv",!1):r("floorDiv",!0)});for(var e=t.getElementsByClassName("lc_divcom"),i=0;i<e.length;++i)e[i].addEventListener("click",function(){r(this.id,!1),r("floorDiv",!1),"function"==typeof F&&F.call(x,this.id),c.setCurrentFloor(this.id)})}function h(t,i,r){M=i,f=r,d=M[0],p=s("div","lc_div","lc_div"),t.appendChild(p),e(f,d,M)}function u(e){f=t(e),i()}function l(t,e){F=e,x=t}var c=this,M=[],f=null,d=null,p=null,g=null,m=null,v=null,F=null,x=null;this.setCurrentFloor=u,this.setChangeFloorFunc=l,this.init=h}i.d(e,"a",function(){return a})},function(t,e,i){"use strict";function r(){this.regionAllInfo=null}i.d(e,"a",function(){return s});var o=i(0);r.prototype.loadRegionInfo=function(t,e,i){var r=this;o.a.serverCallRegionAllInfo(t,function(t){r.regionAllInfo=t,"function"==typeof e&&e(r.regionAllInfo)},i)};var s=new r},function(t,e,i){"use strict";function r(t,e,i){function r(t){for(var e=0;e<f.length;++e)if(f[e].id===t)return f[e].floorIndex;return-1}function a(){return{start:d,end:p,car:g}}function h(t){for(var e=0;e<f.length;++e)if(f[e].floorIndex===t)return f[e].id;return null}function u(t,e,i){return d=t,p=e,g=i,l(t,e,i)}function l(t,e,i){var o=r(t.floorId),n=r(e.floorId),a=new s.a;a.x=t.x,a.y=t.y;var u=new s.a;u.x=e.x,u.y=e.y;for(var l=m.search(o,a,n,u,i,null),c=0;c<l.paths.length;++c){var M=h(l.paths[c].floorIndex);l.paths[c].floorId=M;for(var f=0;f<l.paths[c].position.length;++f)l.paths[c].position[f].floorId=M}return l}function c(t,e){var i=new zip.Data64URIReader(t);zip.createReader(i,function(t){t.getEntries(function(i){i[0].getData(new zip.BlobWriter("text/plain"),function(i){t.close();var r=new FileReader;r.onload=function(){var t=JSON.parse(r.result);e(t)},r.readAsText(i)})})},onerror)}var M=t,f=e,d=null,p=null,g=!1,m=null;zip.workerScriptsPath="http://wx.indoorun.com/indoorun/webgl/sdk/modules/zip/",function(t){n.a.serverCallRouteData(M,function(e){c(e.data,function(e){m=new o.a(e),t&&t()})},null)}(i),this.getRouterParm=a,this.routerPath=u}i.d(e,"a",function(){return r});var o=i(10),s=i(1),n=i(0)},function(t,e,i){"use strict";function r(t){function e(t){var e=t.f,r=t.a,o=t.b,s=new a.a;s.floorIndex=e,s.distance=t.distance;var n=[];return null!=t.p2&&n.push(t.p2),null!=t.pe&&n.push(t.pe),i(e,r,o,n),null!=t.ps&&n.push(t.ps),null!=t.p1&&n.push(t.p1),n.reverse(),s.position=n,s}function i(t,e,i,r){var o=c[t].positions,s=c[t].matrix;if(-1!=e){var n=new h.a;for(n.x=o[i].x,n.y=o[i].y,r.push(n);i!=s[e][i].proIndex;)i=s[e][i].proIndex,n=new h.a,n.x=o[i].x,n.y=o[i].y,r.push(n)}}function r(t,e,i,r,o,s){if(t==i&&!s)return u(t,e,r,o,!0);var a=new n.a;a.f=-1;for(var h=Number.MAX_VALUE,l=0==o?M:f,c=l.positions,d=l.matrix,p=c.length,g=-1,m=-1,v=0;v<p;v++)if(c[v].floorIndex==t)for(var F=0;F<p;F++)if(c[F].floorIndex==i&&null!=d[v][F]){var x=u(t,e,c[v].pos,o,!0),_=u(i,c[F].pos,r,o,!0);if(null!=x&&null!=_){var y=x.distance+_.distance+d[v][F].length;y<h&&(h=y,g=v,m=F)}}if(-1==g)return null;a.a=g,a.b=m;var x=u(t,e,c[g].pos,o,!0),_=u(i,c[m].pos,r,o,!0);return a.p1=x.p1,a.ps=x.ps,a.p2=_.p2,a.pe=_.pe,a.distance=h,a}function u(t,e,i,s,a){var h=new n.a;h.f=t;var u=0,M=c[t].positions,f=c[t].lines,d=c[t].matrix,p=o.a.findNearestLine(e,f),g=o.a.findNearestLine(i,f),m=o.a.p2lDes(e,f[p]),v=o.a.p2lDes(i,f[g]);m.getDistance()>l&&(u+=m.distance,h.p1=e),v.getDistance()>l&&(u+=v.distance,h.p2=i);var F=m.position,x=v.position;if(h.ps=F,h.pe=x,p!=g){var _=o.a.findPositionIndex(f[p].endPointOne,M),y=o.a.findPositionIndex(f[p].endPointTwo,M),Y=o.a.findPositionIndex(f[g].endPointOne,M),R=o.a.findPositionIndex(f[g].endPointTwo,M),V=o.a.p2pDes(F,M[_]),b=o.a.p2pDes(F,M[y]),P=o.a.p2pDes(x,M[Y]),T=o.a.p2pDes(x,M[R]),A=Number.MAX_VALUE,L=-1,w=-1;if(null!=d[_][Y]&&(A=V+P+d[_][Y].length,L=_,w=Y),null!=d[_][R]&&V+T+d[_][R].length<A&&(A=V+T+d[_][R].length,L=_,w=R),null!=d[y][Y]&&b+P+d[y][Y].length<A&&(A=b+P+d[y][Y].length,L=y,w=Y),null!=d[y][R]&&b+T+d[y][R].length<A&&(A=b+T+d[y][R].length,L=y,w=R),-1==L)return a?null:r(t,e,t,i,s,!0);h.a=L,h.b=w,o.a.p2pDes(F,M[L])<1&&(h.ps=null),o.a.p2pDes(x,M[w])<1&&(h.pe=null),u+=A}else h.a=-1,u+=o.a.p2pDes(F,x);return h.distance=u,h}var l=10,c=t.floorPath,M=t.footPath,f=t.carPath;this.search=function(t,i,o,n,a,h){var l=null;if(null==h&&(h=r(t,i,o,n,a,!1)),null!=h){l=new s.a,l.distance=h.distance;var c=[];if(-1==h.f){var d=h.a,p=h.b,g=0==a?M:f,m=g.positions,v=g.matrix,F=p;for(c.push(e(u(o,m[p].pos,n,a,!0)));d!=v[d][p].proIndex;){if(p=v[d][p].proIndex,m[p].getFloorIndex()==m[F].getFloorIndex()){var x=e(u(m[p].getFloorIndex(),m[p].pos,m[F].pos,a,!0));x.typeId=m[F].unitTypeId,c.push(x)}F=p}var x=e(u(t,i,m[d].pos,a,!0));x.typeId=m[d].unitTypeId,c.push(x),c.reverse()}else c.push(e(h));l.paths=c}return l}}i.d(e,"a",function(){return r});var o=i(11),s=i(13),n=i(14),a=i(15),h=i(1)},function(t,e,i){"use strict";i.d(e,"a",function(){return s});var r=i(12),o=i(1),s=function(){function t(t,e){for(var i=0,r=Number.MAX_VALUE,o=e.length-1;o>=0;o--){var s=n(t,e[o]).getDistance();s<r&&(i=o,r=s)}return i}function e(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:t.y>e.y?1:0}function i(t,i){for(var r,o=0,s=i.length-1;o<=s;){r=o+s>>1;var n=e(t,i[r]);if(n<0)s=r-1;else{if(0==n)return r;o=r+1}}return-1}function s(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function n(t,e){return a(t.x,t.y,e.endPointOne.x,e.endPointOne.y,e.endPointTwo.x,e.endPointTwo.y)}function a(t,e,i,r,o,s){var n=(o-i)*(t-i)+(s-r)*(e-r);if(n<=0)return h(t,e,i,r);var a=(o-i)*(o-i)+(s-r)*(s-r);if(n>=a)return h(t,e,o,s);var u=n/a;return h(t,e,i+(o-i)*u,r+(s-r)*u)}function h(t,e,i,s){var n=new r.a,a=new o.a;return a.x=i,a.y=s,n.setPosition(a),n.setDistance(Math.sqrt((t-i)*(t-i)+(e-s)*(e-s))),n}return{findNearestLine:t,findPositionIndex:i,p2pDes:s,p2lDes:n}}()},function(t,e,i){"use strict";function r(){this.position=null,this.distance=0}i.d(e,"a",function(){return r}),r.prototype.getPosition=function(){return this.position},r.prototype.setPosition=function(t){this.position=t},r.prototype.getDistance=function(){return this.distance},r.prototype.setDistance=function(t){this.distance=t}},function(t,e,i){"use strict";function r(){this.paths=null,this.distance=0}i.d(e,"a",function(){return r})},function(t,e,i){"use strict";function r(){this.p1=null,this.p2=null,this.ps=null,this.pe=null,this.f=null,this.a=null,this.b=null,this.distance=null}i.d(e,"a",function(){return r})},function(t,e,i){"use strict";function r(){this.floorIndex=null,this.typeId=null,this.distance=null,this.position=null}i.d(e,"a",function(){return r})},function(t,e,i){"use strict";function r(t){this.position=t,this.id=null,this.image=h.a.mapMarker,this.className="IDRMapMarker",this.el=null,this.addToSuperView=function(t){var e=document.getElementById("markers");null===e&&(e=document.createElementNS("http://www.w3.org/2000/svg","g"),e.id="markers",t.appendChild(e)),this.el=document.createElementNS("http://www.w3.org/2000/svg","image"),this.el.setAttribute("id",this.id),this.el.setAttribute("width",60..toString()),this.el.setAttribute("height",80..toString()),this.el.href.baseVal=this.image,e.appendChild(this.el)},this.update=function(t,e){var i=t*Math.cos(e),r=-t*Math.sin(e),o=t*Math.sin(e),s=t*Math.cos(e),n=this.position.x-.5*this.el.width.baseVal.value,a=this.position.y-this.el.height.baseVal.value,h="matrix("+i+","+r+","+o+","+s+","+n+","+a+")";this.el.style.transform=h,this.el.style.webkitTransform=h},this.removeFromSuperView=function(){this.el.parentNode.removeChild(this.el)},this.resetPosition=function(t){_position=t}}function o(t){r.call(this,t),this.image=h.a.carMarker,this.className="IDRCarMarker"}function s(t){r.call(this,t),this.image=h.a.facMarker,this.className="IDRFacMarker"}function n(t){r.call(this,t),this.image=h.a.startMarker,this.className="IDRStartMarker"}function a(t){r.call(this,t),this.image=h.a.endMarker,this.className="IDREndMarker"}i.d(e,"a",function(){return u});var h=i(17),u={IDRMapMarker:r,IDRCarMarker:o,IDRFacMarker:s,IDRStartMarker:n,IDREndMarker:a}},function(t,e,i){"use strict";i.d(e,"a",function(){return r});var r={};r.mapMarker="/indoorun/app/yanli/indoorun/sdk/images/icon4.png",r.carMarker="/indoorun/app/yanli/indoorun/sdk/images/icon4.png",r.facMarker="/indoorun/app/yanli/indoorun/sdk/images/qi.png",r.startMarker="/indoorun/app/yanli/indoorun/sdk/images/start.png",r.endMarker="/indoorun/app/yanli/indoorun/sdk/images/end.png",r.composs="/indoorun/app/yanli/indoorun/sdk/images/resetMap.png"},function(t,e,i){"use strict";i.d(e,"a",function(){return o});var r=document.createElement("link");r.type="text/css",r.rel="stylesheet",r.href="http://wx.indoorun.com/indoorun/app/yanli/indoorun/sdk/modules/Composs/IDRComposs.css",document.querySelector("head").appendChild(r);var o=function(t,e,i){function r(){n.resetMap()}function o(t){a=t,s.style.transform="rotate("+a+"deg)"}var s=document.getElementById(t),n=i,a=0;s.addEventListener("click",r),this.rotateToDegree=o}},function(t,e,i){"use strict";function r(){this.events={},this.checkEvent=function(t){if(this.events.hasOwnProperty(t)){return null!==this.events[t]}return!1},this.removeEvent=function(t){return!!o.hasOwnProperty(t)&&(this.events[t]=null,!0)},this.fireEvent=function(t,e){if(!o.hasOwnProperty(t))return!1;var i=this.events[t];return i&&i(e),!0},this.addEvent=function(t,e){return!!o.hasOwnProperty(t)&&(this.events[t]=e,!0)}}i.d(e,"a",function(){return r}),i.d(e,"b",function(){return o});var o={onInitMapSuccess:"onInitMapSuccess",onFloorChangeSuccess:"onFloorChangeSuccess",onMapClick:"onMapClick",onMarkerClick:"onMarkerClick",onUnitClick:"onUnitClick"}},function(t,e,i){"use strict";function r(){function t(t){for(var e=[],i=0;i<t.length;++i){var r=t[i];if(0!=r.rssi){var o={accuracy:r.accuracy,major:r.major,minor:r.minor,rssi:r.rssi};e.push(o)}}return e}function e(e){var i=t(e),r=JSON.stringify(i);n=r}function i(){null===n&&(n="empty"),s.a.serverCallLocating(n,a,r,function(t){h=t.data.position.x,u=t.data.position.y,r=t.data.position.floorId,a=t.data.position.regionId,"function"==typeof l&&l({x:h,y:u,floorId:r,regionId:a})},function(t){"function"==typeof c&&c(t)})}var r="",n=null,a="",h=0,u=0,l=null,c=null,M=null,f=new o.a;f.onBeaconReceiveFunc=e,this.start=function(t,e,o,s){a=t,r=e,f.init(),l=o,c=s,M=setInterval(i,1e3)},this.stop=function(){clearInterval(M),n=null}}i.d(e,"a",function(){return r});var o=i(21),s=i(0)},function(t,e,i){"use strict";function r(){this.sAppId="",this.iTimestamp="",this.sNonceStr="",this.sSignature="",this.onBeaconReceiveFunc=""}function o(t){wx.config({debug:!1,appId:t.sAppId,timestamp:t.iTimestamp,nonceStr:t.sNonceStr,signature:t.sSignature,jsApiList:["checkJsApi","getNetworkType","getLocation","startSearchBeacons","onSearchBeacons","stopSearchBeacons","onMenuShareAppMessage","onMenuShareTimeline","getNetworkType","scanQRCode","onMenuShareQZone"]}),wx.ready(function(){wx.startSearchBeacons({complete:function(t){alert("开启蓝牙")}}),wx.onSearchBeacons({complete:function(e){var i=e.beacons;t.onBeaconReceiveFunc&&t.onBeaconReceiveFunc(i)}}),wx.stopSearchBeacons({complete:function(t){s()}})}),wx.error(function(t){})}function s(){wx.startSearchBeacons({ticket:"",complete:function(t){t&&t.errMsg}})}i.d(e,"a",function(){return r});var n=i(0);r.prototype.init=function(){var t=this;n.a.serverCallWxAuth(function(e){t.sAppId=e.appId,t.iTimestamp=e.timestamp,t.sNonceStr=e.nonceStr,t.sSignature=e.signature,o(t)},function(t){alert("getInfo()数据获取失败!")})}},function(t,e,i){"use strict";function r(t){function e(t){N=t,S=k.getFloorbyId(t),B.displayFloor(S.floorIndex)}function i(){w.onLoadMapSuccess()}function r(t,e,i){var r=document.createElement(t);return r.id=e,r.className=i,r}function o(t){E=r("div","mapRoot","svg_box"),I=document.getElementById("gl-canvas"),I||(I=r("canvas","gl-canvas","canvas-frame"),I.width=1080,I.height=1920),E.appendChild(I),C=document.getElementById("txt-canvas"),C||(C=r("canvas","txt-canvas","canvas-frame"),C.width=1080,C.height=1920),E.appendChild(C),t.appendChild(E)}function s(t,e){t.forEach(function(t){t.color=e}),S.unitList.forEach(function(t){t.color&&B.addQuickPolygon(S.floorIndex,t.getPts(),t.color)}),B.buildQuickPolygonFloor(S.floorIndex)}function n(t){t.forEach(function(t){t.color=null}),B.cleanQuickPolygonFloor(S.floorIndex)}function a(t){for(var e=0;e<t.length;++e){var i=t[e],r={};r.type=parseFloat(i.unitTypeId),r.text=i.name;var o=i.getPos();B.insertUnit(r,S.floorIndex,o.x,o.y)}}function h(t,e){return Math.sqrt((e.y-t.y)*(e.y-t.y)+(e.x-t.x)*(e.x-t.x))}function u(t,e){for(var i=null,r=1e4,o=0;o<S.unitList.length;++o){var s=S.unitList[o],n=h({x:t,y:e},s.getPos());n<r&&(i=s,r=n)}return i}function l(t,e){var i=B.searchMarker(t,e);if(-1!=i)return void w.onMarkerClick(N,i);var r=B.searchUnit(t,e);if(r.length>0){var o=u(r[0].x,r[0].y);return void w.onUnitClick(o)}var s=B.getTouchPosMapLoc(t,e);w.onMapClick({x:s.x,y:s.y,floorId:N})}function c(t){B.addTexture(t.className,t.image),B.insertTextureMarker(t.className,S.floorIndex,t.position.x,t.position.y,0,0,40)}function M(){}function f(t){}function d(t){if(!t)return void B.cleanLocation();var e=k.getFloorbyId(t.floorId);e&&B.setLocation(e.floorIndex,t.x,t.y)}function p(){B.overlookMap(k.getFloorIndex(N))}function g(t){}function m(t){}function v(){B.overlookRoute()}function F(t){var e=b(t,N),i=[];e.forEach(function(t){var e={};e.floor=k.getFloorIndex(t.floorId),e.x=t.x,e.y=t.y,i.push(e)}),B.setRoute(i)}function x(t){}function _(t){}function y(t,e){}function Y(t){}function R(){}function V(){}function b(t,e){if(!t)return null;for(var i=0;i<t.paths.length;++i){var r=t.paths[i];if(r.floorId===e)return r.position}return null}function P(){return A}function T(){return L}var A=1,L=0,w=t,k=null,S=null,E=null,C=null,I=null,O=[],B=null,U={onLoadFinish:function(t,e){},onLoadFailed:function(t,e){},onAllFloorLoadFinish:function(){i()},onStatusChange:function(t){},onAnimStart:function(t){},onAnimFinish:function(t){},onAnimCancel:function(t){},onClick:function(t,e){l(t,e)},onDClick:function(t,e){},on2FClick:function(t,e){},onLongPressUp:function(t,e){}},N=null;this.init=function(t,e,i){k=t,N=e,S=k.getFloorbyId(e),o(i);for(var r=0;r<k.floorList.length;++r){var s={};s.id=k.floorList[r].id,s.svg=k.floorSvgs[s.id],s.deflection=k.northDeflectionAngle,O.push(s)}B=new Region("testRegion",I,C,U),B.setUIScaleRate(.38333333),B.addFloorsSVG(O),B.startRender(),B.displayFloor(S.floorIndex),B.animPitch(0)},this.updateMinScale=function(){},this.getMapScale=P,this.getMapRotate=T,this.detach=M,this.attachTo=f,this.setPos=d,this.addMarker=c,this.resetMap=p,this.birdLook=v,this.showRoutePath=F,this.getSvgPos=_,this.updateUnitsColor=s,this.clearUnitsColor=n,this.getMapPos=x,this.zoom=m,this.scroll=g,this.rotate=y,this.centerPos=Y,this.updateDisplay=R,this.updateRoutePath=V,this.changeToFloor=e,this.addUnits=a,this.root=function(){return E}}i.d(e,"a",function(){return r})}]);