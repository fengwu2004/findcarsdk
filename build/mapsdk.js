!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";function n(t){function e(t,e){void 0!==h&&(p=setTimeout(function(){"jsonp"===r?document.body.removeChild(e):(d=!0,f&&f.abort()),console.log("timeout"),u&&u("请求超时!")},h))}var i=t.url||"",n=(t.type||"get").toLowerCase(),o=t.data||null,s=t.contentType||"",r=t.dataType||"",a=void 0===t.async&&!0,h=t.timeOut,l=t.before||function(){},u=t.error||function(){},c=t.success||function(){},d=!1,p=null,f=null;!function(){if(o){if("string"==typeof o){for(var t=0,e=(o=o.split("&")).length;t<e;t++)a=o[t].split("=")[0],h=o[t].split("=")[1],o[t]=encodeURIComponent(a)+"="+encodeURIComponent(h);console.log(o),console.log(typeof o),o=o.replace("/%20/g","+")}else if("object"==typeof o){var s=[];for(var a in o)if(void 0!==o[a]){var h=o[a].toString();a=encodeURIComponent(a),h=encodeURIComponent(h),s.push(a+"="+h)}o=s.join("&").replace("/%20/g","+")}"get"!==n&&"jsonp"!==r||(i+=i.indexOf("?")>-1?i.indexOf("=")>-1?"&"+o:o:"?"+o)}}(),l(),"jsonp"===r?function(){var t=document.createElement("script"),n="JSONP_"+((new Date).getTime()+Math.round(1e3*Math.random()));window[n]=function(e){clearTimeout(p),document.body.removeChild(t),c(e)},t.src=i+(i.indexOf("?")>-1?"&":"?")+"callback="+n,t.type="text/javascript",document.body.appendChild(t),e(0,t)}():((f=function(){if(window.XMLHttpRequest)return new XMLHttpRequest;for(var t=["Microsoft","msxm3","msxml2","msxml1"],e=0;e<t.length;e++)try{return new ActiveXObject(t[e]+".XMLHTTP")}catch(t){}}()).open(n,i,a),"post"!==n||s?s&&f.setRequestHeader("Content-Type",s):f.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),f.onreadystatechange=function(){if(4===f.readyState){if(void 0!==h){if(d)return;clearTimeout(p)}f.status>=200&&f.status<300||304==f.status?c(f.responseText):u(f.status,f.statusText)}},f.send("get"===n?null:o),e())}function o(t,e,i,o){n(e?{type:"get",dataType:"jsonp",url:t,data:e,timeOut:1e4,before:function(){},success:function(t){null!=t&&"success"==t.code?i&&i(t):o?o&&o(t):console.log(JSON.stringify(t))},error:function(t){o?o&&o(t):console.log(JSON.stringify(t))}}:{type:"get",dataType:"jsonp",url:t,timeOut:1e4,before:function(){},success:function(t){null!=t&&"success"==t.code?i&&i(t):o?o&&o(t):console.log(JSON.stringify(t))},error:function(t){o?o&&o(t):console.log(JSON.stringify(t))}})}i.r(e);const s=new class{constructor(){this.host="https://wx.indoorun.com/";var t=navigator.userAgent;null!=t.match(/iPhone|iPod/i)?this.osType="iPhone":null!=t.match(/Android/i)?this.osType="Android":this.osType="unknow",this.sessionKey=null,this.appId=null,this.clientId=null}doAjax(t,e,i,n){e.appId=this.appId,this.sessionKey&&(e.sessionKey=this.sessionKey),this.clientId&&(e.clientId=this.clientId),o(t,e,i,n)}serverCallWxAuth(){var t=this.host+"wxauth/getAuthParas?reqUrl="+window.location.href;return new Promise((e,i)=>{o(t,null,t=>{e(t)},t=>{i(t)})})}serverCallInitSession(){var t="appId="+this.appId+"&clientId="+this.clientId+"&time=null&sign=null";const e=this.host+"wx/initSession.html?"+t;return new Promise((t,i)=>{o(e,{},e=>{this.sessionKey=e.sessionKey,t(e)},t=>{i(t)})})}serverCallWXSign(t){this.appId=t;var e=this.host+"wx/getSign.html";return new Promise((i,n)=>{this.doAjax(e,{appId:t},t=>{this.clientId=t.clientId,i(t)},t=>{n(t)})})}serverCallRegionPathData(t){var e=this.host+"wx/getRegionPathData";return new Promise((i,n)=>{this.doAjax(e,{regionId:t},t=>{i(t)},t=>{n(t)})})}serverCallRegionAllInfo(t){var e=this.host+"wx/getRegionData";return new Promise((i,n)=>{this.doAjax(e,{regionId:t},t=>{i(t)},t=>{n(t)})})}getMarkedUnit(t){var e=this.host+"chene/getCheLocation.html",i={regionId:t};return new Promise((t,n)=>{this.doAjax(e,i,e=>{t(e)},t=>{n(t)})})}removeMarkedUnit(t,e,i){var n=this.host+"chene/removeCheLocation.html",o={regionId:t};this.doAjax(n,o,e,i)}saveMarkedUnit(t,e,i){var n=t.getPos(),o=JSON.stringify({svgX:n.x,svgY:n.y,floorId:t.floorId,regionId:t.regionId}),s=this.host+"chene/saveCheLocation.html",r={sName:o};this.doAjax(s,r,e,i)}getParkingPlaceUnitByCarNo(t,e){var i=this.host+"chene/getParkingPlaceUnitByCarNo.html",n={regionId:e,carNo:t};return new Promise((t,e)=>{this.doAjax(i,n,e=>{t(e)},t=>{e(t)})})}parksOverview(t){let e={regionId:t};return new Promise((t,i)=>{let n=this.host+"thxz/pc/parksOverview";this.doAjax(n,e,e=>{t(e)},t=>{i(t)})})}serverCallLocatingBin({beacons:t,count:e,regionId:i,floorId:n},o,s){var r={version:1,beacons:t,gzId:"ewr2342342",openId:"wx_oBt8bt-1WMXu67NNZI-JUNQj6UAc",OSType:this.osType,regionId:i,floorId:n,beaconCount:e};t||(r={version:1,beacons:"",gzId:"ewr2342342",openId:"wx_oBt8bt-1WMXu67NNZI-JUNQj6UAc",OSType:this.osType,regionId:i,floorId:n,beaconCount:e});var a=this.host+"locate/locatingBin";this.doAjax(a,r,o,s)}};function r(){this.position=null,this.distance=0}function a(){this.x=0,this.y=0}r.prototype.getPosition=function(){return this.position},r.prototype.setPosition=function(t){this.position=t},r.prototype.getDistance=function(){return this.distance},r.prototype.setDistance=function(t){this.distance=t},a.prototype.getX=function(){return this.x},a.prototype.setX=function(t){this.x=t},a.prototype.getY=function(){return this.y},a.prototype.setY=function(t){this.y=t},a.prototype.hashCode=function(){return this.x+this.y},a.prototype.equals=function(t){return null!=t&&t instanceof a&&(this.x==pos.x&&this.y==pos.y)},a.prototype.compareTo=function(t){return this.getX()<t.getX()?-1:this.getX()>t.getX()?1:this.getY()<t.getY()?-1:this.getY()>t.getY()?1:0},a.prototype.string=function(){return this.x+","+this.y};var h=function(){function t(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:t.y>e.y?1:0}function e(t,e){return function(t,e,n,o,s,r){var a=(s-n)*(t-n)+(r-o)*(e-o);if(a<=0)return i(t,e,n,o);var h=(s-n)*(s-n)+(r-o)*(r-o);if(a>=h)return i(t,e,s,r);var l=a/h;return i(t,e,n+(s-n)*l,o+(r-o)*l)}(t.x,t.y,e.endPointOne.x,e.endPointOne.y,e.endPointTwo.x,e.endPointTwo.y)}function i(t,e,i,n){var o=new r,s=new a;return s.x=i,s.y=n,o.setPosition(s),o.setDistance(Math.sqrt((t-i)*(t-i)+(e-n)*(e-n))),o}return{findNearestLine:function(t,i){for(var n=0,o=Number.MAX_VALUE,s=i.length-1;s>=0;s--){var r=e(t,i[s]).getDistance();r<o&&(n=s,o=r)}return n},findPositionIndex:function(e,i){for(var n,o=0,s=i.length-1;o<=s;){var r=t(e,i[n=o+s>>1]);if(r<0)s=n-1;else{if(0==r)return n;o=n+1}}return-1},p2pDes:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},p2lDes:e}}();function l(){this.p1=null,this.p2=null,this.ps=null,this.pe=null,this.f=null,this.a=null,this.b=null,this.distance=null}function u(t){var e=10,i=t.floorPath,n=t.footPath,o=t.carPath;function s(t){var e=t.f,n=t.a,o=t.b,s=new function(){this.floorIndex=null,this.typeId=null,this.distance=null,this.position=null};s.floorIndex=e,s.distance=t.distance;var r=[];return null!=t.p2&&r.push(t.p2),null!=t.pe&&r.push(t.pe),function(t,e,n,o){var s=i[t].positions,r=i[t].matrix;if(-1==e)return;var h=new a;h.x=s[n].x,h.y=s[n].y,o.push(h);for(;n!=r[e][n].proIndex;)n=r[e][n].proIndex,(h=new a).x=s[n].x,h.y=s[n].y,o.push(h)}(e,n,o,r),null!=t.ps&&r.push(t.ps),null!=t.p1&&r.push(t.p1),r.reverse(),s.position=r,s}function r(t,e,i,s,r,a){if(t==i&&!a)return u(t,e,s,r,!0);var h=new l;h.f=-1;for(var c=Number.MAX_VALUE,d=0==r?n:o,p=d.positions,f=d.matrix,g=p.length,_=-1,v=-1,x=0;x<g;x++)if(p[x].floorIndex==t)for(var m=0;m<g;m++)if(p[m].floorIndex==i&&null!=f[x][m]){var I=u(t,e,p[x].pos,r,!0),y=u(i,p[m].pos,s,r,!0);if(null!=I&&null!=y){var P=I.distance+y.distance+f[x][m].length;P<c&&(c=P,_=x,v=m)}}if(-1==_)return null;h.a=_,h.b=v;I=u(t,e,p[_].pos,r,!0),y=u(i,p[v].pos,s,r,!0);return h.p1=I.p1,h.ps=I.ps,h.p2=y.p2,h.pe=y.pe,h.distance=c,h}function u(t,n,o,s,a){var u=new l;u.f=t;var c=0,d=i[t].positions,p=i[t].lines,f=i[t].matrix,g=h.findNearestLine(n,p),_=h.findNearestLine(o,p),v=h.p2lDes(n,p[g]),x=h.p2lDes(o,p[_]);v.getDistance()>e&&(c+=v.distance,u.p1=n),x.getDistance()>e&&(c+=x.distance,u.p2=o);var m=v.position,I=x.position;if(u.ps=m,u.pe=I,g!=_){var y=h.findPositionIndex(p[g].endPointOne,d),P=h.findPositionIndex(p[g].endPointTwo,d),w=h.findPositionIndex(p[_].endPointOne,d),M=h.findPositionIndex(p[_].endPointTwo,d),L=h.p2pDes(m,d[y]),S=h.p2pDes(m,d[P]),E=h.p2pDes(I,d[w]),b=h.p2pDes(I,d[M]),T=Number.MAX_VALUE,C=-1,k=-1;if(null!=f[y][w]&&(T=L+E+f[y][w].length,C=y,k=w),null!=f[y][M]&&L+b+f[y][M].length<T&&(T=L+b+f[y][M].length,C=y,k=M),null!=f[P][w]&&S+E+f[P][w].length<T&&(T=S+E+f[P][w].length,C=P,k=w),null!=f[P][M]&&S+b+f[P][M].length<T&&(T=S+b+f[P][M].length,C=P,k=M),-1==C)return a?null:r(t,n,t,o,s,!0);u.a=C,u.b=k,h.p2pDes(m,d[C])<1&&(u.ps=null),h.p2pDes(I,d[k])<1&&(u.pe=null),c+=T}else u.a=-1,c+=h.p2pDes(m,I);return u.distance=c,u}this.search=function(t,e,i,a,h,l){var c=null;if(null==l&&(l=r(t,e,i,a,h,!1)),null!=l){(c=new function(){this.paths=null,this.distance=0}).distance=l.distance;var d=[];if(-1==l.f){var p=l.a,f=l.b,g=0==h?n:o,_=g.positions,v=g.matrix,x=f;for(d.push(s(u(i,_[f].pos,a,h,!0)));p!=v[p][f].proIndex;){var m;if(_[f=v[p][f].proIndex].floorIndex==_[x].floorIndex)(m=s(u(_[f].floorIndex,_[f].pos,_[x].pos,h,!0))).typeId=_[x].unitTypeId,d.push(m);x=f}(m=s(u(t,e,_[p].pos,h,!0))).typeId=_[p].unitTypeId,d.push(m),d.reverse()}else d.push(s(l));c.paths=d}return c}}function c(t,e){var i=t,n=null,o=null,s=!1,r=new u(e);function h(t){for(var e=0;e<i.length;++e)if(i[e].floorIndex===t)return i[e].id;return null}this.getRouterParm=function(){return{start:n,end:o,car:s}},this.routerPath=function(t,e,i){return n=t,o=e,s=i,function(t,e,i){var n=t.floorIndex,o=e.floorIndex,s=new a;s.x=t.x,s.y=t.y;var l=new a;l.x=e.x,l.y=e.y,console.log("导航起始点"),console.log(JSON.stringify(t)),console.log(JSON.stringify(e)),console.log("导航起始点--");for(var u=r.search(n,s,o,l,i,null),c=[],d=[],p=0;p<u.paths.length;++p){var f=h(u.paths[p].floorIndex);d.push({floor:u.paths[p].floorIndex,type:u.paths[p].typeId}),u.paths[p].floorId=f;for(var g=0;g<u.paths[p].position.length;++g)c.push({x:u.paths[p].position[g].x,y:u.paths[p].position[g].y,floor:u.paths[p].floorIndex}),u.paths[p].position[g].floorId=f}return u.path=c,u.floorType=d,u}(t,e,i)}}class d{constructor(){this.items=[]}enqueue(t,e){var i=new function(t,e){this.ele=t,this.priority=e}(t,e);if(this.isEmpty())this.items.push(i);else{for(var n=!1,o=0,s=this.items.length;o<s;o++)if(e<this.items[o].priority){this.items.splice(o,0,i),n=!0;break}n||this.items.push(i)}}dequeue(){return this.items.shift()}front(){return this.items[0]}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}print(){for(var t=[],e=0,i=this.items.length;e<i;e++)t.push(this.items[e].ele);console.log(t.toString())}}class p{constructor(){this.List=[],this.floorType=-1,this.distance=0}}var f=function(){function t(e,i){return t(e.x,e.y,i.getEndPointOne().x,i.getEndPointOne().y,i.getEndPointTwo().x,i.getEndPointTwo().y)}function t(t,i,n){return function(t,i,n,o,s,r){var a=(s-n)*(t-n)+(r-o)*(i-o);if(a<=0)return e(t,i,n,o);var h=(s-n)*(s-n)+(r-o)*(r-o);if(a>=h)return e(t,i,s,r);var l=a/h;return e(t,i,n+(s-n)*l,o+(r-o)*l)}(t.x,t.y,i.x,i.y,n.x,n.y)}function e(t,e,i,n){var o=new r,s=new a;return s.setX(i),s.setY(n),o.setPosition(s),o.setDistance(Math.sqrt((t-i)*(t-i)+(e-n)*(e-n))),o}return{findNearestLine:function(e,i,n){let o=0,s=Number.MAX_VALUE;for(let r=0;r<n.length;r+=2){let a=t(e,i[n[r]],i[n[r+1]]).getDistance();a<s&&(o=r,s=a)}return o},findPositionIndex:function(t,e){let i,n=0,o=e.length-1;for(;n<=o;){i=n+o>>1;let s=t.compareTo(e[i]);if(s<0)o=i-1;else{if(0==s)return i;n=i+1}}return-1},p2pDes:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},p2lDes:t}}();class g{constructor(t,e){this.x=e.x,this.y=e.y,this.floor=t}}const _=10;class v{constructor(t,e,i){this.floor=t,this.pos=e,this.dis=i}}class x{constructor(t){this.pa=null,this.pb=null,this.floorPath=[],this.footPath=[[]],this.carPath=[[]],this.vis=[[]],this.dis=[[]],this.pre=[[[]]],this.queue=new d,this.index1=-1,this.setData(t)}setData(t){this.floorPath=t.floorPath,this.footPath=t.footPath,this.carPath=t.carPath;var e=this.floorPath.length;this.vis.length=e,this.dis.length=e,this.pre.length=e;for(let t=0;t<e;t++){var i=this.floorPath[t].positions.length;this.vis[t]=[],this.vis[t].length=i,this.dis[t]=[],this.dis[t].length=i,this.pre[t]=[],this.pre[t].length=i;for(let e=0;e<i;++e)this.pre[t][e]=[],this.pre[t][e].length=2}}clearData(){var t=this.floorPath.length;for(let e=0;e<t;e++){let t=this.floorPath[e].positions.length;for(let i=0;i<t;i++)this.vis[e][i]=!1,this.dis[e][i]=Number.MAX_VALUE}this.queue.clear()}search(t,e,i,n,o,s){let r=new p,a=[];a.push(i);let h=[];var l=this.startSearch(t,e,s);let u=0,c=Number.MAX_VALUE,d=i,v=-1,x=-1,m=-1,I=null,y=null;if(null!=o&&o.length>0){for(let t=0;t<o.length;++t){let e=o[t];x=f.findNearestLine(e,this.floorPath[i].positions,this.floorPath[i].lines);let s=this.floorPath[i].lines[x],r=this.floorPath[i].lines[x+1],a=f.p2lDes(e,this.floorPath[i].positions[s],this.floorPath[i].positions[r]).getPosition(),h=f.p2pDes(a,e)+f.p2pDes(n,e),l=f.p2pDes(a,this.floorPath[i].positions[s]),u=f.p2pDes(a,this.floorPath[i].positions[r]);this.vis[i][s]&&this.dis[i][s]+l+h<c&&(c=this.dis[i][s]+l+h,m=x,v=s,I=e,y=a),this.vis[i][r]&&this.dis[i][r]+u+h<c&&(c=this.dis[i][r]+u+h,m=x,v=r,I=e,y=a)}u=c,h.push(new g(i,n)),f.p2pDes(y,I)>_&&h.push(new g(i,I))}else{m=f.findNearestLine(n,this.floorPath[i].positions,this.floorPath[i].lines);let t=this.floorPath[i].lines[m],e=this.floorPath[i].lines[m+1],o=f.p2lDes(n,this.floorPath[i].positions[t],this.floorPath[i].positions[e]);y=o.getPosition(),o.getDistance()>_&&(h.push(new g(i,n)),u=o.getDistance());let s=f.p2pDes(y,this.floorPath[i].positions[t]),r=f.p2pDes(y,this.floorPath[i].positions[e]);this.vis[i][t]&&(v=t,u+=this.dis[i][t]+s),this.vis[i][e]&&this.dis[i][e]+r<u&&(v=e,u=this.dis[i][e]+r)}if(v<0)return null;let P=!1;for(h.push(new g(i,y)),d==t&&m==this.index1||h.push(new g(d,this.floorPath[d].positions[v]));d>=0;){let t=this.pre[d][v];if(P=t[0]==d,d=t[0],v=t[1],d<0)break;h.push(new g(d,this.floorPath[d].positions[v])),P||(a.push(this.floorPath[d].adjacency[v][2]),a.push(d))}return h.push(new g(t,l.getPosition())),l.getDistance()>_&&h.push(new g(t,e)),h.reverse(),a.reverse(),r.path=h,r.floorType=a,r.distance=u,r}startSearch(t,e,i){this.clearData(),this.index1=f.findNearestLine(e,this.floorPath[t].positions,this.floorPath[t].lines);let n=this.floorPath[t].lines[this.index1],o=this.floorPath[t].lines[this.index1+1],s=f.p2lDes(e,this.floorPath[t].positions[n],this.floorPath[t].positions[o]),r=s.getPosition(),a=f.p2pDes(r,this.floorPath[t].positions[n]),h=f.p2pDes(r,this.floorPath[t].positions[o]),l=0;for(s.getDistance()>_&&(l+=s.getDistance()),this.addNode(t,n,l+a,-1,-1),this.addNode(t,o,l+h,-1,-1);!this.queue.isEmpty();)this.dijkstra(i);return s}addNode(t,e,i,n,o){this.dis[t][e]=i,void 0==this.pre[t][e]&&(this.pre[t][e]=[],this.pre[t][e].length=2),this.pre[t][e][0]=n,this.pre[t][e][1]=o,this.queue.enqueue(new v(t,e,i),i)}dijkstra(t){let e=this.queue.dequeue(),i=e.ele.floor,n=e.ele.pos;if(this.vis[i][n])return;let o=e.ele.dis,s=this.floorPath[i].adjacency[n];for(let t=3;t<s.length;t+=2){let e=s[t];if(!this.vis[i][e]){let r=s[t+1]+o;r<this.dis[i][e]&&this.addNode(i,e,r,i,n)}}if(s[0]==t){s=(0==t?this.footPath:this.carPath)[s[1]];for(let t=0;t<s.length;t+=3){let e=s[t],r=s[t+1];if(!this.vis[e][r]){let a=s[t+2]+o;a<this.dis[e][r]&&this.addNode(e,r,a,i,n)}}}this.vis[i][n]=!0}}function m(t,e){var i=null,n=null,o=!1,s=new x(e);this.getRouterParm=function(){return{start:i,end:n,car:o}},this.routerPath=function(t,e,r,h){return i=t,n=e,o=r,function(t,e,i,n){var o=t.floorIndex,r=e.floorIndex,h=new a;h.x=t.x,h.y=t.y;var l=new a;l.x=e.x,l.y=e.y,console.log("导航起始点"),console.log(JSON.stringify(t)),console.log(JSON.stringify(e)),console.log("导航起始点--");var u=s.search(o,h,r,l,n,i);let{floorType:c}=u;c.push(0);var d=[];for(let t=0;t<c.length;)d.push({floor:c[t],type:c[t+1]}),t+=2;return u.floorType=d,u}(t,e,r,h)}}class I{constructor(t,e,i,n){const{boundLeft:o,boundRight:s,boundTop:r,boundBottom:a,unitTypeId:h,id:l,name:u,points:c,extInfo:d}=t;this.id=l,this.name=u,this.boundLeft=o,this.boundRight=s,this.boundTop=r,this.boundBottom=a,this.floorName=e,this.floorIndex=i,this.floorId=n,this.unitTypeId=h,c&&(this.points=c.split(" ")),this.extInfo=d,this.extInfo&&this.extInfo.linkPoints?this.junctions=this.extInfo.linkPoints.map(t=>Object.assign({},t,{floorId:this.floorId})):this.junctions=null,this._pts=null,this._points=null,this.position=this.getPos()}getPos(){return{x:.5*(this.boundLeft+this.boundRight),y:.5*(this.boundTop+this.boundBottom),floorId:this.floorId,floorIndex:this.floorIndex}}getPts(){if(this._pts)return this._pts;let t=this.getPolygon();return this._pts=t.map(t=>{let e=t.split(",").map(Number);return YFM.Math.Vector.pos(e[0],e[1])}),this._pts}adjustPolygon(t){const e=t[0].split(","),i=parseFloat(e[0]),n=parseFloat(e[1]),o=t[1].split(","),s=parseFloat(o[0]),r=parseFloat(o[1]),a=t[2].split(","),h=parseFloat(a[0]),l=parseFloat(a[1]);if(Math.hypot(s-i,r-n)<Math.hypot(h-s,l-r))return t;const u=t[0];return t.shift(),t.push(u),t}getPolygon(){return this._points?this._points:(this._points=this.adjustPolygon(this.points),this._points)}}class y{constructor(t){let{floorList:e,defaultFloorId:i,address:n,telephone:o,latitude:s,longitude:r,name:a,northDeflectionAngle:h}=t;this.floorList=e.sort((t,e)=>t.floorIndex>e.floorIndex?1:t.floorIndex<e.floorIndex?-1:0),this.longitude=r,this.latitude=s,this.defaultFloorId=i,this.telephone=o,this.address=n,this.name=a,this.northDeflectionAngle=h,this._generateUnits()}_generateUnits(){for(var t=0;t<this.floorList.length;++t){const{unitList:e}=this.floorList[t];delete this.floorList[t].unitList;const{name:i,floorIndex:n,id:o}=this.floorList[t];this.floorList[t].unitList=e.map(t=>new I(t,i,n,o)),this.floorList[t].unitsMap=new Map;for(let e=0;e<this.floorList[t].unitList.length;++e)this.floorList[t].unitsMap.set(this.floorList[t].unitList[e].id,this.floorList[t].unitList[e])}}findUnitOfFloor(t,e){for(var i=this.floorList[t],n=null,o=e.toLowerCase(),s=0;s<i.unitList.length;++s){var r=i.unitList[s],a=r.name.toLowerCase().indexOf(o);-1!==a&&a+e.length==r.name.length&&(n||(n=[]),n.push(r))}return n?n[0]:n}getFloorName(t){for(var e=0;e<this.floorList.length;++e){var i=this.floorList[e];if(i.floorIndex===t)return i.name}return""}getFloorIndex(t){for(var e=0;e<this.floorList.length;++e){var i=this.floorList[e];if(i.id===t)return i.floorIndex}return null}getFloorByIndex(t){for(var e=0;e<this.floorList.length;++e){var i=this.floorList[e];if(i.floorIndex===t)return i}return null}getFloorbyId(t){for(var e=0;e<this.floorList.length;++e){var i=this.floorList[e];if(i.id===t)return i}return null}getUnitById(t,e){var i=this.getFloorbyId(t);return null==i?null:i.unitsMap.get(e)}getUnitWithId(t){for(let e=0;e<this.floorList.length;++e){let i=this.floorList[e].unitsMap.get(t);if(null!=i)return i}return null}getDistance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}getNearUnit(t,e){if(!t)return null;e||(e=this.getFloorByIndex(t.floorIndex).unitList);for(var i=null,n=1e4,o=0;o<e.length;++o){var s=e[o];if(s.floorIndex===t.floorIndex){var r=this.getDistance(t,s.getPos());r<n&&(n=r,i=s)}}return i}}var P={onInitMapSuccess:"onInitMapSuccess",onFloorChangeSuccess:"onFloorChangeSuccess",onMapClick:"_onMapClick",onMarkerClick:"_onMarkerClick",onUnitClick:"_onUnitClick",onRouterSuccess:"onRouterSuccess",onRouterFinish:"onRouterFinish",onMapLongPress:"_onMapLongPress",onMapScroll:"_onMapScroll",onRouterFailed:"onRouterFailed",onRouterPathUpdate:"onRouterPathUpdate",onNaviStatusUpdate:"onNaviStatusUpdate"};const w=new class{constructor(){this.time="null",this.sign="null";var t=navigator.userAgent;this.isAndroid=t.indexOf("Android")>-1||t.indexOf("Adr")>-1;let e=this.getQueryString("uuid");this.clientId=e,this.isApp=void 0!=e}_initWx(t){return s.serverCallWXSign(t)}getQueryString(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(e);return null!=i?decodeURI(i[2]):null}_initSession(){return s.serverCallInitSession()}init(t){return this.isApp?(s.appId=t,s.clientId=this.clientId,new Promise(t=>{this._initSession().then(()=>{t()})})):new Promise((e,i)=>{this._initWx(t).then(()=>this._initSession()).then(t=>{e(t)}).catch(t=>{i(t)})})}};var M=new function(){this.label=document.getElementById("debug"),this.debugInfo=function(t){this.label.innerText=t},this.showDebugInfo=function(t){this.label.style.visibility=t?"visible":"hidden"}};const L="Bluetooth_poweroff";var S=new class{constructor(){this._beaconStart=!1,this._configSuccess=!1,this.onBeaconReceiveFunc=null;var t=navigator.userAgent;this.isAndroid=t.indexOf("Android")>-1||t.indexOf("Adr")>-1}init(){return new Promise((t,e)=>{s.serverCallWxAuth().then(t=>this.configWx(t)).then(t=>(this._configSuccess=!0,this.startBeacon())).then(e=>{this._beaconStart=!0,this.onSearchBeacons(),t()}).catch(t=>{e(t)})})}startBeacon(){return new Promise((t,e)=>{this.stopBeacon().then(i=>{wx.startSearchBeacons({ticket:"",complete:i=>{"startSearchBeacons:bluetooth power off"==i.errMsg?e(L):t()}})})})}stopBeacon(){return new Promise((t,e)=>{wx.stopSearchBeacons({complete:e=>{t()}})})}onSearchBeacons(){wx.onSearchBeacons({complete:t=>{var e=t.beacons;this.onBeaconReceiveFunc&&this.onBeaconReceiveFunc(e)}})}configWx({appId:t,timestamp:e,nonceStr:i,signature:n}){return this._configSuccess?Promise.resolve():new Promise((o,s)=>{wx.config({debug:!1,appId:t,timestamp:e,nonceStr:i,signature:n,jsApiList:["checkJsApi","getNetworkType","getLocation","startSearchBeacons","onSearchBeacons","stopSearchBeacons","onMenuShareAppMessage","onMenuShareTimeline","getNetworkType","openLocation","scanQRCode","onMenuShareQZone"]}),wx.ready(()=>{o("成功")}),wx.error(t=>{s(t)})})}};var E=new class{constructor(){this._floorId="",this._beacons=null,this._count=0,this._mapId="",this._x=0,this._y=0,this._started=!1,this._onLocateSuccess=null,this._onLocateFailed=null,this._locateTimerId=null,this.onCheckSpeacialBeacons=null,this.mapInfo=null,this.debug=!1,this.debugPos=null,this.result=null}_getValidBeacons(t){var e=[];if(!t)return[];for(var i=0; i<t.length; ++i)0!==parseInt(t[i].rssi)&&e.push(t[i]);return e}filterbeacons(t){for(var e=this._getValidBeacons(t),i="",n=0; n<e.length; ++n){const t=e[n],{major:c,minor:d,rssi:p}=t;var o=parseInt(100*t.accuracy),s=String.fromCharCode(255&o),r=String.fromCharCode((65280&o)>>8),a=String.fromCharCode(parseInt(p)+256),h=String.fromCharCode(255&parseInt(d)),l=String.fromCharCode((65280&parseInt(d))>>8),u=String.fromCharCode(255&parseInt(c));i+=String.fromCharCode((65280&parseInt(c))>>8)+u+l+h+a+r+s}return{beacons:i,count:e.length}}onReceiveBeacons(t){var e=t;w.isAndroid&&w.isApp&&(e=JSON.parse(t),M.showDebugInfo(!0));var i=this.filterbeacons(e);this.onCheckSpeacialBeacons&&this.onCheckSpeacialBeacons(e),this._beacons=window.btoa(i.beacons),this._count=i.count,M.debugInfo("蓝牙数量"+this._count)}onServerLocate_Debug(){null!=this.debugPos?this.result=this.debugPos:this.result={x:1e3,y:480,floorIndex:1,regionId:"15208407076393939"},"function"==typeof this._onLocateSuccess&&this._onLocateSuccess(this.result)}onServerLocate(){s.serverCallLocatingBin({beacons:this._beacons,count:this._count,regionId:this._mapId,floorId:this._floorId}, t=>{this._x=t.x,this._y=t.y,this._floorId=t.floorId;let e=this.mapInfo.getFloorIndex(t.floorId);"function"==typeof this._onLocateSuccess&&this._onLocateSuccess({x:this._x,y:this._y,floorId:this._floorId,regionId:this._mapId,floorIndex:e})}, t=>{"function"==typeof this._onLocateFailed&&this._onLocateFailed(t)})}setLocateDelegate(t, e){this._onLocateSuccess=t,this._onLocateFailed=e,S.onBeaconReceiveFunc=(t=>this.onReceiveBeacons(t))}start(t, e){return this._mapId=t,this._floorId=e,w.isApp?new Promise((t, e)=>{clearInterval(this._locateTimerId),this._locateTimerId=setInterval(()=>this.onServerLocate(),1e3),t()}):this.debug?new Promise((t, e)=>{clearInterval(this._locateTimerId),this._locateTimerId=setInterval(()=>this.onServerLocate_Debug(),1e3),t()}):new Promise((t, e)=>{S.init().then(e=>{clearInterval(this._locateTimerId),this._locateTimerId=setInterval(()=>this.onServerLocate(),1e3),t()}).catch(t=>{e(t)})})}stop(){clearInterval(this._locateTimerId),this._started=!1,this._beacons=null}};window.locateServer=E;class b{constructor(t){var e=navigator.userAgent.toLowerCase();this.isAndroid="android"==e.match(/android/i),this._csscale=2.5,this.screenwidth=0,this.screenheight=0,this._mapScale=1,this._mapView=t,this._regionEx=null,this._floor=null,this._mapRoot=null,this._canvas_txt=null,this._canvas_gl=null,this._floorList=[],this._region=null,this._currentFloorIndex=-1,this._unitAddFloor={},this.listener={onAllFloorLoadFinish:()=>{this.onAllFloorLoaded()},onStatusChange:function(t){},onAnimStart:function(t){},onAnimFinish:function(t){},onAnimCancel:function(t){},onClick:(t,e)=>{this.handleClick(t,e)},onScroll:(t,e)=>{this.handleMapScroll(t,e)}}}init(t,e,i){this._regionEx=t,this._currentFloorIndex=e,this._floor=this._regionEx.getFloorByIndex(e),this.createCanvas(i);for(var n=0;n<this._regionEx.floorList.length;++n){var o={};o.index=this._regionEx.floorList[n].floorIndex,o.svg=this._regionEx.floorList[n].mapSvg,o.deflection=this._regionEx.northDeflectionAngle,this._floorList.push(o)}this._region=new YFM.Map.Region("testRegion",this._canvas_gl,this._canvas_txt,this.listener),this._region.setUIScaleRate(1/this._csscale),this._region.addTexture("pubIcons","./static/img_pub_icons.png"),this._region.addTexture("parking","./static/img_parking.png"),this._region.addTextureMip("route_tex","./static/tex_route.png"),this._region.addFloorsSVG(this._floorList),this._region.setFontColor("#825537"),this._region.setFontType("24px Arial"),this._region.startRender(),this._region.displayFloor(this._floor.floorIndex),this._region.animPitch(0),this._region.setAlwaysDrawUnit(!0),this.isAndroid?this._region.addTexture("locatepos","./static/locatepos_noheading.png"):this._region.addTexture("locatepos","./static/locatepos.png"),this._region.setLocMarkerParam("locatepos",1880379522,200,75)}changeToFloor(t){this._currentFloorIndex=t,this._floor=this._regionEx.getFloorByIndex(t),this._region.displayFloor(this._floor.floorIndex),this.onAllFloorLoaded()}onAllFloorLoaded(){this._mapView.onLoadMapSuccess()}setStatus(t){this._region.setStatus(t)}createEle(t,e,i){var n=document.createElement(t);return n.id=e,n.className=i,n}getWidthAndHeightOfCancas(){var t=document.getElementById("gl-canvas"),e=window.getComputedStyle(t,null);this.screenwidth=parseInt(e.getPropertyValue("width")),this.screenheight=parseInt(e.getPropertyValue("height"))}createCanvas(t){this._mapRoot=this.createEle("div","mapRoot","indoorunMap_map"),t.appendChild(this._mapRoot),this._canvas_gl=this.createEle("canvas","gl-canvas","canvas-frame"),this._mapRoot.appendChild(this._canvas_gl),this._canvas_txt=this.createEle("canvas","txt-canvas","canvas-frame"),this._mapRoot.appendChild(this._canvas_txt),this.getWidthAndHeightOfCancas(),this._canvas_gl.width=this.screenwidth*this._csscale,this._canvas_gl.height=this.screenheight*this._csscale,this._canvas_txt.width=this.screenwidth*this._csscale,this._canvas_txt.height=this.screenheight*this._csscale}updateUnitsColor(t,e){t.forEach(t=>{this._region.addQuickPolygon(this._floor.floorIndex,t.getPts(),e)}),this._region.buildQuickPolygonFloor(this._floor.floorIndex)}clearUnitsColor(t){t.forEach(t=>{t.color=null}),this._region.cleanQuickPolygonFloor(this._floor.floorIndex)}clearFloorUnitsColor(t){if(t)for(var e=0;e<this._regionEx.floorList.length;++e)this._region.cleanQuickPolygonFloor(this._regionEx.floorList[e].floorIndex);else this._region.cleanQuickPolygonFloor(this._floor.floorIndex)}addUnits(t){if(!(this._floor.id in this._unitAddFloor)){this._unitAddFloor[this._floor.id]=!0;for(var e=0; e<t.length; ++e){var i=t[e],n={};let s=parseFloat(i.unitTypeId);if(0==s)n.text=i.fakeName?i.fakeName:i.name,n.pts=i.getPts(),n.unitId=i.id,n.unitType=i.unitTypeId,this._region.insertUnit(n,this._floor.floorIndex);else{var o=i.getPos();this._region.insertIcon({type:s,unitId:i.id,unitType:i.unitTypeId},this._floor.floorIndex,o.x,o.y)}}}}removeMarker(t){t&&this._region.removeMarker(t.id)}handleMapScroll(t, e){this._mapView._onMapScroll(t,e)}handleClick(t, e){var i=this._region.searchMarker(t,e),n=this._region.getTouchPosMapLoc(t,e);if(-1===i){var o=this._region.searchUnit(t,e);if(o.length>0){let t=this._mapView.findUnitWithId(o[0].obj.unitId);this._mapView._onUnitClick(t)}else{var s=this._region.searchIcon(t,e);if(s.length>0){let t=this._mapView.findUnitWithId(s[0].obj.unitId);this._mapView._onUnitClick(t)}else this._mapView._onMapClick({x:n.x,y:n.y,floorIndex:this._currentFloorIndex})}}else this._mapView._onMarkerClick(this._currentFloorIndex,i)}addMarker(t){this._region.addTexture(t.typename,t.image),t.id=this._region.insertTextureMarker(t.typename,t.position.floorIndex,t.position.x,t.position.y,0,0,80)}setPos(t){t&&t.floorIndex===this._currentFloorIndex?(this._region.setLocation(t.floorIndex,t.x,t.y),this._region.locateLaunch()):this._region.cleanLocation()}setUserDirection(t){this._region.setAzimuth(t)}resetMap(){this._region.overlookMap(this._currentFloorIndex),this._region.displayFloor(this._currentFloorIndex),this._region.animPitch(0)}set25dMap(){this._region.animPitch(70),this._region.displayRegion()}scroll(t){}zoom(t){var e=this._region.getLookDistance();if(!(e<100||e>4e3)){var i=e*t;i=Math.min(i,4e3),i=Math.max(100,i),this._region.animLookDistance(i)}}birdLook(){this._region.overlookRoute()}showRoutePath(t){t?this._region.setRoute(t.path):this._region.cleanRoute()}setRoutePath(t){this._region.setRoute(t)}getNaviStatus(){return this._region?this._region.getNaviStatus():null}getScreenPos(t){var e=this._regionEx.getFloorbyId(t.floorId).floorIndex,i=this._region.floorPos2RegionPos(e,t.x,t.y),n=this._region.regionPos2Screen(i);return{x:.3833333*n[0],y:.3833333*n[1]}}centerPos(t,e){e?this._region.animLookAt(t.floorIndex,t.x,t.y):this._region.lookAtMapLoc(t.floorIndex,t.x,t.y)}getMapScale(){return this._mapScale}getMapRotate(){return this._region.getFloorAngle(this._floor.floorIndex)}updateMarkerLocation(t,{x:e,y:i,floorIndex:n}){t.id=this._region.updateMarkerLocation(t.id,n,e,i),t.position={x:e,y:i,floorIndex:n}}setDynamicNavi(t){this._region&&this._region.setNavigateProj(t)}root(){return this._mapRoot}}class T{constructor(){this.eventTypes=P,this.regionEx=null,this.autoChangeFloor=!0,this._locator=E,this._router=null,this._container=null,this._currentPos=null,this._regionId=null,this._floor=null,this._currentFloorIndex=0,this._units=[],this._mapRoot=null,this._mapEvent=new function(){this.events={},this.oncesEvents={},this.checkEvent=function(t){return!!this.events.hasOwnProperty(t)&&null!==this.events[t]},this.removeEvent=function(t){return!!P.hasOwnProperty(t)&&(this.events[t]=null,!0)},this.fireEvent=function(t,e){if(!P.hasOwnProperty(t))return!1;var i=this.events[t];return i&&i(e),!0},this.addEvent=function(t,e){return!!P.hasOwnProperty(t)&&(this.events[t]=e,!0)},this.fireOnce=function(t,e){if(!P.hasOwnProperty(t))return!1;var i=this.oncesEvents[t];return!!i&&(i(e)&&(this.oncesEvents[t]=null),!0)},this.addOnce=function(t,e){this.oncesEvents[t]=e}},this._dynamicNavi=!1,this._inNavi=!1,this._markers={},this._idrMap=null,this._path=null,this._composs=null,this._naviParm=null,this._displayAnimId=null,this._naviStatusUpdateTimer=null,this.deviceAlphaDeg=0,this.deviceAlphaDegStart=!1,this.deviceAlphaTimer=null;var t=navigator.userAgent.toLowerCase();this.isAndroid="android"==t.match(/android/i)}onMapClick(t){this._mapEvent._fireEvent(this.eventTypes.onMapClick,t)}startUpdateDeviceOrientation(){this.isAndroid||this.deviceAlphaDegStart||(window.addEventListener("deviceorientation", t=>{"webkitCompassHeading"in event&&(this.deviceAlphaDeg=t.webkitCompassHeading)}),this.deviceAlphaDegStart=!0,this.deviceAlphaTimer=setInterval(()=>{this.setUserDirection(this.deviceAlphaDeg)},120))}doLocation(t, e){return this.startUpdateDeviceOrientation(),this._locator.mapInfo=this.regionEx,new Promise((i, n)=>{this._locator.start(this._regionId,this._currentFloorIndex).then(i=>{this._locator.setLocateDelegate(t,e)}).catch(t=>{n(t)})})}setStatus(t){this._idrMap.setStatus(t)}checkReachTargetFloor(){return!!this._inNavi&&(!!this._currentPos&&!(!this._naviParm||this._naviParm.end.floorIndex!=this._currentPos.floorIndex))}doRoute(t, e, i){if(this._inNavi=!1,t?this._dynamicNavi=!1:(this._dynamicNavi=!0,t=this._currentPos),!t)return!1;this._path=null;let n=void 0!==i&&i;return this._path=this._router.routerPath(t,e.position,n,e.junctions),!!this._path&&(this._naviParm={start:t,end:e,car:n,dynamic:this._dynamicNavi},this._inNavi=!0,this.showRoutePath(this._path),this._mapEvent._fireEvent(this.eventTypes.onRouterSuccess,{path:this._path,end:e,start:t}),this._dynamicNavi&&(this._naviStatusUpdateTimer=setInterval(()=>{this._mapEvent._fireEvent(this.eventTypes.onNaviStatusUpdate,this._idrMap.getNaviStatus())},1e3)),!0)}stopRoute(){this._path=null,this._naviParm=null,this._inNavi=!1,this._idrMap.showRoutePath(null),this._mapEvent._fireEvent(this.eventTypes.onRouterFinish,null),clearInterval(this._naviStatusUpdateTimer),this._naviStatusUpdateTimer=null,this.setStatus(YFM.Map.STATUS_TOUCH)}showRoutePath(t){this._idrMap.showRoutePath(t),this._idrMap.setDynamicNavi(this._dynamicNavi)}reRoute(){this._naviParm&&this._naviParm.dynamic&&(void 0===this._naviParm?this._path=this._router.routerPath(this._currentPos,this._naviParm.end,!1):this._path=this._router.routerPath(this._currentPos,this._naviParm.end,this._naviParm.car),this.showRoutePath(this._path))}onMapScroll(t, e){this._mapEvent.fireOnce(this.eventTypes.onMapScroll,{x:t,y:e})||this._mapEvent._fireEvent(this.eventTypes.onMapScroll,{x:t,y:e})}onMapLongPress(t){this._mapEvent.fireOnce(this.eventTypes.onMapLongPress,t)||this._mapEvent._fireEvent(this.eventTypes.onMapLongPress,t)}onUnitClick(t){this._mapEvent.fireOnce(this.eventTypes.onUnitClick,t)||this._mapEvent._fireEvent(this.eventTypes.onUnitClick,t)}updateUnitsColor(t, e){this._idrMap.updateUnitsColor(t,e)}clearUnitsColor(t){this._idrMap.clearUnitsColor(t)}clearFloorUnitsColor(t){this._idrMap.clearFloorUnitsColor(t)}_createMap(){this._idrMap?this._idrMap.changeToFloor(this._currentFloorIndex):(this._idrMap=new b(this),this._idrMap.init(this.regionEx,this._currentFloorIndex,this._container))}_updateDisplay(){this._displayAnimId=requestAnimationFrame(()=>{this._composs&&this._composs.rotateToDegree(this._idrMap.getMapRotate()),this._updateDisplay()})}_addComposs(){if(!this._composs){var t=document.createElement("div");t.setAttribute("id","composs"),this._container.appendChild(t),this._composs=new function(t,e,i){var n=document.getElementById(t),o=i,s=0,r=null;n.addEventListener("click",function(){var t=new Date;(!r||t.getTime()-r>2e3)&&(o.resetMap(),r=t.getTime())}),this.show=function(t){n.style.visibility=t?"visible":"hidden"},this.rotateToDegree=function(t){s=t-e,n.style.transform="rotate("+s+"deg)"}}("composs",this.regionEx.northDeflectionAngle,this)}}_loadMap(){this._createMap(this._regionId,this._currentFloorIndex)}changeFloor(t){this._currentFloorIndex=t,this._floor=this.regionEx.getFloorByIndex(t),this._loadMap()}initMap(t, e, i){this._container=document.getElementById(e),w.init(t).then(()=>s.serverCallRegionAllInfo(i)).then(({data:t})=>{this.regionEx=new y(t),this._regionId=i,this._mapEvent._fireEvent(this.eventTypes.onInitMapSuccess,this.regionEx)}).catch(t=>{console.log(t)})}addUnit(t){this._idrMap.addUnits(t)}onLoadMapSuccess(){this._addComposs(),this._mapRoot=this._idrMap.root(),this._idrMap.setPos(this._currentPos),this._idrMap.addUnits(this._floor.unitList),this._updateDisplay(),setTimeout(()=>{this._router?this._mapEvent._fireEvent(this.eventTypes.onFloorChangeSuccess,{floorIndex:this._currentFloorIndex,regionId:this._regionId}):s.serverCallRegionPathData(this._regionId).then(t=>{this.regionEx.regionPath=t.data,void 0!=t.data.version?this._router=new m(this.regionEx.floorList,this.regionEx.regionPath):this._router=new c(this.regionEx.floorList,this.regionEx.regionPath),this._mapEvent._fireEvent(this.eventTypes.onFloorChangeSuccess,{floorIndex:this._currentFloorIndex,regionId:this._regionId})}).catch(t=>{console.log(t)})},0)}addEventListener(t, e){return this._mapEvent.addEvent(t,e)}addOnceEvent(t, e){return this._mapEvent.addOnce(t,e)}removeEventListener(t){return this._mapEvent.removeEvent(t)}fireEvent(t, e){return this._mapEvent._fireEvent(t,e)}removeMarker(t){if(t){for(var e=[],i=0; i<this._markers[t.position.floorIndex].length; ++i){var n=this._markers[t.position.floorIndex][i];n.id!==t.id&&e.push(n)}this._markers[t.position.floorIndex]=e,this._idrMap.removeMarker(t)}}addMarker(t){return this._markers.hasOwnProperty(t.position.floorIndex)||(this._markers[t.position.floorIndex]=new Array),this._markers[t.position.floorIndex].push(t),this._idrMap.addMarker(t),t}_findMarker(t, e){if(!this._markers.hasOwnProperty(t))return null;for(var i=this._markers[t],n=0; n<i.length; ++n)if(e===i[n].id)return i[n];return null}onMarkerClick(t, e){var i=this._findMarker(t,e);this._mapEvent.fireOnce(this.eventTypes.onMarkerClick,i)||this._mapEvent._fireEvent(this.eventTypes.onMarkerClick,i)}getMapPos(t){return this._idrMap.getMapPos(t)}getScreenPos(t){return this._idrMap.getScreenPos(t)}zoom(t){this._idrMap.zoom(t)}scroll(t){this._idrMap.scroll(t)}rotate(t, e){this._idrMap.rotate(t,e)}centerPos(t, e){t&&(t.floorIndex!==this._currentFloorIndex&&this.changeFloor(t.floorIndex),this._idrMap.centerPos(t,e))}resetMap(){this._idrMap.resetMap()}birdLook(){this._idrMap.birdLook()}_setPos(t){this._idrMap.setPos(t)}_Positionfilter(t, e, i){if(null!=t){var n=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));n>i&&(e.x=(t.x*(n-i)+e.x*i)/n,e.y=(t.y*(n-i)+e.y*i)/n)}}getUserPos(){return this._currentPos}setUserPos({x:t,y:e,floorIndex:i}){let n={x:t,y:e,floorIndex:i};this._currentPos&&this._currentPos.floorIndex===i&&this._Positionfilter(this._currentPos,n,40),this._currentPos=n,i!==this._currentFloorIndex&&this.autoChangeFloor?this.changeFloor(i):this._setPos(this._currentPos)}updateMarkerLocation(t,e){return this.removeMarker(t),t.position=e,this.addMarker(t),t}findUnitWithId(t){for(var e=0;e<this.regionEx.floorList.length;++e)for(var i=this.regionEx.floorList[e],n=0;n<i.unitList.length;++n){var o=i.unitList[n];if(o.id===t)return o}return null}findUnitWithName(t,e){for(var i=this.regionEx.getFloorbyId(t),n=null,o=e.toLowerCase(),s=0;s<i.unitList.length;++s){var r=i.unitList[s];o==r.name.toLowerCase()&&(n||(n=[]),n.push(r))}return n}findNearUnit(t,e){return this.regionEx.getNearUnit(t,e)}getNearUnit(t){var e=this.regionEx.getFloorByIndex(t.floorIndex);return this.regionEx.getNearUnit(t,e.unitList)}findUnitsWithType(t){for(var e={},i=0;i<this.regionEx.floorList.length;++i)for(var n=this.regionEx.floorList[i],o=0;o<n.unitList.length;++o)for(var s=n.unitList[o],r=0;r<t.length;++r)s.unitTypeId==t[r]&&(s.unitTypeId in e?e[s.unitTypeId].push(s):e[s.unitTypeId]=[s]);return e}getRegionId(){return this._regionId}isDynamicNavi(){return this._dynamicNavi}isInNavi(){return this._inNavi}set2DMap(t){this._idrMap.set2DMap(t)}release(){this._idrMap.release()}setUserDirection(t){this._currentPos&&this._idrMap.setUserDirection(t)}getFloorId(){return this._floor?this._floor.id:null}}class C{constructor({pos:t,exinfo:e,callback:i},n){this.position=t,this.exinfo=e,this.clickfn=i,this.image=n,this.typename=n||"idrMarker"}}i.d(e,"idrMapView",function(){return T}),i.d(e,"idrMapInfo",function(){return y}),i.d(e,"idrUnit",function(){return I}),i.d(e,"idrNetworkInstance",function(){return s}),i.d(e,"idrCoreMgr",function(){return w}),i.d(e,"idrMarker",function(){return C}),i.d(e,"idrDebug",function(){return M}),i.d(e,"idrWxManagerIntance",function(){return S}),i.d(e,"idrMapEventTypes",function(){return P}),i.d(e,"idrLocateServerInstance",function(){return E}),window.idrMap={idrMapView:T,idrRegionEx:y,idrUnit:I,idrNetworkInstance:s,idrCoreMgr:w,idrMarker:C,idrDebug:M,idrWxManagerIntance:S,idrMapEventTypes:P,idrLocateServerInstance:E}}]);